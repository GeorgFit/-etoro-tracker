<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eToro Copy Trader Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/4.4.0/chart.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBVE6eRSapt2fwVnLoQm2EfcScksg0OWiU",
            authDomain: "etoro-tracker.firebaseapp.com",
            projectId: "etoro-tracker",
            storageBucket: "etoro-tracker.firebasestorage.app",
            messagingSenderId: "941552714377",
            appId: "1:941552714377:web:8c44519dc1352aea7bbc58"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.firebaseDb = db;
        window.firebaseUtils = { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc };
        window.SECURITY_KEY = "my-secret-etoro-key-2024";
        window.firebaseReady = true;
    </script>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        function FirebaseStatus({ status }) {
            const colors = {
                connected: 'bg-green-500',
                readonly: 'bg-yellow-500',
                disconnected: 'bg-red-500',
                checking: 'bg-gray-500'
            };
            const labels = {
                connected: 'Connected & Writable',
                readonly: 'Connected (Read Only)',
                disconnected: 'Disconnected',
                checking: 'Checking...'
            };
            return (
                <div className="flex items-center gap-2 bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
                    <div className={`w-3 h-3 rounded-full ${colors[status]} ${status === 'connected' ? 'animate-pulse' : ''}`}></div>
                    <span className="text-sm">{labels[status]}</span>
                </div>
            );
        }

        function FilterControl({ column, label, type, filters, updateFilter, options }) {
            const filter = filters[column] || { enabled: false, type, min: '', max: '', value: '' };
            return (
                <div className="bg-slate-700 rounded-lg p-3">
                    <div className="flex items-center gap-2 mb-2">
                        <input type="checkbox" checked={filter.enabled}
                            onChange={(e) => updateFilter(column, { ...filter, enabled: e.target.checked })}
                            className="w-4 h-4" />
                        <label className="text-sm font-semibold">{label}</label>
                    </div>
                    {type === 'range' && (
                        <div className="flex gap-2">
                            <input type="number" placeholder="Min" value={filter.min || ''}
                                onChange={(e) => updateFilter(column, { ...filter, min: e.target.value, type: 'range', enabled: true })}
                                className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm" />
                            <input type="number" placeholder="Max" value={filter.max || ''}
                                onChange={(e) => updateFilter(column, { ...filter, max: e.target.value, type: 'range', enabled: true })}
                                className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm" />
                        </div>
                    )}
                    {type === 'text' && (
                        <input type="text" placeholder={`Search...`} value={filter.value || ''}
                            onChange={(e) => updateFilter(column, { ...filter, value: e.target.value, type: 'text', enabled: true })}
                            className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm" />
                    )}
                    {type === 'select' && options && (
                        <select value={filter.value || ''} 
                            onChange={(e) => updateFilter(column, { ...filter, value: e.target.value, type: 'select', enabled: true })}
                            className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm">
                            <option value="">All</option>
                            {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                    )}
                </div>
            );
        }

        function SortableHeader({ column, label, sortColumn, sortDirection, handleSort, align = 'left' }) {
            return (
                <th className={`text-${align} py-3 px-2 font-semibold cursor-pointer hover:bg-slate-700`}
                    onClick={() => handleSort(column)}>
                    <div className={`flex items-center gap-1 ${align === 'right' ? 'justify-end' : ''}`}>
                        {label}
                        {sortColumn === column && <span className="text-blue-400">{sortDirection === 'asc' ? '▲' : '▼'}</span>}
                    </div>
                </th>
            );
        }

        function TimelineView({ transactions, snapshots, snapshotsWithCalcs, parseDate: parseDateProp }) {
            const [selectedTrader, setSelectedTrader] = useState('');
            const [selectedAccount, setSelectedAccount] = useState('All');
            const [dateRange, setDateRange] = useState('30');
            const [customFrom, setCustomFrom] = useState('');
            const [customTo, setCustomTo] = useState('');
            const [chartReady, setChartReady] = useState(false);
            
            const chartRefs = {
                plPercent: useRef(null),
                equity: useRef(null),
                drawdown: useRef(null),
                dailyPL: useRef(null)
            };
            const chartInstances = useRef({});

            const parseDate = parseDateProp;

            // Check if Chart.js is loaded
            useEffect(() => {
                if (typeof Chart !== 'undefined') {
                    setChartReady(true);
                } else {
                    const checkInterval = setInterval(() => {
                        if (typeof Chart !== 'undefined') {
                            setChartReady(true);
                            clearInterval(checkInterval);
                        }
                    }, 100);
                    return () => clearInterval(checkInterval);
                }
            }, []);

            const traderList = useMemo(() => {
                const pairs = new Set();
                snapshotsWithCalcs.forEach(s => pairs.add(`${s.trader}|${s.account}`));
                return Array.from(pairs).map(p => {
                    const [trader, account] = p.split('|');
                    return { trader, account };
                }).sort((a, b) => a.trader.localeCompare(b.trader));
            }, [snapshotsWithCalcs]);

            const getDateRange = () => {
                const now = new Date();
                if (dateRange === 'custom') {
                    return { 
                        from: customFrom ? parseDate(customFrom) : new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000),
                        to: customTo ? parseDate(customTo) : now
                    };
                }
                const days = parseInt(dateRange);
                return { 
                    from: new Date(now.getTime() - days * 24 * 60 * 60 * 1000), 
                    to: now 
                };
            };

            const timelineData = useMemo(() => {
                if (!selectedTrader) return null;
                
                const range = getDateRange();
                const filtered = snapshotsWithCalcs.filter(s => {
                    if (s.trader !== selectedTrader) return false;
                    if (selectedAccount !== 'All' && s.account !== selectedAccount) return false;
                    const d = parseDate(s.date);
                    return d >= range.from && d <= range.to;
                }).sort((a, b) => parseDate(a.date) - parseDate(b.date));

                if (!filtered.length) return null;

                // Aggregation
                const days = parseInt(dateRange === 'custom' ? 
                    Math.ceil((range.to - range.from) / (24 * 60 * 60 * 1000)) : dateRange);
                const aggSize = days <= 30 ? 1 : days <= 90 ? 3 : 7;
                
                let aggregated = [];
                if (aggSize === 1) {
                    aggregated = filtered;
                } else {
                    for (let i = 0; i < filtered.length; i += aggSize) {
                        const chunk = filtered.slice(i, i + aggSize);
                        const avg = {
                            date: chunk[chunk.length - 1].date,
                            equity: chunk.reduce((s, x) => s + x.equity, 0) / chunk.length,
                            currentDrawdown: chunk.reduce((s, x) => s + (x.currentDrawdown || 0), 0) / chunk.length,
                            plPerDay: chunk.reduce((s, x) => s + (x.plPerDay || 0), 0) / chunk.length
                        };
                        aggregated.push(avg);
                    }
                }

                // Calculate metrics
                const txs = transactions.filter(t => {
                    if (t.trader !== selectedTrader) return false;
                    if (selectedAccount !== 'All' && t.account !== selectedAccount) return false;
                    const d = parseDate(t.date);
                    return d >= range.from && d <= range.to;
                });

                const netInv = txs.reduce((sum, t) => 
                    sum + (t.type === 'DEPOSIT' ? t.amount : t.type === 'WITHDRAWAL' ? -t.amount : 0), 0);
                
                const startEquity = filtered[0]?.equity || 0;
                const endEquity = filtered[filtered.length - 1]?.equity || 0;
                const pl = endEquity - startEquity;
                const plPct = startEquity > 0 ? (pl / startEquity) * 100 : 0;
                const maxDD = Math.max(...filtered.map(s => s.currentDrawdown || 0));
                const avgDailyPL = filtered.length > 1 ? pl / filtered.length : 0;

                return {
                    data: aggregated,
                    metrics: {
                        startEquity,
                        endEquity,
                        pl,
                        plPct,
                        maxDD,
                        avgDailyPL,
                        netInv,
                        days: filtered.length
                    }
                };
            }, [selectedTrader, selectedAccount, dateRange, customFrom, customTo, snapshotsWithCalcs, transactions]);

            useEffect(() => {
                if (!timelineData || !timelineData.data.length || !chartReady) return;

                // Destroy old charts
                Object.values(chartInstances.current).forEach(chart => chart?.destroy());
                chartInstances.current = {};

                const data = timelineData.data;
                const labels = data.map(d => d.date);

                // P/L% Chart
                if (chartRefs.plPercent.current) {
                    const ctx = chartRefs.plPercent.current.getContext('2d');
                    const netInv = timelineData.metrics.netInv || timelineData.metrics.startEquity;
                    chartInstances.current.plPercent = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                label: 'P/L %',
                                data: data.map(d => netInv > 0 ? ((d.equity - netInv) / netInv) * 100 : 0),
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { labels: { color: '#fff' } } },
                            scales: {
                                x: { ticks: { color: '#94a3b8' } },
                                y: { ticks: { color: '#94a3b8' } }
                            }
                        }
                    });
                }

                // Equity Chart
                if (chartRefs.equity.current) {
                    const ctx = chartRefs.equity.current.getContext('2d');
                    chartInstances.current.equity = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Equity',
                                data: data.map(d => d.equity),
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { labels: { color: '#fff' } } },
                            scales: {
                                x: { ticks: { color: '#94a3b8' } },
                                y: { ticks: { color: '#94a3b8' } }
                            }
                        }
                    });
                }

                // Drawdown Chart
                if (chartRefs.drawdown.current) {
                    const ctx = chartRefs.drawdown.current.getContext('2d');
                    chartInstances.current.drawdown = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Drawdown %',
                                data: data.map(d => d.currentDrawdown || 0),
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { labels: { color: '#fff' } } },
                            scales: {
                                x: { ticks: { color: '#94a3b8' } },
                                y: { 
                                    ticks: { color: '#94a3b8' },
                                    reverse: false
                                }
                            }
                        }
                    });
                }

                // Daily P/L Chart
                if (chartRefs.dailyPL.current) {
                    const ctx = chartRefs.dailyPL.current.getContext('2d');
                    chartInstances.current.dailyPL = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Daily P/L',
                                data: data.map(d => d.plPerDay || 0),
                                backgroundColor: data.map(d => 
                                    (d.plPerDay || 0) >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'
                                )
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { labels: { color: '#fff' } } },
                            scales: {
                                x: { ticks: { color: '#94a3b8' } },
                                y: { ticks: { color: '#94a3b8' } }
                            }
                        }
                    });
                }

                return () => {
                    Object.values(chartInstances.current).forEach(chart => chart?.destroy());
                };
            }, [timelineData, chartReady]);

            return (
                <div className="space-y-6">
                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                        <h3 className="text-lg font-semibold mb-4">Select Trader & Period</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label className="text-sm text-slate-400 mb-1 block">Trader</label>
                                <select value={selectedTrader} onChange={(e) => setSelectedTrader(e.target.value)}
                                    className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                    <option value="">Select Trader</option>
                                    {traderList.map(t => (
                                        <option key={`${t.trader}-${t.account}`} value={t.trader}>
                                            {t.trader} ({t.account})
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="text-sm text-slate-400 mb-1 block">Account</label>
                                <select value={selectedAccount} onChange={(e) => setSelectedAccount(e.target.value)}
                                    className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                    <option value="All">All</option>
                                    <option value="Virtual">Virtual</option>
                                    <option value="Real">Real</option>
                                </select>
                            </div>
                            <div>
                                <label className="text-sm text-slate-400 mb-1 block">Period</label>
                                <div className="flex gap-2">
                                    <button onClick={() => setDateRange('30')} 
                                        className={`px-3 py-2 rounded-lg text-sm font-semibold ${dateRange === '30' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                        30d
                                    </button>
                                    <button onClick={() => setDateRange('90')} 
                                        className={`px-3 py-2 rounded-lg text-sm font-semibold ${dateRange === '90' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                        90d
                                    </button>
                                    <button onClick={() => setDateRange('365')} 
                                        className={`px-3 py-2 rounded-lg text-sm font-semibold ${dateRange === '365' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                        365d
                                    </button>
                                    <button onClick={() => setDateRange('custom')} 
                                        className={`px-3 py-2 rounded-lg text-sm font-semibold ${dateRange === 'custom' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                        Custom
                                    </button>
                                </div>
                            </div>
                        </div>
                        {dateRange === 'custom' && (
                            <div className="grid grid-cols-2 gap-4 mt-4">
                                <input type="text" placeholder="From (YYYY.MM.DD)" value={customFrom}
                                    onChange={(e) => setCustomFrom(e.target.value)}
                                    className="bg-slate-700 rounded-lg px-4 py-2" />
                                <input type="text" placeholder="To (YYYY.MM.DD)" value={customTo}
                                    onChange={(e) => setCustomTo(e.target.value)}
                                    className="bg-slate-700 rounded-lg px-4 py-2" />
                            </div>
                        )}
                    </div>

                    {timelineData && (
                        <>
                            <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                <h3 className="text-lg font-semibold mb-4">Period Summary</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <div className="text-slate-400 text-xs">Start Equity</div>
                                        <div className="text-xl font-bold">{timelineData.metrics.startEquity.toFixed(0)} Ft</div>
                                    </div>
                                    <div>
                                        <div className="text-slate-400 text-xs">End Equity</div>
                                        <div className="text-xl font-bold">{timelineData.metrics.endEquity.toFixed(0)} Ft</div>
                                    </div>
                                    <div>
                                        <div className="text-slate-400 text-xs">P/L</div>
                                        <div className={`text-xl font-bold ${timelineData.metrics.pl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {timelineData.metrics.pl.toFixed(0)} Ft ({timelineData.metrics.plPct.toFixed(2)}%)
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-slate-400 text-xs">Max DD</div>
                                        <div className="text-xl font-bold text-orange-400">{timelineData.metrics.maxDD.toFixed(2)}%</div>
                                    </div>
                                    <div>
                                        <div className="text-slate-400 text-xs">Avg Daily P/L</div>
                                        <div className={`text-xl font-bold ${timelineData.metrics.avgDailyPL >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {timelineData.metrics.avgDailyPL.toFixed(0)} Ft
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-slate-400 text-xs">Data Points</div>
                                        <div className="text-xl font-bold text-blue-400">{timelineData.metrics.days}</div>
                                    </div>
                                </div>
                            </div>

                            {!chartReady ? (
                                <div className="bg-slate-800 rounded-xl p-12 border border-slate-700 text-center">
                                    <p className="text-slate-400 text-lg">Loading charts...</p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                    <h4 className="text-sm font-semibold mb-3">P/L %</h4>
                                    <div style={{ height: '300px' }}>
                                        <canvas ref={chartRefs.plPercent}></canvas>
                                    </div>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                    <h4 className="text-sm font-semibold mb-3">Equity</h4>
                                    <div style={{ height: '300px' }}>
                                        <canvas ref={chartRefs.equity}></canvas>
                                    </div>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                    <h4 className="text-sm font-semibold mb-3">Drawdown %</h4>
                                    <div style={{ height: '300px' }}>
                                        <canvas ref={chartRefs.drawdown}></canvas>
                                    </div>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                    <h4 className="text-sm font-semibold mb-3">Daily P/L</h4>
                                    <div style={{ height: '300px' }}>
                                        <canvas ref={chartRefs.dailyPL}></canvas>
                                    </div>
                                </div>
                            </div>
                        </>
                    )}

                    {!selectedTrader && (
                        <div className="bg-slate-800 rounded-xl p-12 border border-slate-700 text-center">
                            <p className="text-slate-400 text-lg">Select a trader to view timeline</p>
                        </div>
                    )}
                </div>
            );
        }

        function EtoroTracker() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [accountFilter, setAccountFilter] = useState('All');
            const [showAddData, setShowAddData] = useState(false);
            const [transactions, setTransactions] = useState([]);
            const [snapshots, setSnapshots] = useState([]);
            const [sortColumn, setSortColumn] = useState('trader');
            const [sortDirection, setSortDirection] = useState('asc');
            const [showFilters, setShowFilters] = useState(false);
            const [filters, setFilters] = useState({});
            const [savedFilters, setSavedFilters] = useState([]);
            const [filterName, setFilterName] = useState('');
            const [firebaseStatus, setFirebaseStatus] = useState('checking');
            const [newData, setNewData] = useState({
                dataType: 'snapshot',
                date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                trader: '', account: 'Virtual', equity: '', amount: '', transactionType: 'DEPOSIT', note: ''
            });

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.firebaseReady) {
                        setTimeout(initFirebase, 100);
                        return;
                    }
                    const { collection, onSnapshot, query, orderBy } = window.firebaseUtils;
                    const db = window.firebaseDb;
                    
                    onSnapshot(query(collection(db, 'transactions'), orderBy('date', 'desc')), (snapshot) => {
                        setTransactions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setFirebaseStatus('connected');
                    }, (error) => {
                        console.error('Firebase error:', error);
                        setFirebaseStatus('disconnected');
                    });
                    
                    onSnapshot(query(collection(db, 'snapshots'), orderBy('date', 'desc')), (snapshot) => {
                        setSnapshots(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });

                    onSnapshot(query(collection(db, 'filter_views')), (snapshot) => {
                        setSavedFilters(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                };
                initFirebase();

                const healthCheck = setInterval(async () => {
                    try {
                        if (!window.firebaseReady) {
                            setFirebaseStatus('disconnected');
                            return;
                        }
                        const { collection, addDoc } = window.firebaseUtils;
                        const db = window.firebaseDb;
                        await addDoc(collection(db, '_healthcheck'), {
                            timestamp: new Date().toISOString(),
                            securityKey: window.SECURITY_KEY
                        });
                        setFirebaseStatus('connected');
                    } catch (error) {
                        console.error('Health check failed:', error);
                        setFirebaseStatus(error.code === 'permission-denied' ? 'readonly' : 'disconnected');
                    }
                }, 30000);

                return () => clearInterval(healthCheck);
            }, []);

            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                const parts = dateStr.split('.');
                if (parts.length === 3) return new Date(parts[0], parts[1] - 1, parts[2]);
                return new Date(dateStr);
            };

            const daysBetween = (d1, d2) => {
                const date1 = parseDate(d1), date2 = parseDate(d2);
                return date1 && date2 ? Math.floor((date1 - date2) / (1000 * 60 * 60 * 24)) : 0;
            };

            const weightedAverage = (snaps, days = 14) => {
                if (!snaps.length) return 0;
                const sorted = [...snaps].sort((a, b) => parseDate(b.date) - parseDate(a.date));
                const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
                const recent = sorted.filter(s => parseDate(s.date) >= cutoff && s.plPerDay !== 0);
                if (!recent.length) return 0;
                let sum = 0, totalW = 0;
                for (let i = 0; i < Math.min(recent.length, days); i++) {
                    const w = Math.exp(-i / 5);
                    sum += recent[i].plPerDay * w;
                    totalW += w;
                }
                return totalW > 0 ? sum / totalW : 0;
            };

            const getTradeDecision = (row) => {
                if (row.daysSinceStart < 30 || !row.estDailyPL) return 'NO_DATA';
                if (row.recoveryFactor < 1.5 && row.maxDrawdown > 25) return 'SELL';
                if (row.estDailyPL < 0 && row.currentDailyPL3pt !== null && row.currentDailyPL3pt < 0) return 'SELL';
                if (row.currentDrawdown > 25) return 'SELL';
                if (row.plPercent < -10) return 'SELL';
                if (
                    row.estDailyPL >= 900 &&
                    row.plPercent >= 14 &&
                    row.recoveryFactor >= 2.5 &&
                    row.currentDrawdown < 15 &&
                    row.maxDrawdown < 25
                ) return 'BUY';
                return 'HOLD';
            };

            const snapshotsWithCalcs = useMemo(() => {
                const sorted = [...snapshots].sort((a, b) => `${b.trader}-${b.account}-${b.date}`.localeCompare(`${a.trader}-${a.account}-${a.date}`));
                const byKey = {};
                sorted.forEach(s => {
                    const k = `${s.trader}-${s.account}`;
                    if (!byKey[k]) byKey[k] = [];
                    byKey[k].push(s);
                });
                Object.values(byKey).forEach(snaps => {
                    snaps.sort((a, b) => parseDate(a.date) - parseDate(b.date));
                    let maxEq = 0;
                    snaps.forEach(s => {
                        maxEq = Math.max(maxEq, s.equity);
                        s.runningMaxEquity = maxEq;
                        s.currentDrawdown = maxEq > 0 ? ((maxEq - s.equity) / maxEq) * 100 : 0;
                    });
                });
                return sorted.map((snap, i) => {
                    const prev = sorted.slice(i + 1).find(s => s.trader === snap.trader && s.account === snap.account);
                    const flow = transactions.filter(t => t.trader === snap.trader && t.account === snap.account &&
                        (!prev || parseDate(t.date) > parseDate(prev.date)) && parseDate(t.date) <= parseDate(snap.date)
                    ).reduce((sum, t) => sum + (t.type === 'DEPOSIT' ? t.amount : t.type === 'WITHDRAWAL' ? -t.amount : 0), 0);
                    const pnl = snap.equity - (prev ? prev.equity : 0) - flow;
                    const days = prev ? daysBetween(snap.date, prev.date) : 0;
                    return { ...snap, prevDate: prev?.date || '', flowSinceLast: flow, prevEquity: prev?.equity || 0, pnlPeriod: pnl, daysSincePrev: days, plPerDay: days > 0 ? pnl / days : 0 };
                });
            }, [snapshots, transactions]);

            const getWarnings = (row) => {
                const warnings = [];
                if (row.currentDrawdown > 20) warnings.push('High DD');
                if (row.estDailyPL < 0) warnings.push('Declining');
                if (row.daysSinceStart < 30) warnings.push('Low Data');
                return warnings;
            };

            const dashboardData = useMemo(() => {
                const pairs = new Map();
                snapshotsWithCalcs.forEach(s => {
                    const k = `${s.trader}-${s.account}`;
                    if (!pairs.has(k) || parseDate(s.date) > parseDate(pairs.get(k).date)) pairs.set(k, s);
                });
                let data = Array.from(pairs.values()).map(s => {
                    const txs = transactions.filter(t => t.trader === s.trader && t.account === s.account);
                    const netInv = txs.reduce((sum, t) => sum + (t.type === 'DEPOSIT' ? t.amount : t.type === 'WITHDRAWAL' ? -t.amount : 0), 0);
                    const pl = s.equity - netInv;
                    const plPct = netInv > 0 ? (pl / netInv) * 100 : 0;
                    const firstDate = txs.length ? txs.reduce((e, t) => parseDate(t.date) < parseDate(e.date) ? t : e).date : s.date;
                    const days = daysBetween(new Date().toISOString().split('T')[0].replace(/-/g, '.'), firstDate) + 1;
                    const tSnaps = snapshotsWithCalcs.filter(x => x.trader === s.trader && x.account === s.account).sort((a, b) => parseDate(b.date) - parseDate(a.date));
                    const last3 = tSnaps.slice(0, 3).filter(x => x.plPerDay !== 0);
                    const dds = tSnaps.map(x => x.currentDrawdown || 0).filter(d => d > 0);
                    const row = {
                        trader: s.trader, account: s.account, latestDate: s.date, equity: s.equity, netInvested: netInv, pl, plPercent: plPct,
                        currentDailyPL3pt: last3.length ? last3.reduce((sum, x) => sum + x.plPerDay, 0) / last3.length : null,
                        currentDailyPL3ptDays: last3.length, dailyPLSinceStart: days > 0 ? pl / days : 0,
                        estDailyPL: weightedAverage(tSnaps), dailyPlPercentSinceStart: days > 0 ? plPct / days : 0, daysSinceStart: days,
                        currentDrawdown: s.currentDrawdown || 0, maxDrawdown: dds.length ? Math.max(...dds) : 0,
                        avgDrawdown: dds.length ? dds.reduce((a, b) => a + b, 0) / dds.length : 0,
                        recoveryFactor: dds.length && Math.max(...dds) > 0 ? plPct / Math.max(...dds) : 0
                    };
                    row.warnings = getWarnings(row);
                    row.decision = getTradeDecision(row);
                    return row;
                });
                data = accountFilter === 'All' ? data : data.filter(d => d.account === accountFilter);
                Object.keys(filters).forEach(col => {
                    const f = filters[col];
                    if (f?.enabled) {
                        data = data.filter(row => {
                            if (f.type === 'range') {
                                const min = f.min !== '' ? parseFloat(f.min) : -Infinity;
                                const max = f.max !== '' ? parseFloat(f.max) : Infinity;
                                return row[col] >= min && row[col] <= max;
                            }
                            if (f.type === 'text') return row[col].toLowerCase().includes(f.value.toLowerCase());
                            if (f.type === 'select') {
                                if (col === 'decision') return row.decision === f.value;
                                if (col === 'warnings') return f.value === 'Has Warning' ? row.warnings.length > 0 : row.warnings.length === 0;
                            }
                            return true;
                        });
                    }
                });
                data.sort((a, b) => {
                    let av = a[sortColumn], bv = b[sortColumn];
                    if (sortColumn === 'warnings') {
                        av = a.warnings.length;
                        bv = b.warnings.length;
                    }
                    if (typeof av === 'string') return sortDirection === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
                    if (av === null) av = -Infinity;
                    if (bv === null) bv = -Infinity;
                    return sortDirection === 'asc' ? av - bv : bv - av;
                });
                return data;
            }, [snapshotsWithCalcs, transactions, accountFilter, filters, sortColumn, sortDirection]);

            const totals = useMemo(() => ({
                pl: dashboardData.reduce((s, d) => s + d.pl, 0),
                dailyPLSinceStart: dashboardData.reduce((s, d) => s + d.dailyPLSinceStart, 0),
                estDailyPL: dashboardData.reduce((s, d) => s + d.estDailyPL, 0)
            }), [dashboardData]);

            const traderNames = useMemo(() => [...new Set(transactions.map(t => t.trader))].sort(), [transactions]);

            const handleSort = (col) => {
                if (sortColumn === col) setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                else { setSortColumn(col); setSortDirection('asc'); }
            };

            const updateFilter = (col, data) => setFilters(prev => ({ ...prev, [col]: data }));
            const clearFilters = () => setFilters({});
            
            const saveFilterView = async () => {
                if (!filterName.trim()) return alert('Enter filter name');
                try {
                    const { collection, addDoc } = window.firebaseUtils;
                    const db = window.firebaseDb;
                    await addDoc(collection(db, 'filter_views'), {
                        name: filterName,
                        filters,
                        timestamp: new Date().toISOString(),
                        securityKey: window.SECURITY_KEY
                    });
                    setFilterName('');
                    alert(`Filter "${filterName}" saved!`);
                } catch (e) {
                    alert('Save failed: ' + e.message);
                }
            };

            const loadFilterView = (v) => setFilters(v.filters);
            
            const deleteFilterView = async (id, name) => {
                if (!confirm(`Delete "${name}"?`)) return;
                try {
                    const { deleteDoc, doc } = window.firebaseUtils;
                    await deleteDoc(doc(window.firebaseDb, 'filter_views', id));
                } catch (e) {
                    alert('Delete failed: ' + e.message);
                }
            };

            const deleteTransaction = async (id, trader, date) => {
                if (!confirm(`Delete transaction for ${trader} on ${date}?`)) return;
                try {
                    const { deleteDoc, doc } = window.firebaseUtils;
                    await deleteDoc(doc(window.firebaseDb, 'transactions', id));
                } catch (e) {
                    alert('Delete failed: ' + e.message);
                }
            };

            const deleteSnapshot = async (id, trader, date) => {
                if (!confirm(`Delete snapshot for ${trader} on ${date}?`)) return;
                try {
                    const { deleteDoc, doc } = window.firebaseUtils;
                    await deleteDoc(doc(window.firebaseDb, 'snapshots', id));
                } catch (e) {
                    alert('Delete failed: ' + e.message);
                }
            };

            const getDecisionStyle = (decision) => {
                switch(decision) {
                    case 'BUY': return { bg: 'bg-green-600', text: '▲ BUY' };
                    case 'SELL': return { bg: 'bg-red-600', text: '▼ SELL' };
                    case 'HOLD': return { bg: 'bg-yellow-600', text: '● HOLD' };
                    default: return { bg: 'bg-slate-600', text: '- N/A' };
                }
            };

            const addData = async () => {
                try {
                    const { collection, addDoc } = window.firebaseUtils;
                    const db = window.firebaseDb;
                    if (newData.dataType === 'snapshot' && newData.trader && newData.equity) {
                        await addDoc(collection(db, 'snapshots'), {
                            date: newData.date, trader: newData.trader, account: newData.account,
                            equity: parseFloat(newData.equity), securityKey: window.SECURITY_KEY, timestamp: new Date().toISOString()
                        });
                    } else if (newData.trader && newData.amount) {
                        await addDoc(collection(db, 'transactions'), {
                            date: newData.date, trader: newData.trader, account: newData.account,
                            amount: parseFloat(newData.amount), type: newData.transactionType,
                            note: newData.note, securityKey: window.SECURITY_KEY, timestamp: new Date().toISOString()
                        });
                    }
                    setNewData({ dataType: 'snapshot', date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                        trader: '', account: 'Virtual', equity: '', amount: '', transactionType: 'DEPOSIT', note: '' });
                    setShowAddData(false);
                } catch (e) { alert('Failed!'); }
            };

            const getHeatmap = (v, vals) => {
                if (!vals.length) return 'bg-slate-600';
                const valid = vals.filter(x => !isNaN(x) && isFinite(x));
                if (!valid.length) return 'bg-slate-600';
                const min = Math.min(...valid), max = Math.max(...valid);
                if (min === max) return v >= 0 ? 'bg-green-500' : 'bg-red-500';
                const norm = (v - min) / (max - min);
                const cols = ['bg-red-900', 'bg-red-800', 'bg-red-700', 'bg-red-600', 'bg-red-500', 'bg-green-500', 'bg-green-600', 'bg-green-700', 'bg-green-800', 'bg-green-900'];
                return cols[Math.max(0, Math.min(cols.length - 1, Math.floor(norm * (cols.length - 1))))];
            };

            const getDD = (v, vals) => {
                if (!vals.length) return 'bg-slate-600';
                const valid = vals.filter(x => !isNaN(x) && isFinite(x));
                if (!valid.length) return 'bg-slate-600';
                const min = Math.min(...valid), max = Math.max(...valid);
                if (min === max) return v <= 5 ? 'bg-green-500' : 'bg-red-500';
                const norm = 1 - ((v - min) / (max - min));
                const cols = ['bg-red-900', 'bg-red-800', 'bg-red-700', 'bg-red-600', 'bg-red-500', 'bg-green-500', 'bg-green-600', 'bg-green-700', 'bg-green-800', 'bg-green-900'];
                return cols[Math.max(0, Math.min(cols.length - 1, Math.floor(norm * (cols.length - 1))))];
            };

            const getBorder = (d) => d === 3 ? 'border-l-green-500' : d === 2 ? 'border-l-yellow-500' : d === 1 ? 'border-l-orange-500' : '';

            const vals = { pl: dashboardData.map(d => d.pl), plPct: dashboardData.map(d => d.plPercent),
                daily: dashboardData.map(d => d.currentDailyPL3pt).filter(v => v !== null),
                dailyStart: dashboardData.map(d => d.dailyPLSinceStart), est: dashboardData.map(d => d.estDailyPL),
                dailyPct: dashboardData.map(d => d.dailyPlPercentSinceStart), curr: dashboardData.map(d => d.currentDrawdown),
                max: dashboardData.map(d => d.maxDrawdown), avg: dashboardData.map(d => d.avgDrawdown),
                rec: dashboardData.map(d => d.recoveryFactor) };

            const exportXLSX = (type) => {
                const wb = XLSX.utils.book_new();
                if (type === 'all' || type === 'transactions') {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(transactions.map(t => ({
                        Date: t.date, Trader: t.trader, Account: t.account, Amount: t.amount, Type: t.type, Note: t.note
                    }))), 'Transactions');
                }
                if (type === 'all' || type === 'snapshots') {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(snapshotsWithCalcs.map(s => ({
                        Date: s.date, Trader: s.trader, Account: s.account, Equity: s.equity, Max: s.runningMaxEquity,
                        DD: s.currentDrawdown, PrevDate: s.prevDate, Flow: s.flowSinceLast, PrevEq: s.prevEquity,
                        PnL: s.pnlPeriod, Days: s.daysSincePrev, PLperDay: s.plPerDay
                    }))), 'Snapshots');
                }
                if (type === 'all' || type === 'dashboard') {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dashboardData.map(d => ({
                        Trader: d.trader, Account: d.account, Date: d.latestDate, Equity: d.equity, NetInv: d.netInvested,
                        PL: d.pl, PLPct: d.plPercent, RecentPL: d.currentDailyPL3pt,
                        Days: d.currentDailyPL3ptDays, DailyStart: d.dailyPLSinceStart, Smart: d.estDailyPL,
                        DailyPct: d.dailyPlPercentSinceStart, CurrDD: d.currentDrawdown, MaxDD: d.maxDrawdown, 
                        AvgDD: d.avgDrawdown, RecFac: d.recoveryFactor, Warnings: d.warnings.join(', '), Decision: d.decision
                    }))), 'Dashboard');
                }
                XLSX.writeFile(wb, `etoro_${type}_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-6">
                    <div className="max-w-full mx-auto">
                        <div className="mb-8">
                            <div className="flex justify-between items-center mb-2">
                                <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
                                    eToro Copy Trader Dashboard
                                </h1>
                                <FirebaseStatus status={firebaseStatus} />
                            </div>
                            <p className="text-slate-400">Firebase Real-time - {transactions.length} txs, {snapshots.length} snaps</p>
                        </div>

                        <div className="flex gap-2 mb-6 flex-wrap">
                            {['dashboard', 'timeline', 'transactions', 'snapshots'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)}
                                    className={`px-6 py-3 rounded-lg font-semibold ${activeTab === tab ? 'bg-blue-600 shadow-lg' : 'bg-slate-800 hover:bg-slate-700'}`}>
                                    {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                </button>
                            ))}
                        </div>

                        {activeTab === 'timeline' && (
                            <TimelineView 
                                transactions={transactions} 
                                snapshots={snapshots} 
                                snapshotsWithCalcs={snapshotsWithCalcs}
                                parseDate={parseDate}
                            />
                        )}

                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Total P/L</div>
                                        <div className={`text-2xl font-bold ${totals.pl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {totals.pl.toFixed(0)} Ft
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Daily P/L Since Start</div>
                                        <div className={`text-2xl font-bold ${totals.dailyPLSinceStart >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {totals.dailyPLSinceStart.toFixed(0)} Ft
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Avg Max DD</div>
                                        <div className="text-2xl font-bold text-orange-400">
                                            {dashboardData.length ? (dashboardData.reduce((s, d) => s + d.maxDrawdown, 0) / dashboardData.length).toFixed(2) : '0.00'}%
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Active Traders</div>
                                        <div className="text-2xl font-bold text-blue-400">{dashboardData.length}</div>
                                    </div>
                                </div>

                                <div className="flex gap-4 items-center bg-slate-800 rounded-xl p-4 border border-slate-700 flex-wrap">
                                    <span>Account:</span>
                                    <select value={accountFilter} onChange={(e) => setAccountFilter(e.target.value)}
                                        className="bg-slate-700 rounded-lg px-4 py-2">
                                        <option>All</option><option>Virtual</option><option>Real</option>
                                    </select>
                                    <button onClick={() => setShowFilters(!showFilters)}
                                        className={`px-4 py-2 rounded-lg font-semibold ${showFilters ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                        {showFilters ? 'Hide' : 'Show'} Filters ({Object.keys(filters).filter(k => filters[k]?.enabled).length})
                                    </button>
                                    {Object.keys(filters).some(k => filters[k]?.enabled) && (
                                        <button onClick={clearFilters} className="bg-orange-600 px-4 py-2 rounded-lg font-semibold">
                                            Clear Filters
                                        </button>
                                    )}
                                    <button onClick={() => exportXLSX('dashboard')} className="ml-auto bg-green-600 px-6 py-2 rounded-lg font-semibold">
                                        Export XLSX
                                    </button>
                                </div>

                                {showFilters && (
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 space-y-4">
                                        <div className="flex justify-between items-center">
                                            <h3 className="text-lg font-semibold">Filters</h3>
                                            <div className="flex gap-2">
                                                <input type="text" placeholder="View name..." value={filterName}
                                                    onChange={(e) => setFilterName(e.target.value)}
                                                    className="bg-slate-700 rounded-lg px-3 py-1 text-sm" />
                                                <button onClick={saveFilterView} className="bg-blue-600 px-4 py-1 rounded-lg text-sm font-semibold">
                                                    Save to Firebase
                                                </button>
                                            </div>
                                        </div>
                                        {savedFilters.length > 0 && (
                                            <div>
                                                <div className="text-sm font-semibold mb-2">Saved Views:</div>
                                                <div className="flex flex-wrap gap-2">
                                                    {savedFilters.map((v) => (
                                                        <div key={v.id} className="bg-slate-700 px-3 py-1 rounded-lg flex items-center gap-2">
                                                            <button onClick={() => loadFilterView(v)} className="text-blue-400 text-sm">{v.name}</button>
                                                            <button onClick={() => deleteFilterView(v.id, v.name)} className="text-red-400 text-xs">×</button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            <FilterControl column="equity" label="Equity" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="netInvested" label="Net Invested" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="pl" label="P/L" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="plPercent" label="P/L %" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="recoveryFactor" label="Recovery" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="currentDailyPL3pt" label="Recent Daily" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="dailyPLSinceStart" label="Daily Start" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="estDailyPL" label="Smart Pred" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="dailyPlPercentSinceStart" label="Daily %" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="currentDrawdown" label="Curr DD" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="maxDrawdown" label="Max DD" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="avgDrawdown" label="Avg DD" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="trader" label="Trader" type="text" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="account" label="Account" type="text" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="decision" label="Decision" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['BUY', 'SELL', 'HOLD', 'NO_DATA']} />
                                            <FilterControl column="warnings" label="Warnings" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['Has Warning', 'No Warning']} />
                                        </div>
                                    </div>
                                )}

                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <SortableHeader column="trader" label="Trader" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />
                                                <SortableHeader column="account" label="Account" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />
                                                <SortableHeader column="latestDate" label="Date" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />
                                                <SortableHeader column="equity" label="Equity" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="netInvested" label="Net Inv" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="pl" label="P/L" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="plPercent" label="P/L %" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="currentDailyPL3pt" label="Recent Daily" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="dailyPLSinceStart" label="Daily Start" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="estDailyPL" label="Smart Pred" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="dailyPlPercentSinceStart" label="Daily %" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="currentDrawdown" label="Curr DD%" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="maxDrawdown" label="Max DD%" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="avgDrawdown" label="Avg DD%" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="recoveryFactor" label="Recovery" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="warnings" label="Warning" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />
                                                <SortableHeader column="decision" label="Decision" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {dashboardData.map(r => {
                                                const decStyle = getDecisionStyle(r.decision);
                                                return (
                                                <tr key={`${r.trader}-${r.account}`} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-3 px-2 font-semibold">{r.trader}</td>
                                                    <td className="py-3 px-2 text-slate-400">{r.account}</td>
                                                    <td className="py-3 px-2 text-slate-400">{r.latestDate}</td>
                                                    <td className="text-right py-3 px-2">{r.equity.toFixed(0)}Ft</td>
                                                    <td className="text-right py-3 px-2">{r.netInvested.toFixed(0)}Ft</td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmap(r.pl, vals.pl)} font-semibold text-white`}>
                                                        {r.pl.toFixed(0)}Ft
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmap(r.plPercent, vals.plPct)} font-semibold text-white`}>
                                                        {r.plPercent.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 border-l-4 ${r.currentDailyPL3pt !== null ? `${getHeatmap(r.currentDailyPL3pt, vals.daily)} ${getBorder(r.currentDailyPL3ptDays)}` : 'bg-slate-700'} text-white`}>
                                                        {r.currentDailyPL3pt !== null ? `${r.currentDailyPL3pt.toFixed(0)}Ft (${r.currentDailyPL3ptDays})` : ''}
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmap(r.dailyPLSinceStart, vals.dailyStart)} text-white`}>
                                                        {r.dailyPLSinceStart.toFixed(0)}Ft
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmap(r.estDailyPL, vals.est)} text-white`}>
                                                        {r.estDailyPL.toFixed(0)}Ft
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmap(r.dailyPlPercentSinceStart, vals.dailyPct)} text-white`}>
                                                        {r.dailyPlPercentSinceStart.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getDD(r.currentDrawdown, vals.curr)} font-semibold text-white`}>
                                                        {r.currentDrawdown.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getDD(r.maxDrawdown, vals.max)} font-semibold text-white`}>
                                                        {r.maxDrawdown.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getDD(r.avgDrawdown, vals.avg)} font-semibold text-white`}>
                                                        {r.avgDrawdown.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmap(r.recoveryFactor, vals.rec)} font-semibold text-white`}>
                                                        {r.recoveryFactor.toFixed(2)}
                                                    </td>
                                                    <td className="text-center py-3 px-2">
                                                        {r.warnings.length > 0 ? (
                                                            <div className="flex flex-col gap-1">
                                                                {r.warnings.map((w, i) => (
                                                                    <span key={i} className="px-2 py-1 bg-orange-600 rounded text-xs">
                                                                        ⚠ {w}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <span className="text-slate-500">-</span>
                                                        )}
                                                    </td>
                                                    <td className="text-center py-3 px-2">
                                                        <span className={`px-3 py-1 rounded-lg font-bold text-white ${decStyle.bg}`}>
                                                            {decStyle.text}
                                                        </span>
                                                    </td>
                                                </tr>
                                                );
                                            })}
                                            <tr className="bg-slate-700 font-bold">
                                                <td colSpan="5" className="py-3 px-2">Σ totals</td>
                                                <td className={`text-right py-3 px-2 ${totals.pl >= 0 ? 'bg-green-600' : 'bg-red-600'} text-white`}>
                                                    {totals.pl.toFixed(0)}Ft
                                                </td>
                                                <td colSpan="3"></td>
                                                <td className={`text-right py-3 px-2 ${totals.dailyPLSinceStart >= 0 ? 'bg-green-600' : 'bg-red-600'} text-white`}>
                                                    {totals.dailyPLSinceStart.toFixed(0)}Ft
                                                </td>
                                                <td className={`text-right py-3 px-2 ${totals.estDailyPL >= 0 ? 'bg-green-600' : 'bg-red-600'} text-white`}>
                                                    {totals.estDailyPL.toFixed(0)}Ft
                                                </td>
                                                <td colSpan="6"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'transactions' && (
                            <div className="space-y-6">
                                <div className="flex gap-4">
                                    <button onClick={() => { setNewData({...newData, dataType: 'transaction'}); setShowAddData(true); }}
                                        className="bg-blue-600 px-6 py-3 rounded-lg font-semibold">Add Data</button>
                                    <button onClick={() => exportXLSX('transactions')} className="bg-green-600 px-6 py-3 rounded-lg font-semibold">Export</button>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <th className="text-left py-3 px-2">Date</th>
                                                <th className="text-left py-3 px-2">Trader</th>
                                                <th className="text-left py-3 px-2">Account</th>
                                                <th className="text-right py-3 px-2">Amount</th>
                                                <th className="text-left py-3 px-2">Type</th>
                                                <th className="text-left py-3 px-2">Note</th>
                                                <th className="text-center py-3 px-2">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {transactions.map(t => (
                                                <tr key={t.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-3 px-2">{t.date}</td>
                                                    <td className="py-3 px-2 font-semibold">{t.trader}</td>
                                                    <td className="py-3 px-2 text-slate-400">{t.account}</td>
                                                    <td className="text-right py-3 px-2">{t.amount}Ft</td>
                                                    <td className="py-3 px-2">
                                                        <span className={`px-2 py-1 rounded text-xs font-semibold ${t.type === 'DEPOSIT' ? 'bg-green-600' : 'bg-red-600'}`}>{t.type}</span>
                                                    </td>
                                                    <td className="py-3 px-2 text-slate-400">{t.note}</td>
                                                    <td className="text-center py-3 px-2">
                                                        <button onClick={() => deleteTransaction(t.id, t.trader, t.date)}
                                                            className="text-red-400 hover:text-red-300 font-bold text-lg">
                                                            ×
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'snapshots' && (
                            <div className="space-y-6">
                                <div className="flex gap-4">
                                    <button onClick={() => { setNewData({...newData, dataType: 'snapshot'}); setShowAddData(true); }}
                                        className="bg-blue-600 px-6 py-3 rounded-lg font-semibold">Add Data</button>
                                    <button onClick={() => exportXLSX('snapshots')} className="bg-green-600 px-6 py-3 rounded-lg font-semibold">Export</button>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <th className="text-left py-3 px-2">Date</th>
                                                <th className="text-left py-3 px-2">Trader</th>
                                                <th className="text-left py-3 px-2">Account</th>
                                                <th className="text-right py-3 px-2">Equity</th>
                                                <th className="text-right py-3 px-2">Max</th>
                                                <th className="text-right py-3 px-2">DD%</th>
                                                <th className="text-left py-3 px-2">PrevDate</th>
                                                <th className="text-right py-3 px-2">Flow</th>
                                                <th className="text-right py-3 px-2">PrevEq</th>
                                                <th className="text-right py-3 px-2">PnL</th>
                                                <th className="text-right py-3 px-2">Days</th>
                                                <th className="text-right py-3 px-2">PL/day</th>
                                                <th className="text-center py-3 px-2">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {snapshotsWithCalcs.map(s => (
                                                <tr key={s.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-3 px-2">{s.date}</td>
                                                    <td className="py-3 px-2 font-semibold">{s.trader}</td>
                                                    <td className="py-3 px-2 text-slate-400">{s.account}</td>
                                                    <td className="text-right py-3 px-2">{s.equity}Ft</td>
                                                    <td className="text-right py-3 px-2 text-blue-400">{s.runningMaxEquity?.toFixed(0)}Ft</td>
                                                    <td className={`text-right py-3 px-2 ${s.currentDrawdown > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                        {s.currentDrawdown?.toFixed(2)}%
                                                    </td>
                                                    <td className="py-3 px-2 text-slate-400">{s.prevDate}</td>
                                                    <td className="text-right py-3 px-2">{s.flowSinceLast?.toFixed(0)}Ft</td>
                                                    <td className="text-right py-3 px-2">{s.prevEquity}Ft</td>
                                                    <td className={`text-right py-3 px-2 ${s.pnlPeriod >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {s.pnlPeriod?.toFixed(0)}Ft
                                                    </td>
                                                    <td className="text-right py-3 px-2">{s.daysSincePrev}</td>
                                                    <td className={`text-right py-3 px-2 ${s.plPerDay >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {s.plPerDay?.toFixed(2)}Ft
                                                    </td>
                                                    <td className="text-center py-3 px-2">
                                                        <button onClick={() => deleteSnapshot(s.id, s.trader, s.date)}
                                                            className="text-red-400 hover:text-red-300 font-bold text-lg">
                                                            ×
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {showAddData && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-semibold">Add Data</h3>
                                        <button onClick={() => setShowAddData(false)} className="text-slate-400 hover:text-white text-2xl">×</button>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="flex gap-2">
                                            <button onClick={() => setNewData({...newData, dataType: 'snapshot'})}
                                                className={`flex-1 py-2 rounded-lg font-semibold ${newData.dataType === 'snapshot' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                                Snapshot
                                            </button>
                                            <button onClick={() => setNewData({...newData, dataType: 'transaction'})}
                                                className={`flex-1 py-2 rounded-lg font-semibold ${newData.dataType === 'transaction' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                                Transaction
                                            </button>
                                        </div>
                                        <input type="text" placeholder="Date (YYYY.MM.DD)" value={newData.date}
                                            onChange={(e) => setNewData({ ...newData, date: e.target.value })}
                                            className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                        {newData.dataType === 'snapshot' ? (
                                            <select value={newData.trader} onChange={(e) => setNewData({ ...newData, trader: e.target.value })}
                                                className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                                <option value="">Select Trader</option>
                                                {traderNames.map(n => <option key={n} value={n}>{n}</option>)}
                                            </select>
                                        ) : (
                                            <input type="text" placeholder="Trader" value={newData.trader}
                                                onChange={(e) => setNewData({ ...newData, trader: e.target.value })}
                                                className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                        )}
                                        <select value={newData.account} onChange={(e) => setNewData({ ...newData, account: e.target.value })}
                                            className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                            <option>Virtual</option>
                                            <option>Real</option>
                                        </select>
                                        {newData.dataType === 'snapshot' ? (
                                            <input type="number" placeholder="Equity" value={newData.equity}
                                                onChange={(e) => setNewData({ ...newData, equity: e.target.value })}
                                                className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                        ) : (
                                            <>
                                                <input type="number" placeholder="Amount" value={newData.amount}
                                                    onChange={(e) => setNewData({ ...newData, amount: e.target.value })}
                                                    className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                                <select value={newData.transactionType} onChange={(e) => setNewData({ ...newData, transactionType: e.target.value })}
                                                    className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                                    <option>DEPOSIT</option>
                                                    <option>WITHDRAWAL</option>
                                                    <option>REALLOCATION</option>
                                                </select>
                                                <input type="text" placeholder="Note" value={newData.note}
                                                    onChange={(e) => setNewData({ ...newData, note: e.target.value })}
                                                    className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                            </>
                                        )}
                                        <button onClick={addData} className="w-full bg-blue-600 px-6 py-2 rounded-lg font-semibold">
                                            Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EtoroTracker />);
    </script>
</body>
</html>