<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eToro Copy Trader Dashboard v11</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBVE6eRSapt2fwVnLoQm2EfcScksg0OWiU",
            authDomain: "etoro-tracker.firebaseapp.com",
            projectId: "etoro-tracker",
            storageBucket: "etoro-tracker.firebasestorage.app",
            messagingSenderId: "941552714377",
            appId: "1:941552714377:web:8c44519dc1352aea7bbc58"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.firebaseDb = db;
        window.firebaseUtils = { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setDoc };
        window.SECURITY_KEY = "my-secret-etoro-key-2024";
        window.firebaseReady = true;
    </script>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        function Tooltip({ content, children }) {
            const [show, setShow] = useState(false);
            return (
                <div className="relative inline-block"
                     onMouseEnter={() => setShow(true)}
                     onMouseLeave={() => setShow(false)}>
                    {children}
                    {show && (
                        <div className="absolute z-50 bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg shadow-xl max-w-xs border border-slate-700">
                            {content}
                            <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1 border-4 border-transparent border-t-slate-900"></div>
                        </div>
                    )}
                </div>
            );
        }

        function AlertPanel({ alerts, onDismiss }) {
@@ -177,71 +177,136 @@
                    )}
                    {type === 'select' && options && (
                        <select value={filter.value || ''} 
                            onChange={(e) => updateFilter(column, { ...filter, value: e.target.value, type: 'select', enabled: true })}
                            className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm">
                            <option value="">All</option>
                            {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                    )}
                </div>
            );
        }

        function SortableHeader({ column, label, sortColumn, sortDirection, handleSort, align = 'left' }) {
            return (
                <th className={`text-${align} py-3 px-2 font-semibold cursor-pointer hover:bg-slate-700`}
                    onClick={() => handleSort(column)}>
                    <div className={`flex items-center gap-1 ${align === 'right' ? 'justify-end' : ''}`}>
                        {label}
                        {sortColumn === column && <span className="text-blue-400">{sortDirection === 'asc' ? '▲' : '▼'}</span>}
                    </div>
                </th>
            );
        }

        const DASHBOARD_COLUMN_DEFS = [
            { key: 'trader', label: 'Trader' },
            { key: 'account', label: 'Account' },
            { key: 'activity', label: 'Activity' },
            { key: 'rfGrade', label: 'RF Grade' },
            { key: 'ddRisk', label: 'DD Risk' },
            { key: 'entry', label: 'Entry' },
            { key: 'exit', label: 'Exit' },
            { key: 'action', label: 'Action' },
            { key: 'warnings', label: 'Warning' },
            { key: 'decision', label: 'Decision' },
            { key: 'equity', label: 'Equity' },
            { key: 'netInvested', label: 'Net Invested' },
            { key: 'pl', label: 'P/L' },
            { key: 'plPercent', label: 'P/L %' },
            { key: 'recentDaily', label: 'Recent Daily' },
            { key: 'dailyStart', label: 'Daily Start' },
            { key: 'smartPred', label: 'Smart Pred' },
            { key: 'dailyPercent', label: 'Daily %' },
            { key: 'currDD', label: 'Curr DD' },
            { key: 'maxDD', label: 'Max DD' },
            { key: 'recovery', label: 'Recovery' }
        ];

        const DASHBOARD_COLUMN_DEFAULTS = DASHBOARD_COLUMN_DEFS.reduce((acc, col) => {
            acc[col.key] = true;
            return acc;
        }, {});

        function EtoroTracker() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [accountFilter, setAccountFilter] = useState('All');
            const [showAddData, setShowAddData] = useState(false);
            const [transactions, setTransactions] = useState([]);
            const [snapshots, setSnapshots] = useState([]);
            const [alerts, setAlerts] = useState([]);
            const [sortColumn, setSortColumn] = useState('trader');
            const [sortDirection, setSortDirection] = useState('asc');
            const [showFilters, setShowFilters] = useState(false);
            const [filters, setFilters] = useState({});
            const [visibleColumns, setVisibleColumns] = useState(() => ({ ...DASHBOARD_COLUMN_DEFAULTS }));
            const [showColumnControls, setShowColumnControls] = useState(false);
            const [savedFilters, setSavedFilters] = useState([]);
            const [filterName, setFilterName] = useState('');
            const [firebaseStatus, setFirebaseStatus] = useState('checking');
            const previousDataRef = useRef(null);
            const [newData, setNewData] = useState({
                dataType: 'snapshot',
                date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                trader: '', account: 'Virtual', equity: '', amount: '', transactionType: 'DEPOSIT', note: ''
            });

            const isColumnVisible = (key) => visibleColumns[key] !== false;

            const visibleColumnCount = useMemo(() => Object.values(visibleColumns).filter(Boolean).length, [visibleColumns]);

            const toggleColumnVisibility = (key) => {
                setVisibleColumns(prev => {
                    const visibleCount = Object.values(prev).filter(Boolean).length;
                    if (prev[key] && visibleCount === 1) return prev;
                    return { ...prev, [key]: !prev[key] };
                });
            };

            useEffect(() => {
                if (typeof window === 'undefined' || !window.localStorage) return;
                try {
                    const saved = window.localStorage.getItem('dashboardVisibleColumns');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        setVisibleColumns(prev => ({ ...prev, ...parsed }));
                    }
                } catch (e) {
                    console.warn('Column visibility restore failed:', e);
                }
            }, []);

            useEffect(() => {
                if (typeof window === 'undefined' || !window.localStorage) return;
                try {
                    window.localStorage.setItem('dashboardVisibleColumns', JSON.stringify(visibleColumns));
                } catch (e) {
                    console.warn('Column visibility persist failed:', e);
                }
            }, [visibleColumns]);

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.firebaseReady) {
                        setTimeout(initFirebase, 100);
                        return;
                    }
                    const { collection, onSnapshot, query, orderBy } = window.firebaseUtils;
                    const db = window.firebaseDb;
                    
                    onSnapshot(query(collection(db, 'transactions'), orderBy('date', 'desc')), (snapshot) => {
                        setTransactions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setFirebaseStatus('connected');
                    }, (error) => {
                        console.error('Firebase error:', error);
                        setFirebaseStatus('disconnected');
                    });
                    
                    onSnapshot(query(collection(db, 'snapshots'), orderBy('date', 'desc')), (snapshot) => {
                        setSnapshots(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });

                    onSnapshot(query(collection(db, 'filter_views')), (snapshot) => {
                        setSavedFilters(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });

@@ -798,52 +863,59 @@
                            if (f.type === 'range') {
                                const min = f.min !== '' ? parseFloat(f.min) : -Infinity;
                                const max = f.max !== '' ? parseFloat(f.max) : Infinity;
                                return row[col] >= min && row[col] <= max;
                            }
                            if (f.type === 'text') return row[col].toLowerCase().includes(f.value.toLowerCase());
                            if (f.type === 'select') {
                                if (col === 'decision') return row.decision === f.value;
                                if (col === 'warnings') return f.value === 'Has Warning' ? row.warnings.length > 0 : row.warnings.length === 0;
                                if (col === 'entrySignal') return row.entrySignal && row.entrySignal.type === f.value;
                                if (col === 'exitSignal') return row.exitSignal && row.exitSignal.urgency === f.value;
                                if (col === 'actionSignal') return row.actionSignal && row.actionSignal.type === f.value;
                                if (col === 'rfGrade') return row.rfAssessment && row.rfAssessment.grade === f.value;
                                if (col === 'ddRisk') return row.ddAssessment && row.ddAssessment.overallRisk === f.value;
                                if (col === 'activity') return row.activityInfo && row.activityInfo.status === f.value;
                            }
                            return true;
                        });
                    }
                });
                data.sort((a, b) => {
                    let av = a[sortColumn], bv = b[sortColumn];
                    if (sortColumn === 'warnings') {
                        av = a.warnings.length;
                        bv = b.warnings.length;
                    } else if (sortColumn === 'decision') {
                        const decisionOrder = { NO_DATA: 0, SELL: 1, HOLD: 2, BUY: 3 };
                        av = decisionOrder[a.decision] ?? -1;
                        bv = decisionOrder[b.decision] ?? -1;
                    } else if (typeof av === 'string' || typeof bv === 'string') {
                        const aStr = (av ?? '').toString();
                        const bStr = (bv ?? '').toString();
                        return sortDirection === 'asc' ? aStr.localeCompare(bStr) : bStr.localeCompare(aStr);
                    }
                    if (av === null) av = -Infinity;
                    if (bv === null) bv = -Infinity;
                    return sortDirection === 'asc' ? av - bv : bv - av;
                });
                
                previousDataRef.current = data;
                return data;
            }, [snapshotsWithCalcs, transactions, accountFilter, filters, sortColumn, sortDirection]);

            // Create alerts for triggers
            useEffect(() => {
                dashboardData.forEach(row => {
                    if (row.triggers && Array.isArray(row.triggers) && row.triggers.length > 0) {
                        row.triggers.forEach(async trigger => {
                            if (trigger && (trigger.level === 'CRITICAL' || trigger.level === 'WARNING')) {
                                try {
                                    const { collection, addDoc } = window.firebaseUtils;
                                    const db = window.firebaseDb;
                                    await addDoc(collection(db, 'alerts'), {
                                        trader: row.trader,
                                        account: row.account,
                                        level: trigger.level,
                                        type: trigger.type,
                                        message: trigger.message,
                                        timestamp: new Date().toISOString(),
@@ -883,81 +955,89 @@
            const clearFilters = () => setFilters({});
            
            const saveFilterView = async () => {
                if (!filterName.trim()) return alert('Enter filter name');
                try {
                    const { collection, addDoc } = window.firebaseUtils;
                    const db = window.firebaseDb;
                    await addDoc(collection(db, 'filter_views'), {
                        name: filterName,
                        filters,
                        timestamp: new Date().toISOString(),
                        securityKey: window.SECURITY_KEY
                    });
                    setFilterName('');
                    alert(`Filter "${filterName}" saved to Firebase!`);
                } catch (e) {
                    alert('Save failed: ' + e.message);
                }
            };
            
            const loadFilterView = (v) => setFilters(v.filters);
            
            const deleteFilterView = async (id, name) => {
                if (!confirm(`Delete "${name}"?`)) return;
                try {
                    const { deleteDoc, doc, setDoc } = window.firebaseUtils;
                    const ref = doc(window.firebaseDb, 'filter_views', id);
                    await setDoc(ref, { securityKey: window.SECURITY_KEY }, { merge: true });
                    await deleteDoc(ref);
                } catch (e) {
                    alert('Delete failed: ' + e.message);
                }
            };

            const dismissAlert = async (id) => {
                try {
                    const { deleteDoc, doc, setDoc } = window.firebaseUtils;
                    const ref = doc(window.firebaseDb, 'alerts', id);
                    await setDoc(ref, { securityKey: window.SECURITY_KEY }, { merge: true });
                    await deleteDoc(ref);
                } catch (e) {
                    alert('Dismiss failed: ' + e.message);
                }
            };

            const deleteTransaction = async (id, trader, date) => {
                if (!confirm(`Delete transaction for ${trader} on ${date}?`)) return;
                try {
                    const { deleteDoc, doc, setDoc } = window.firebaseUtils;
                    const ref = doc(window.firebaseDb, 'transactions', id);
                    await setDoc(ref, { securityKey: window.SECURITY_KEY }, { merge: true });
                    await deleteDoc(ref);
                } catch (e) {
                    alert('Delete failed: ' + e.message);
                }
            };

            const deleteSnapshot = async (id, trader, date) => {
                if (!confirm(`Delete snapshot for ${trader} on ${date}?`)) return;
                try {
                    const { deleteDoc, doc, setDoc } = window.firebaseUtils;
                    const ref = doc(window.firebaseDb, 'snapshots', id);
                    await setDoc(ref, { securityKey: window.SECURITY_KEY }, { merge: true });
                    await deleteDoc(ref);
                } catch (e) {
                    alert('Delete failed: ' + e.message);
                }
            };

            const getDecisionStyle = (decision) => {
                switch(decision) {
                    case 'BUY': return { bg: 'bg-green-600', text: '▲ BUY' };
                    case 'SELL': return { bg: 'bg-red-600', text: '▼ SELL' };
                    case 'HOLD': return { bg: 'bg-yellow-600', text: '● HOLD' };
                    default: return { bg: 'bg-slate-600', text: '- N/A' };
                }
            };

            const getRowClasses = (row) => {
                const classes = ['border-b', 'border-slate-700/50', 'hover:bg-slate-700/30'];
                
                if (row.exitSignal && row.exitSignal.urgency === 'IMMEDIATE') {
                    classes.push('bg-red-900/20', 'border-l-4', 'border-l-red-600');
                } else if (row.entrySignal && row.entrySignal.type === 'CONSERVATIVE_ENTRY') {
                    classes.push('bg-emerald-900/10', 'border-l-4', 'border-l-emerald-600');
                } else if (row.exitSignal && row.exitSignal.urgency === 'MODERATE') {
                    classes.push('bg-orange-900/10', 'border-l-4', 'border-l-orange-600');
                }
                
@@ -1126,55 +1206,79 @@
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-orange-700">
                                        <div className="text-slate-400 text-xs mb-1">🔔 Active Triggers</div>
                                        <div className="text-2xl font-bold text-orange-400">
                                            {signalSummary.activeTriggers}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-4 items-center bg-slate-800 rounded-xl p-4 border border-slate-700 flex-wrap">
                                    <span>Account:</span>
                                    <select value={accountFilter} onChange={(e) => setAccountFilter(e.target.value)}
                                        className="bg-slate-700 rounded-lg px-4 py-2">
                                        <option>All</option><option>Virtual</option><option>Real</option>
                                    </select>
                                    <button onClick={() => setShowFilters(!showFilters)}
                                        className={`px-4 py-2 rounded-lg font-semibold ${showFilters ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                        {showFilters ? 'Hide' : 'Show'} Filters ({Object.keys(filters).filter(k => filters[k]?.enabled).length})
                                    </button>
                                    {Object.keys(filters).some(k => filters[k]?.enabled) && (
                                        <button onClick={clearFilters} className="bg-orange-600 px-4 py-2 rounded-lg font-semibold">
                                            Clear Filters
                                        </button>
                                    )}
                                    <button onClick={() => setShowColumnControls(!showColumnControls)}
                                        className={`px-4 py-2 rounded-lg font-semibold ${showColumnControls ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                        {showColumnControls ? 'Hide' : 'Show'} Columns
                                    </button>
                                    <button onClick={() => exportXLSX('dashboard')} className="ml-auto bg-green-600 px-6 py-2 rounded-lg font-semibold">
                                        Export XLSX
                                    </button>
                                </div>

                                {showColumnControls && (
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                            {DASHBOARD_COLUMN_DEFS.map(col => (
                                                <label key={col.key} className="flex items-center gap-2 text-sm">
                                                    <input type="checkbox"
                                                        checked={isColumnVisible(col.key)}
                                                        onChange={() => toggleColumnVisibility(col.key)}
                                                        disabled={isColumnVisible(col.key) && visibleColumnCount === 1}
                                                        className="w-4 h-4" />
                                                    <span>{col.label}</span>
                                                </label>
                                            ))}
                                        </div>
                                        {visibleColumnCount === 1 && (
                                            <div className="text-xs text-orange-400 mt-3">At least one column must remain visible.</div>
                                        )}
                                    </div>
                                )}

                                {showFilters && (
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 space-y-4">
                                        <div className="flex justify-between items-center">
                                            <h3 className="text-lg font-semibold">Advanced Filters</h3>
                                            <div className="flex gap-2">
                                                <input type="text" placeholder="View name..." value={filterName}
                                                    onChange={(e) => setFilterName(e.target.value)}
                                                    className="bg-slate-700 rounded-lg px-3 py-1 text-sm" />
                                                <button onClick={saveFilterView} className="bg-blue-600 px-4 py-1 rounded-lg text-sm font-semibold">
                                                    Save to Firebase
                                                </button>
                                            </div>
                                        </div>
                                        {savedFilters.length > 0 && (
                                            <div>
                                                <div className="text-sm font-semibold mb-2">Saved Views:</div>
                                                <div className="flex flex-wrap gap-2">
                                                    {savedFilters.map((v) => (
                                                        <div key={v.id} className="bg-slate-700 px-3 py-1 rounded-lg flex items-center gap-2">
                                                            <button onClick={() => loadFilterView(v)} className="text-blue-400 text-sm">{v.name}</button>
                                                            <button onClick={() => deleteFilterView(v.id, v.name)} className="text-red-400 text-xs">×</button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
@@ -1194,215 +1298,303 @@
                                            <FilterControl column="account" label="Account" type="text" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="decision" label="Decision" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['BUY', 'SELL', 'HOLD', 'NO_DATA']} />
                                            <FilterControl column="warnings" label="Warnings" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['Has Warning', 'No Warning']} />
                                            <FilterControl column="entrySignal" label="Entry Signal" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['CONSERVATIVE_ENTRY', 'BALANCED_ENTRY', 'AGGRESSIVE_ENTRY', 'NO_ENTRY']} />
                                            <FilterControl column="exitSignal" label="Exit Alert" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['IMMEDIATE', 'MODERATE', 'OPTIONAL']} />
                                            <FilterControl column="actionSignal" label="Action" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['INCREASE', 'HOLD', 'REDUCE', 'MONITOR']} />
                                            <FilterControl column="rfGrade" label="RF Grade" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['S', 'A', 'B', 'C', 'C-', 'D', 'F']} />
                                            <FilterControl column="ddRisk" label="DD Risk" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['SAFE', 'ACCEPTABLE', 'RISKY', 'DANGEROUS']} />
                                            <FilterControl column="activity" label="Activity" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['VERY_ACTIVE', 'ACTIVE', 'MODERATE', 'LOW_ACTIVITY', 'DORMANT']} />
                                        </div>
                                    </div>
                                )}

                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 overflow-x-auto">
                                    <table className="w-full text-xs">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                {isColumnVisible('trader') && (
                                                    <SortableHeader column="trader" label="Trader" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />
                                                )}
                                                {isColumnVisible('account') && (
                                                    <SortableHeader column="account" label="Account" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />
                                                )}
                                                {isColumnVisible('activity') && (
                                                    <th className="text-center py-3 px-2 font-semibold">Activity</th>
                                                )}
                                                {isColumnVisible('rfGrade') && (
                                                    <th className="text-center py-3 px-2 font-semibold">RF Grade</th>
                                                )}
                                                {isColumnVisible('ddRisk') && (
                                                    <th className="text-center py-3 px-2 font-semibold">DD Risk</th>
                                                )}
                                                {isColumnVisible('entry') && (
                                                    <th className="text-center py-3 px-2 font-semibold">Entry</th>
                                                )}
                                                {isColumnVisible('exit') && (
                                                    <th className="text-center py-3 px-2 font-semibold">Exit</th>
                                                )}
                                                {isColumnVisible('action') && (
                                                    <th className="text-center py-3 px-2 font-semibold">Action</th>
                                                )}
                                                {isColumnVisible('warnings') && (
                                                    <SortableHeader column="warnings" label="Warning" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />
                                                )}
                                                {isColumnVisible('decision') && (
                                                    <SortableHeader column="decision" label="Decision" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />
                                                )}
                                                {isColumnVisible('equity') && (
                                                    <SortableHeader column="equity" label="Equity" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                )}
                                                {isColumnVisible('netInvested') && (
                                                    <SortableHeader column="netInvested" label="Net Invested" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                )}
                                                {isColumnVisible('pl') && (
                                                    <SortableHeader column="pl" label="P/L" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                )}
                                                {isColumnVisible('plPercent') && (
                                                    <SortableHeader column="plPercent" label="P/L %" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                )}
                                                {isColumnVisible('recentDaily') && (
                                                    <SortableHeader column="currentDailyPL3pt" label="Recent Daily" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                )}
                                                {isColumnVisible('dailyStart') && (
                                                    <SortableHeader column="dailyPLSinceStart" label="Daily Start" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                )}
                                                {isColumnVisible('smartPred') && (
                                                    <SortableHeader column="estDailyPL" label="Smart Pred" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                )}
                                                {isColumnVisible('dailyPercent') && (
                                                    <SortableHeader column="dailyPlPercentSinceStart" label="Daily %" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                )}
                                                {isColumnVisible('currDD') && (
                                                    <SortableHeader column="currentDrawdown" label="Curr DD" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                )}
                                                {isColumnVisible('maxDD') && (
                                                    <SortableHeader column="maxDrawdown" label="Max DD" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                )}
                                                {isColumnVisible('recovery') && (
                                                    <SortableHeader column="recoveryFactor" label="Recovery" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                )}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {dashboardData.map(r => {
                                                const decStyle = getDecisionStyle(r.decision);
                                                return (
                                                <tr key={`${r.trader}-${r.account}`} className={getRowClasses(r)}>
                                                    {isColumnVisible('trader') && (
                                                        <td className="py-3 px-2 font-semibold">{r.trader}</td>
                                                    )}
                                                    {isColumnVisible('account') && (
                                                        <td className="py-3 px-2 text-slate-400">{r.account}</td>
                                                    )}

                                                    {isColumnVisible('activity') && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.activityInfo ? (
                                                                <Tooltip content={`Avg Daily P/L Movement: ${r.activityInfo.metrics?.avgAbsDailyPL || '0'} Ft | Active Days: ${r.activityInfo.metrics?.activityRatio || '0%'}`}>
                                                                    <div className="flex flex-col items-center">
                                                                        <span className={`text-xs font-bold ${r.activityInfo.color || 'text-slate-500'}`}>
                                                                            {r.activityInfo.status || 'N/A'}
                                                                        </span>
                                                                        <span className="text-xs text-slate-400">
                                                                            {r.activityInfo.metrics?.avgAbsDailyPL || '0'} Ft/d
                                                                        </span>
                                                                    </div>
                                                                </Tooltip>
                                                            ) : (
                                                                <span className="text-slate-500 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    )}

                                                    {isColumnVisible('rfGrade') && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.rfAssessment ? (
                                                                <Tooltip content={r.rfAssessment.label || ''}>
                                                                    <div className={`inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold ${r.rfAssessment.color || 'bg-slate-600'}`}>
                                                                        <span>{r.rfAssessment.icon || '?'}</span>
                                                                        <span>{r.rfAssessment.grade || 'N/A'}</span>
                                                                    </div>
                                                                </Tooltip>
                                                            ) : (
                                                                <span className="text-slate-500 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    )}

                                                    {isColumnVisible('ddRisk') && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.ddAssessment ? (
                                                                <div className="flex flex-col gap-1">
                                                                    <span className={`text-xs ${r.ddAssessment.currentLevel?.color || 'text-slate-500'}`}>
                                                                        C:{r.ddAssessment.currentLevel?.label || 'N/A'}
                                                                    </span>
                                                                    <span className={`text-xs px-1 py-0.5 rounded ${
                                                                        r.ddAssessment.overallRisk === 'SAFE' ? 'bg-green-900/30 text-green-400' :
                                                                        r.ddAssessment.overallRisk === 'ACCEPTABLE' ? 'bg-yellow-900/30 text-yellow-400' :
                                                                        r.ddAssessment.overallRisk === 'RISKY' ? 'bg-orange-900/30 text-orange-400' :
                                                                        r.ddAssessment.overallRisk === 'DANGEROUS' ? 'bg-red-900/30 text-red-400' :
                                                                        'bg-slate-900/30 text-slate-400'
                                                                    }`}>
                                                                        {r.ddAssessment.overallRisk || 'N/A'}
                                                                    </span>
                                                                </div>
                                                            ) : (
                                                                <span className="text-slate-500 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    )}

                                                    {isColumnVisible('entry') && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.entrySignal && r.entrySignal.type !== 'NO_ENTRY' ? (
                                                                <Tooltip content={r.entrySignal.strength || r.entrySignal.type || ''}>
                                                                    <div className={`px-2 py-1 rounded-lg ${r.entrySignal.color || 'bg-slate-600'} text-white text-xs font-bold`}>
                                                                        {r.entrySignal.icon || '?'}
                                                                    </div>
                                                                </Tooltip>
                                                            ) : (
                                                                <span className="text-slate-500 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    )}

                                                    {isColumnVisible('exit') && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.exitSignal ? (
                                                                <Tooltip content={r.exitSignal.type || ''}>
                                                                    <div className={`px-2 py-1 rounded-lg ${r.exitSignal.color || 'bg-slate-600'} text-white text-xs font-bold ${
                                                                        r.exitSignal.pulse ? 'animate-pulse' : ''
                                                                    }`}>
                                                                        {r.exitSignal.icon || '?'}
                                                                    </div>
                                                                </Tooltip>
                                                            ) : (
                                                                <span className="text-green-500 text-xs">✓</span>
                                                            )}
                                                        </td>
                                                    )}

                                                    {isColumnVisible('action') && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.actionSignal ? (
                                                                <Tooltip content={r.actionSignal.type || ''}>
                                                                    <div className={`px-2 py-1 rounded-lg ${r.actionSignal.color || 'bg-slate-600'} text-white text-xs`}>
                                                                        {r.actionSignal.icon || '?'}
                                                                    </div>
                                                                </Tooltip>
                                                            ) : (
                                                                <span className="text-slate-500 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    )}

                                                    {isColumnVisible('warnings') && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.warnings.length > 0 ? (
                                                                <div className="flex flex-col gap-1">
                                                                    {r.warnings.map((w, i) => (
                                                                        <span key={i} className="px-2 py-1 bg-orange-600 rounded text-xs">
                                                                            ⚠ {w}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            ) : (
                                                                <span className="text-slate-500">-</span>
                                                            )}
                                                        </td>
                                                    )}

                                                    {isColumnVisible('decision') && (
                                                        <td className="text-center py-3 px-2">
                                                            <span className={`px-3 py-1 rounded-lg font-bold text-white ${decStyle.bg}`}>
                                                                {decStyle.text}
                                                            </span>
                                                        </td>
                                                    )}

                                                    {isColumnVisible('equity') && (
                                                        <td className="text-right py-3 px-2">{r.equity.toFixed(0)}Ft</td>
                                                    )}
                                                    {isColumnVisible('netInvested') && (
                                                        <td className="text-right py-3 px-2">{r.netInvested.toFixed(0)}Ft</td>
                                                    )}
                                                    {isColumnVisible('pl') && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.pl, vals.pl)} font-semibold text-white`}>
                                                            {r.pl.toFixed(0)}Ft
                                                        </td>
                                                    )}
                                                    {isColumnVisible('plPercent') && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.plPercent, vals.plPct)} font-semibold text-white`}>
                                                            {r.plPercent.toFixed(2)}%
                                                        </td>
                                                    )}
                                                    {isColumnVisible('recentDaily') && (
                                                        <td className={`text-right py-3 px-2 border-l-4 ${r.currentDailyPL3pt !== null ? `${getHeatmap(r.currentDailyPL3pt, vals.daily)} ${getBorder(r.currentDailyPL3ptDays)}` : 'bg-slate-700'} text-white`}>
                                                            {r.currentDailyPL3pt !== null ? `${r.currentDailyPL3pt.toFixed(0)}Ft (${r.currentDailyPL3ptDays})` : ''}
                                                        </td>
                                                    )}
                                                    {isColumnVisible('dailyStart') && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.dailyPLSinceStart, vals.dailyStart)} text-white`}>
                                                            {r.dailyPLSinceStart.toFixed(0)}Ft
                                                        </td>
                                                    )}
                                                    {isColumnVisible('smartPred') && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.estDailyPL, vals.est)} text-white`}>
                                                            {r.estDailyPL.toFixed(0)}Ft
                                                        </td>
                                                    )}
                                                    {isColumnVisible('dailyPercent') && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.dailyPlPercentSinceStart, vals.dailyPct)} text-white`}>
                                                            {r.dailyPlPercentSinceStart.toFixed(2)}%
                                                        </td>
                                                    )}
                                                    {isColumnVisible('currDD') && (
                                                        <td className={`text-right py-3 px-2 ${getDD(r.currentDrawdown, vals.curr)} font-semibold text-white`}>
                                                            {r.currentDrawdown.toFixed(2)}%
                                                        </td>
                                                    )}
                                                    {isColumnVisible('maxDD') && (
                                                        <td className={`text-right py-3 px-2 ${getDD(r.maxDrawdown, vals.max)} font-semibold text-white`}>
                                                            {r.maxDrawdown.toFixed(2)}%
                                                        </td>
                                                    )}
                                                    {isColumnVisible('recovery') && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.recoveryFactor, vals.rec)} font-semibold text-white`}>
                                                            {r.recoveryFactor.toFixed(2)}
                                                        </td>
                                                    )}
                                                </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'transactions' && (
                            <div className="space-y-6">
                                <div className="flex gap-4">
                                    <button onClick={() => { setNewData({...newData, dataType: 'transaction'}); setShowAddData(true); }}
                                        className="bg-blue-600 px-6 py-3 rounded-lg font-semibold">Add Data</button>
                                    <button onClick={() => exportXLSX('transactions')} className="bg-green-600 px-6 py-3 rounded-lg font-semibold">Export</button>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <th className="text-left py-3 px-2">Date</th>
                                                <th className="text-left py-3 px-2">Trader</th>
                                                <th className="text-left py-3 px-2">Account</th>
                                                <th className="text-right py-3 px-2">Amount</th>
                                                <th className="text-left py-3 px-2">Type</th>
