<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eToro Copy Trader Dashboard v11</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBVE6eRSapt2fwVnLoQm2EfcScksg0OWiU",
            authDomain: "etoro-tracker.firebaseapp.com",
            projectId: "etoro-tracker",
            storageBucket: "etoro-tracker.firebasestorage.app",
            messagingSenderId: "941552714377",
            appId: "1:941552714377:web:8c44519dc1352aea7bbc58"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.firebaseDb = db;
        window.firebaseUtils = { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc };
        window.SECURITY_KEY = "my-secret-etoro-key-2024";
        window.firebaseReady = true;
    </script>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        function Tooltip({ content, children }) {
            const [show, setShow] = useState(false);
            return (
                <div className="relative inline-block"
                     onMouseEnter={() => setShow(true)}
                     onMouseLeave={() => setShow(false)}>
                    {children}
                    {show && (
                        <div className="absolute z-50 bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg shadow-xl max-w-xs border border-slate-700">
                            {content}
                            <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1 border-4 border-transparent border-t-slate-900"></div>
                        </div>
                    )}
                </div>
            );
        }

        function AlertPanel({ alerts, onDismiss }) {
            const [showAlerts, setShowAlerts] = useState(false);
            const unreadCount = alerts.filter(a => !a.read).length;
            
            return (
                <div className="relative">
                    <button 
                        onClick={() => setShowAlerts(!showAlerts)}
                        className="relative bg-slate-800 p-3 rounded-lg border border-slate-700 hover:bg-slate-700"
                    >
                        <span className="text-2xl">üîî</span>
                        {unreadCount > 0 && (
                            <span className="absolute -top-2 -right-2 bg-red-600 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center animate-pulse">
                                {unreadCount}
                            </span>
                        )}
                    </button>
                    
                    {showAlerts && (
                        <div className="absolute top-16 right-0 w-96 max-h-96 overflow-y-auto bg-slate-800 rounded-lg border border-slate-700 shadow-2xl z-50">
                            <div className="p-4 border-b border-slate-700">
                                <h3 className="font-bold">Active Alerts</h3>
                            </div>
                            
                            {alerts.length === 0 ? (
                                <div className="p-4 text-center text-slate-400">
                                    No alerts
                                </div>
                            ) : (
                                <div className="divide-y divide-slate-700">
                                    {alerts.map(alert => (
                                        <div key={alert.id} className={`p-4 ${
                                            alert.level === 'CRITICAL' ? 'bg-red-900/20' :
                                            alert.level === 'WARNING' ? 'bg-orange-900/20' :
                                            'bg-blue-900/20'
                                        }`}>
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                                                            alert.level === 'CRITICAL' ? 'bg-red-600' :
                                                            alert.level === 'WARNING' ? 'bg-orange-600' :
                                                            'bg-blue-600'
                                                        } text-white`}>
                                                            {alert.level}
                                                        </span>
                                                        <span className="text-xs text-slate-400">
                                                            {new Date(alert.timestamp).toLocaleString()}
                                                        </span>
                                                    </div>
                                                    <div className="font-semibold text-sm">
                                                        {alert.trader} ({alert.account})
                                                    </div>
                                                    <div className="text-sm text-slate-300 mt-1">
                                                        {alert.message}
                                                    </div>
                                                </div>
                                                <button 
                                                    onClick={() => onDismiss(alert.id)}
                                                    className="text-slate-400 hover:text-white"
                                                >
                                                    √ó
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function FirebaseStatus({ status }) {
            const colors = {
                connected: 'bg-green-500',
                readonly: 'bg-yellow-500',
                disconnected: 'bg-red-500',
                checking: 'bg-gray-500'
            };
            const labels = {
                connected: 'Connected & Writable',
                readonly: 'Connected (Read Only)',
                disconnected: 'Disconnected',
                checking: 'Checking...'
            };
            return (
                <div className="flex items-center gap-2 bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
                    <div className={`w-3 h-3 rounded-full ${colors[status]} ${status === 'connected' ? 'animate-pulse' : ''}`}></div>
                    <span className="text-sm">{labels[status]}</span>
                </div>
            );
        }

        function FilterControl({ column, label, type, filters, updateFilter, options }) {
            const filter = filters[column] || { enabled: false, type, min: '', max: '', value: '' };
            return (
                <div className="bg-slate-700 rounded-lg p-3">
                    <div className="flex items-center gap-2 mb-2">
                        <input type="checkbox" checked={filter.enabled}
                            onChange={(e) => updateFilter(column, { ...filter, enabled: e.target.checked })}
                            className="w-4 h-4" />
                        <label className="text-sm font-semibold">{label}</label>
                    </div>
                    {type === 'range' && (
                        <div className="flex gap-2">
                            <input type="number" placeholder="Min" value={filter.min || ''}
                                onChange={(e) => updateFilter(column, { ...filter, min: e.target.value, type: 'range', enabled: true })}
                                className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm" />
                            <input type="number" placeholder="Max" value={filter.max || ''}
                                onChange={(e) => updateFilter(column, { ...filter, max: e.target.value, type: 'range', enabled: true })}
                                className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm" />
                        </div>
                    )}
                    {type === 'text' && (
                        <input type="text" placeholder={`Search...`} value={filter.value || ''}
                            onChange={(e) => updateFilter(column, { ...filter, value: e.target.value, type: 'text', enabled: true })}
                            className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm" />
                    )}
                    {type === 'select' && options && (
                        <select value={filter.value || ''} 
                            onChange={(e) => updateFilter(column, { ...filter, value: e.target.value, type: 'select', enabled: true })}
                            className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm">
                            <option value="">All</option>
                            {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                    )}
                </div>
            );
        }

        function SortableHeader({ column, label, sortColumn, sortDirection, handleSort, align = 'left' }) {
            return (
                <th className={`text-${align} py-3 px-2 font-semibold cursor-pointer hover:bg-slate-700`}
                    onClick={() => handleSort(column)}>
                    <div className={`flex items-center gap-1 ${align === 'right' ? 'justify-end' : ''}`}>
                        {label}
                        {sortColumn === column && <span className="text-blue-400">{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>}
                    </div>
                </th>
            );
        }

        function EtoroTracker() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [accountFilter, setAccountFilter] = useState('All');
            const [showAddData, setShowAddData] = useState(false);
            const [transactions, setTransactions] = useState([]);
            const [snapshots, setSnapshots] = useState([]);
            const [alerts, setAlerts] = useState([]);
            const [sortColumn, setSortColumn] = useState('trader');
            const [sortDirection, setSortDirection] = useState('asc');
            const [showFilters, setShowFilters] = useState(false);
            const [filters, setFilters] = useState({});
            const [savedFilters, setSavedFilters] = useState([]);
            const [filterName, setFilterName] = useState('');
            const [firebaseStatus, setFirebaseStatus] = useState('checking');
            const previousDataRef = useRef(null);
            const [newData, setNewData] = useState({
                dataType: 'snapshot',
                date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                trader: '', account: 'Virtual', equity: '', amount: '', transactionType: 'DEPOSIT', note: ''
            });

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.firebaseReady) {
                        setTimeout(initFirebase, 100);
                        return;
                    }
                    const { collection, onSnapshot, query, orderBy } = window.firebaseUtils;
                    const db = window.firebaseDb;
                    
                    onSnapshot(query(collection(db, 'transactions'), orderBy('date', 'desc')), (snapshot) => {
                        setTransactions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setFirebaseStatus('connected');
                    }, (error) => {
                        console.error('Firebase error:', error);
                        setFirebaseStatus('disconnected');
                    });
                    
                    onSnapshot(query(collection(db, 'snapshots'), orderBy('date', 'desc')), (snapshot) => {
                        setSnapshots(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });

                    onSnapshot(query(collection(db, 'filter_views')), (snapshot) => {
                        setSavedFilters(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });

                    onSnapshot(query(collection(db, 'alerts'), orderBy('timestamp', 'desc')), (snapshot) => {
                        setAlerts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                };
                initFirebase();

                const healthCheck = setInterval(async () => {
                    try {
                        if (!window.firebaseReady) {
                            setFirebaseStatus('disconnected');
                            return;
                        }
                        const { collection, addDoc } = window.firebaseUtils;
                        const db = window.firebaseDb;
                        await addDoc(collection(db, '_healthcheck'), {
                            timestamp: new Date().toISOString(),
                            securityKey: window.SECURITY_KEY
                        });
                        setFirebaseStatus('connected');
                    } catch (error) {
                        console.error('Health check failed:', error);
                        setFirebaseStatus(error.code === 'permission-denied' ? 'readonly' : 'disconnected');
                    }
                }, 30000);

                return () => clearInterval(healthCheck);
            }, []);

            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                const parts = dateStr.split('.');
                if (parts.length === 3) return new Date(parts[0], parts[1] - 1, parts[2]);
                return new Date(dateStr);
            };

            const daysBetween = (d1, d2) => {
                const date1 = parseDate(d1), date2 = parseDate(d2);
                return date1 && date2 ? Math.floor((date1 - date2) / (1000 * 60 * 60 * 24)) : 0;
            };

            const weightedAverage = (snaps, days = 14) => {
                if (!snaps.length) return 0;
                const sorted = [...snaps].sort((a, b) => parseDate(b.date) - parseDate(a.date));
                const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
                const recent = sorted.filter(s => parseDate(s.date) >= cutoff && s.plPerDay !== 0);
                if (!recent.length) return 0;
                let sum = 0, totalW = 0;
                for (let i = 0; i < Math.min(recent.length, days); i++) {
                    const w = Math.exp(-i / 5);
                    sum += recent[i].plPerDay * w;
                    totalW += w;
                }
                return totalW > 0 ? sum / totalW : 0;
            };

            const getTradeDecision = (row) => {
                if (row.daysSinceStart < 30 || !row.estDailyPL) return 'NO_DATA';
                if (row.recoveryFactor < 1.5 && row.maxDrawdown > 25) return 'SELL';
                if (row.estDailyPL < 0 && row.currentDailyPL3pt !== null && row.currentDailyPL3pt < 0) return 'SELL';
                if (row.currentDrawdown > 25) return 'SELL';
                if (row.plPercent < -10) return 'SELL';
                if (
                    row.estDailyPL >= 900 &&
                    row.plPercent >= 14 &&
                    row.recoveryFactor >= 2.5 &&
                    row.currentDrawdown < 15 &&
                    row.maxDrawdown < 25
                ) return 'BUY';
                return 'HOLD';
            };

            const getWarnings = (row) => {
                const warnings = [];
                if (row.currentDrawdown > 20) warnings.push('High DD');
                if (row.estDailyPL < 0) warnings.push('Declining');
                if (row.daysSinceStart < 30) warnings.push('Low Data');
                return warnings;
            };

            // NEW: Activity Detection
            const getTraderActivityStatus = (trader, account, snapshotsWithCalcs) => {
                try {
                    const last30Snaps = snapshotsWithCalcs
                        .filter(s => s.trader === trader && s.account === account)
                        .sort((a, b) => parseDate(b.date) - parseDate(a.date))
                        .slice(0, 30);
                    
                    if (last30Snaps.length < 10) return {
                        status: 'INSUFFICIENT_DATA',
                        color: 'text-slate-500',
                        metrics: { avgAbsDailyPL: '0', activityRatio: '0%' }
                    };
                    
                    const dailyPLs = last30Snaps.map(s => s.plPerDay || 0).filter(pl => pl !== 0);
                    if (dailyPLs.length === 0) return {
                        status: 'INSUFFICIENT_DATA',
                        color: 'text-slate-500',
                        metrics: { avgAbsDailyPL: '0', activityRatio: '0%' }
                    };
                    
                    const avgAbsPL = dailyPLs.reduce((sum, pl) => sum + Math.abs(pl), 0) / dailyPLs.length;
                    
                    let significantChangeDays = 0;
                    for (let i = 0; i < last30Snaps.length - 1; i++) {
                        const change = Math.abs(last30Snaps[i].equity - last30Snaps[i+1].equity);
                        const changePercent = last30Snaps[i+1].equity > 0 ? (change / last30Snaps[i+1].equity) * 100 : 0;
                        if (changePercent > 0.1) significantChangeDays++;
                    }
                    const activityRatio = last30Snaps.length > 1 ? significantChangeDays / (last30Snaps.length - 1) : 0;
                    
                    const zeroDays = dailyPLs.filter(pl => Math.abs(pl) < 10).length;
                    const zeroRatio = zeroDays / dailyPLs.length;
                    
                    let status, color;
                    if (zeroRatio > 0.7) {
                        status = 'DORMANT';
                        color = 'text-blue-400';
                    } else if (avgAbsPL < 100) {
                        status = 'LOW_ACTIVITY';
                        color = 'text-yellow-400';
                    } else if (avgAbsPL < 300) {
                        status = 'MODERATE';
                        color = 'text-green-400';
                    } else if (avgAbsPL < 800) {
                        status = 'ACTIVE';
                        color = 'text-emerald-400';
                    } else {
                        status = 'VERY_ACTIVE';
                        color = 'text-violet-400';
                    }
                    
                    return {
                        status,
                        color,
                        metrics: {
                            avgAbsDailyPL: avgAbsPL.toFixed(0),
                            activityRatio: (activityRatio * 100).toFixed(0) + '%'
                        }
                    };
                } catch (e) {
                    console.error('Activity detection error:', e);
                    return {
                        status: 'ERROR',
                        color: 'text-red-500',
                        metrics: { avgAbsDailyPL: '0', activityRatio: '0%' }
                    };
                }
            };

            // NEW: Entry Signal
            const getEntrySignal = (row) => {
                if (row.daysSinceStart < 30) return {
                    type: 'NO_ENTRY',
                    strength: 'NONE',
                    color: 'bg-gray-600',
                    icon: '‚õî'
                };
                
                const conservativeScore = 
                    (row.daysSinceStart >= 90 ? 1 : 0) +
                    (row.estDailyPL >= 800 ? 1 : 0) +
                    (row.plPercent >= 15 ? 1 : 0) +
                    (row.recoveryFactor >= 2.5 ? 1 : 0) +
                    (row.maxDrawdown <= 20 ? 1 : 0) +
                    (row.currentDrawdown <= 10 ? 1 : 0) +
                    (row.avgDrawdown <= 12 ? 1 : 0) +
                    (row.currentDailyPL3pt > 500 ? 1 : 0);
                
                if (conservativeScore >= 7) return {
                    type: 'CONSERVATIVE_ENTRY',
                    strength: 'STRONG',
                    amount: 'LARGE',
                    color: 'bg-emerald-600',
                    icon: 'üíé'
                };
                
                const balancedScore = 
                    (row.daysSinceStart >= 60 ? 1 : 0) +
                    (row.estDailyPL >= 500 ? 1 : 0) +
                    (row.plPercent >= 10 ? 1 : 0) +
                    (row.recoveryFactor >= 2.0 ? 1 : 0) +
                    (row.maxDrawdown <= 25 ? 1 : 0) +
                    (row.currentDrawdown <= 15 ? 1 : 0) +
                    (row.currentDailyPL3pt > 200 ? 1 : 0);
                
                if (balancedScore >= 6) return {
                    type: 'BALANCED_ENTRY',
                    strength: 'MODERATE',
                    amount: 'MEDIUM',
                    color: 'bg-blue-600',
                    icon: '‚öñÔ∏è'
                };
                
                const aggressiveScore = 
                    (row.daysSinceStart >= 30 ? 1 : 0) +
                    (row.estDailyPL >= 1200 ? 1 : 0) +
                    (row.plPercent >= 8 ? 1 : 0) +
                    (row.recoveryFactor >= 1.5 ? 1 : 0) +
                    (row.maxDrawdown <= 35 ? 1 : 0) +
                    (row.currentDrawdown <= 20 ? 1 : 0) +
                    (row.currentDailyPL3pt > 800 ? 1 : 0) +
                    (row.warnings.length === 0 ? 1 : 0);
                
                if (aggressiveScore >= 6) return {
                    type: 'AGGRESSIVE_ENTRY',
                    strength: 'SPECULATIVE',
                    amount: 'SMALL',
                    color: 'bg-purple-600',
                    icon: 'üöÄ'
                };
                
                return {
                    type: 'NO_ENTRY',
                    strength: 'NONE',
                    color: 'bg-gray-600',
                    icon: '‚õî'
                };
            };

            // NEW: Exit Signal
            const getExitSignal = (row) => {
                if (
                    row.currentDrawdown >= 30 ||
                    row.plPercent <= -15 ||
                    (row.estDailyPL < -500 && row.currentDailyPL3pt < -500) ||
                    row.recoveryFactor < 0.8 ||
                    (row.currentDrawdown > 20 && row.estDailyPL < 0)
                ) return {
                    type: 'EMERGENCY_EXIT',
                    urgency: 'IMMEDIATE',
                    color: 'bg-red-700',
                    icon: 'üö®',
                    pulse: true
                };
                
                if (
                    (row.estDailyPL < 0 && row.daysSinceStart > 30) ||
                    (row.recoveryFactor < 1.5 && row.maxDrawdown > 25) ||
                    row.currentDrawdown > 18
                ) return {
                    type: 'PLANNED_EXIT',
                    urgency: 'MODERATE',
                    color: 'bg-orange-600',
                    icon: '‚ö†Ô∏è',
                    pulse: false
                };
                
                if (
                    row.plPercent >= 50 ||
                    (row.plPercent >= 30 && row.currentDrawdown > 15)
                ) return {
                    type: 'PROFIT_TAKING',
                    urgency: 'OPTIONAL',
                    color: 'bg-yellow-600',
                    icon: 'üí∞',
                    pulse: false
                };
                
                return null;
            };

            // NEW: Action Signal
            const getActionSignal = (row) => {
                if (
                    row.plPercent >= 15 && row.plPercent < 40 &&
                    row.estDailyPL >= 800 &&
                    row.currentDailyPL3pt > row.dailyPLSinceStart * 1.2 &&
                    row.currentDrawdown <= 10 &&
                    row.recoveryFactor >= 2.5 &&
                    row.warnings.length === 0
                ) return {
                    type: 'INCREASE',
                    color: 'bg-green-600',
                    icon: 'üìà'
                };
                
                if (
                    row.plPercent >= 0 && row.plPercent < 30 &&
                    row.currentDrawdown <= 15 &&
                    row.estDailyPL >= 0 &&
                    row.recoveryFactor >= 1.8
                ) return {
                    type: 'HOLD',
                    color: 'bg-slate-600',
                    icon: '‚úã'
                };
                
                if (
                    row.currentDrawdown > 20 ||
                    row.recoveryFactor < 1.5 ||
                    row.estDailyPL < -200
                ) return {
                    type: 'REDUCE',
                    color: 'bg-orange-600',
                    icon: 'üìâ'
                };
                
                return {
                    type: 'MONITOR',
                    color: 'bg-slate-500',
                    icon: 'üëÅÔ∏è'
                };
            };

            // NEW: RF Assessment
            const getRFAssessment = (row) => {
                try {
                    const rf = row.recoveryFactor || 0;
                    if (rf < 0.5) return { grade: 'F', label: 'CATASTROPHIC', color: 'text-red-900 bg-red-100', icon: 'üíÄ' };
                    if (rf < 1.0) return { grade: 'D', label: 'VERY_WEAK', color: 'text-red-700 bg-red-50', icon: 'üî¥' };
                    if (rf < 1.5) return { grade: 'C-', label: 'WEAK', color: 'text-orange-600 bg-orange-50', icon: 'üü†' };
                    if (rf < 2.0) return { grade: 'C', label: 'ACCEPTABLE', color: 'text-yellow-600 bg-yellow-50', icon: 'üü°' };
                    if (rf < 2.5) return { grade: 'B', label: 'GOOD', color: 'text-green-600 bg-green-50', icon: 'üü¢' };
                    if (rf < 3.5) return { grade: 'A', label: 'EXCELLENT', color: 'text-emerald-600 bg-emerald-50', icon: '‚úÖ' };
                    return { grade: 'S', label: 'EXCEPTIONAL', color: 'text-violet-700 bg-violet-50', icon: 'üíé' };
                } catch (e) {
                    console.error('RF assessment error:', e);
                    return { grade: 'N/A', label: 'ERROR', color: 'text-slate-500 bg-slate-100', icon: '?' };
                }
            };

            // NEW: DD Assessment
            const getDDAssessment = (row) => {
                try {
                    const currentDrawdown = row.currentDrawdown || 0;
                    const maxDrawdown = row.maxDrawdown || 0;
                    
                    let currentLevel, maxLevel, overallRisk;
                    
                    if (currentDrawdown <= 5) currentLevel = { label: 'EXCELLENT', color: 'text-emerald-500' };
                    else if (currentDrawdown <= 10) currentLevel = { label: 'GOOD', color: 'text-green-500' };
                    else if (currentDrawdown <= 15) currentLevel = { label: 'MODERATE', color: 'text-yellow-500' };
                    else if (currentDrawdown <= 20) currentLevel = { label: 'HIGH', color: 'text-orange-500' };
                    else if (currentDrawdown <= 25) currentLevel = { label: 'DANGEROUS', color: 'text-red-500' };
                    else if (currentDrawdown <= 30) currentLevel = { label: 'CRITICAL', color: 'text-red-600' };
                    else currentLevel = { label: 'CATASTROPHIC', color: 'text-red-800' };
                    
                    if (maxDrawdown <= 15) maxLevel = { label: 'LOW_RISK', color: 'text-emerald-500' };
                    else if (maxDrawdown <= 25) maxLevel = { label: 'MEDIUM_RISK', color: 'text-yellow-500' };
                    else if (maxDrawdown <= 35) maxLevel = { label: 'HIGH_RISK', color: 'text-orange-500' };
                    else maxLevel = { label: 'VERY_HIGH_RISK', color: 'text-red-600' };
                    
                    if (currentDrawdown < 10 && maxDrawdown < 15) overallRisk = 'SAFE';
                    else if (currentDrawdown < 20 && maxDrawdown < 25) overallRisk = 'ACCEPTABLE';
                    else if (currentDrawdown < 30 && maxDrawdown < 35) overallRisk = 'RISKY';
                    else overallRisk = 'DANGEROUS';
                    
                    return { currentLevel, maxLevel, overallRisk };
                } catch (e) {
                    console.error('DD assessment error:', e);
                    return {
                        currentLevel: { label: 'ERROR', color: 'text-slate-500' },
                        maxLevel: { label: 'ERROR', color: 'text-slate-500' },
                        overallRisk: 'UNKNOWN'
                    };
                }
            };

            // NEW: Trigger Detection
            const detectTriggers = (row, previousRow) => {
                if (!previousRow) return [];
                
                const triggers = [];
                
                if (row.currentDrawdown >= 25 && previousRow.currentDrawdown < 25) {
                    triggers.push({
                        level: 'CRITICAL',
                        type: 'DD_THRESHOLD',
                        icon: 'üö®',
                        message: `DD reached critical 25% (was ${previousRow.currentDrawdown.toFixed(1)}%)`,
                        color: 'bg-red-600'
                    });
                }
                
                if (row.plPercent <= -10 && previousRow.plPercent > -10) {
                    triggers.push({
                        level: 'CRITICAL',
                        type: 'LOSS_THRESHOLD',
                        icon: 'üö®',
                        message: `Total loss exceeded -10% (was ${previousRow.plPercent.toFixed(1)}%)`,
                        color: 'bg-red-600'
                    });
                }
                
                if (row.currentDrawdown > previousRow.currentDrawdown + 5) {
                    triggers.push({
                        level: 'WARNING',
                        type: 'DD_SPIKE',
                        icon: '‚ö†Ô∏è',
                        message: `DD increased by ${(row.currentDrawdown - previousRow.currentDrawdown).toFixed(1)}%`,
                        color: 'bg-orange-600'
                    });
                }
                
                if (row.estDailyPL < 0 && previousRow.estDailyPL >= 0) {
                    triggers.push({
                        level: 'WARNING',
                        type: 'TREND_REVERSAL',
                        icon: '‚ö†Ô∏è',
                        message: 'Smart Pred turned negative',
                        color: 'bg-orange-600'
                    });
                }
                
                if (row.recoveryFactor < 1.5 && previousRow.recoveryFactor >= 1.5) {
                    triggers.push({
                        level: 'WARNING',
                        type: 'RF_DECLINE',
                        icon: '‚ö†Ô∏è',
                        message: `RF dropped below 1.5 (was ${previousRow.recoveryFactor.toFixed(2)})`,
                        color: 'bg-orange-600'
                    });
                }
                
                if (row.plPercent >= 30 && previousRow.plPercent < 30) {
                    triggers.push({
                        level: 'OPPORTUNITY',
                        type: 'PROFIT_MILESTONE',
                        icon: 'üí∞',
                        message: '30% profit reached',
                        color: 'bg-yellow-600'
                    });
                }
                
                return triggers;
            };

            const snapshotsWithCalcs = useMemo(() => {
                const sorted = [...snapshots].sort((a, b) => `${b.trader}-${b.account}-${b.date}`.localeCompare(`${a.trader}-${a.account}-${a.date}`));
                const byKey = {};
                sorted.forEach(s => {
                    const k = `${s.trader}-${s.account}`;
                    if (!byKey[k]) byKey[k] = [];
                    byKey[k].push(s);
                });
                Object.values(byKey).forEach(snaps => {
                    snaps.sort((a, b) => parseDate(a.date) - parseDate(b.date));
                    let maxEq = 0;
                    snaps.forEach(s => {
                        maxEq = Math.max(maxEq, s.equity);
                        s.runningMaxEquity = maxEq;
                        s.currentDrawdown = maxEq > 0 ? ((maxEq - s.equity) / maxEq) * 100 : 0;
                    });
                });
                return sorted.map((snap, i) => {
                    const prev = sorted.slice(i + 1).find(s => s.trader === snap.trader && s.account === snap.account);
                    const flow = transactions.filter(t => t.trader === snap.trader && t.account === snap.account &&
                        (!prev || parseDate(t.date) > parseDate(prev.date)) && parseDate(t.date) <= parseDate(snap.date)
                    ).reduce((sum, t) => sum + (t.type === 'DEPOSIT' ? t.amount : t.type === 'WITHDRAWAL' ? -t.amount : 0), 0);
                    const pnl = snap.equity - (prev ? prev.equity : 0) - flow;
                    const days = prev ? daysBetween(snap.date, prev.date) : 0;
                    return { ...snap, prevDate: prev?.date || '', flowSinceLast: flow, prevEquity: prev?.equity || 0, pnlPeriod: pnl, daysSincePrev: days, plPerDay: days > 0 ? pnl / days : 0 };
                });
            }, [snapshots, transactions]);

            const dashboardData = useMemo(() => {
                const pairs = new Map();
                snapshotsWithCalcs.forEach(s => {
                    const k = `${s.trader}-${s.account}`;
                    if (!pairs.has(k) || parseDate(s.date) > parseDate(pairs.get(k).date)) pairs.set(k, s);
                });
                let data = Array.from(pairs.values()).map(s => {
                    const txs = transactions.filter(t => t.trader === s.trader && t.account === s.account);
                    const netInv = txs.reduce((sum, t) => sum + (t.type === 'DEPOSIT' ? t.amount : t.type === 'WITHDRAWAL' ? -t.amount : 0), 0);
                    const pl = s.equity - netInv;
                    const plPct = netInv > 0 ? (pl / netInv) * 100 : 0;
                    const firstDate = txs.length ? txs.reduce((e, t) => parseDate(t.date) < parseDate(e.date) ? t : e).date : s.date;
                    const days = daysBetween(new Date().toISOString().split('T')[0].replace(/-/g, '.'), firstDate) + 1;
                    const tSnaps = snapshotsWithCalcs.filter(x => x.trader === s.trader && x.account === s.account).sort((a, b) => parseDate(b.date) - parseDate(a.date));
                    const last3 = tSnaps.slice(0, 3).filter(x => x.plPerDay !== 0);
                    const dds = tSnaps.map(x => x.currentDrawdown || 0).filter(d => d > 0);
                    const row = {
                        trader: s.trader, account: s.account, latestDate: s.date, equity: s.equity, netInvested: netInv, pl, plPercent: plPct,
                        currentDailyPL3pt: last3.length ? last3.reduce((sum, x) => sum + x.plPerDay, 0) / last3.length : null,
                        currentDailyPL3ptDays: last3.length, dailyPLSinceStart: days > 0 ? pl / days : 0,
                        estDailyPL: weightedAverage(tSnaps), dailyPlPercentSinceStart: days > 0 ? plPct / days : 0, daysSinceStart: days,
                        currentDrawdown: s.currentDrawdown || 0, maxDrawdown: dds.length ? Math.max(...dds) : 0,
                        avgDrawdown: dds.length ? dds.reduce((a, b) => a + b, 0) / dds.length : 0,
                        recoveryFactor: dds.length && Math.max(...dds) > 0 ? plPct / Math.max(...dds) : 0
                    };
                    row.warnings = getWarnings(row);
                    row.decision = getTradeDecision(row);
                    
                    // NEW: Add all new assessments with safe defaults
                    try {
                        row.activityInfo = getTraderActivityStatus(row.trader, row.account, snapshotsWithCalcs);
                    } catch (e) {
                        console.error('Activity status error:', e);
                        row.activityInfo = {
                            status: 'INSUFFICIENT_DATA',
                            color: 'text-slate-500',
                            metrics: { avgAbsDailyPL: '0', activityRatio: '0%' }
                        };
                    }
                    
                    try {
                        row.entrySignal = getEntrySignal(row);
                    } catch (e) {
                        console.error('Entry signal error:', e);
                        row.entrySignal = { type: 'NO_ENTRY', strength: 'NONE', color: 'bg-gray-600', icon: '‚õî' };
                    }
                    
                    try {
                        row.exitSignal = getExitSignal(row);
                    } catch (e) {
                        console.error('Exit signal error:', e);
                        row.exitSignal = null;
                    }
                    
                    try {
                        row.actionSignal = getActionSignal(row);
                    } catch (e) {
                        console.error('Action signal error:', e);
                        row.actionSignal = { type: 'MONITOR', color: 'bg-slate-500', icon: 'üëÅÔ∏è' };
                    }
                    
                    try {
                        row.rfAssessment = getRFAssessment(row);
                    } catch (e) {
                        console.error('RF assessment error:', e);
                        row.rfAssessment = { grade: 'N/A', label: 'UNKNOWN', color: 'text-slate-500 bg-slate-100', icon: '?' };
                    }
                    
                    try {
                        row.ddAssessment = getDDAssessment(row);
                    } catch (e) {
                        console.error('DD assessment error:', e);
                        row.ddAssessment = {
                            currentLevel: { label: 'UNKNOWN', color: 'text-slate-500' },
                            maxLevel: { label: 'UNKNOWN', color: 'text-slate-500' },
                            overallRisk: 'UNKNOWN'
                        };
                    }
                    
                    try {
                        const prevRow = previousDataRef.current?.find(p => p.trader === row.trader && p.account === row.account);
                        row.triggers = detectTriggers(row, prevRow);
                    } catch (e) {
                        console.error('Trigger detection error:', e);
                        row.triggers = [];
                    }
                    
                    return row;
                });
                
                data = accountFilter === 'All' ? data : data.filter(d => d.account === accountFilter);
                Object.keys(filters).forEach(col => {
                    const f = filters[col];
                    if (f?.enabled) {
                        data = data.filter(row => {
                            if (f.type === 'range') {
                                const min = f.min !== '' ? parseFloat(f.min) : -Infinity;
                                const max = f.max !== '' ? parseFloat(f.max) : Infinity;
                                return row[col] >= min && row[col] <= max;
                            }
                            if (f.type === 'text') return row[col].toLowerCase().includes(f.value.toLowerCase());
                            if (f.type === 'select') {
                                if (col === 'decision') return row.decision === f.value;
                                if (col === 'warnings') return f.value === 'Has Warning' ? row.warnings.length > 0 : row.warnings.length === 0;
                                if (col === 'entrySignal') return row.entrySignal && row.entrySignal.type === f.value;
                                if (col === 'exitSignal') return row.exitSignal && row.exitSignal.urgency === f.value;
                                if (col === 'actionSignal') return row.actionSignal && row.actionSignal.type === f.value;
                                if (col === 'rfGrade') return row.rfAssessment && row.rfAssessment.grade === f.value;
                                if (col === 'ddRisk') return row.ddAssessment && row.ddAssessment.overallRisk === f.value;
                                if (col === 'activity') return row.activityInfo && row.activityInfo.status === f.value;
                            }
                            return true;
                        });
                    }
                });
                data.sort((a, b) => {
                    let av = a[sortColumn], bv = b[sortColumn];
                    if (sortColumn === 'warnings') {
                        av = a.warnings.length;
                        bv = b.warnings.length;
                    }
                    if (typeof av === 'string') return sortDirection === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
                    if (av === null) av = -Infinity;
                    if (bv === null) bv = -Infinity;
                    return sortDirection === 'asc' ? av - bv : bv - av;
                });
                
                previousDataRef.current = data;
                return data;
            }, [snapshotsWithCalcs, transactions, accountFilter, filters, sortColumn, sortDirection]);

            // Create alerts for triggers
            useEffect(() => {
                dashboardData.forEach(row => {
                    if (row.triggers && Array.isArray(row.triggers) && row.triggers.length > 0) {
                        row.triggers.forEach(async trigger => {
                            if (trigger && (trigger.level === 'CRITICAL' || trigger.level === 'WARNING')) {
                                try {
                                    const { collection, addDoc } = window.firebaseUtils;
                                    const db = window.firebaseDb;
                                    await addDoc(collection(db, 'alerts'), {
                                        trader: row.trader,
                                        account: row.account,
                                        level: trigger.level,
                                        type: trigger.type,
                                        message: trigger.message,
                                        timestamp: new Date().toISOString(),
                                        read: false,
                                        securityKey: window.SECURITY_KEY
                                    });
                                } catch (e) {
                                    console.error('Alert creation failed:', e);
                                }
                            }
                        });
                    }
                });
            }, [dashboardData]);

            const totals = useMemo(() => ({
                pl: dashboardData.reduce((s, d) => s + d.pl, 0),
                dailyPLSinceStart: dashboardData.reduce((s, d) => s + d.dailyPLSinceStart, 0),
                estDailyPL: dashboardData.reduce((s, d) => s + d.estDailyPL, 0)
            }), [dashboardData]);

            const signalSummary = useMemo(() => ({
                strongEntry: dashboardData.filter(d => d.entrySignal && d.entrySignal.type === 'CONSERVATIVE_ENTRY').length,
                exitAlerts: dashboardData.filter(d => d.exitSignal && d.exitSignal.urgency === 'IMMEDIATE').length,
                increaseCandidates: dashboardData.filter(d => d.actionSignal && d.actionSignal.type === 'INCREASE').length,
                activeTriggers: dashboardData.reduce((sum, d) => sum + (d.triggers?.length || 0), 0)
            }), [dashboardData]);

            const traderNames = useMemo(() => [...new Set(transactions.map(t => t.trader))].sort(), [transactions]);

            const handleSort = (col) => {
                if (sortColumn === col) setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                else { setSortColumn(col); setSortDirection('asc'); }
            };

            const updateFilter = (col, data) => setFilters(prev => ({ ...prev, [col]: data }));
            const clearFilters = () => setFilters({});
            
            const saveFilterView = async () => {
                if (!filterName.trim()) return alert('Enter filter name');
                try {
                    const { collection, addDoc } = window.firebaseUtils;
                    const db = window.firebaseDb;
                    await addDoc(collection(db, 'filter_views'), {
                        name: filterName,
                        filters,
                        timestamp: new Date().toISOString(),
                        securityKey: window.SECURITY_KEY
                    });
                    setFilterName('');
                    alert(`Filter "${filterName}" saved to Firebase!`);
                } catch (e) {
                    alert('Save failed: ' + e.message);
                }
            };
            
            const loadFilterView = (v) => setFilters(v.filters);
            
            const deleteFilterView = async (id, name) => {
                if (!confirm(`Delete "${name}"?`)) return;
                try {
                    const { deleteDoc, doc } = window.firebaseUtils;
                    await deleteDoc(doc(window.firebaseDb, 'filter_views', id));
                } catch (e) {
                    alert('Delete failed: ' + e.message);
                }
            };

            const dismissAlert = async (id) => {
                try {
                    const { deleteDoc, doc } = window.firebaseUtils;
                    await deleteDoc(doc(window.firebaseDb, 'alerts', id));
                } catch (e) {
                    alert('Dismiss failed: ' + e.message);
                }
            };

            const deleteTransaction = async (id, trader, date) => {
                if (!confirm(`Delete transaction for ${trader} on ${date}?`)) return;
                try {
                    const { deleteDoc, doc } = window.firebaseUtils;
                    await deleteDoc(doc(window.firebaseDb, 'transactions', id));
                } catch (e) {
                    alert('Delete failed: ' + e.message);
                }
            };

            const deleteSnapshot = async (id, trader, date) => {
                if (!confirm(`Delete snapshot for ${trader} on ${date}?`)) return;
                try {
                    const { deleteDoc, doc } = window.firebaseUtils;
                    await deleteDoc(doc(window.firebaseDb, 'snapshots', id));
                } catch (e) {
                    alert('Delete failed: ' + e.message);
                }
            };

            const getDecisionStyle = (decision) => {
                switch(decision) {
                    case 'BUY': return { bg: 'bg-green-600', text: '‚ñ≤ BUY' };
                    case 'SELL': return { bg: 'bg-red-600', text: '‚ñº SELL' };
                    case 'HOLD': return { bg: 'bg-yellow-600', text: '‚óè HOLD' };
                    default: return { bg: 'bg-slate-600', text: '- N/A' };
                }
            };

            const getRowClasses = (row) => {
                const classes = ['border-b', 'border-slate-700/50', 'hover:bg-slate-700/30'];
                
                if (row.exitSignal && row.exitSignal.urgency === 'IMMEDIATE') {
                    classes.push('bg-red-900/20', 'border-l-4', 'border-l-red-600');
                } else if (row.entrySignal && row.entrySignal.type === 'CONSERVATIVE_ENTRY') {
                    classes.push('bg-emerald-900/10', 'border-l-4', 'border-l-emerald-600');
                } else if (row.exitSignal && row.exitSignal.urgency === 'MODERATE') {
                    classes.push('bg-orange-900/10', 'border-l-4', 'border-l-orange-600');
                }
                
                return classes.join(' ');
            };

            const addData = async () => {
                try {
                    const { collection, addDoc } = window.firebaseUtils;
                    const db = window.firebaseDb;
                    if (newData.dataType === 'snapshot' && newData.trader && newData.equity) {
                        await addDoc(collection(db, 'snapshots'), {
                            date: newData.date, trader: newData.trader, account: newData.account,
                            equity: parseFloat(newData.equity), securityKey: window.SECURITY_KEY, timestamp: new Date().toISOString()
                        });
                    } else if (newData.trader && newData.amount) {
                        await addDoc(collection(db, 'transactions'), {
                            date: newData.date, trader: newData.trader, account: newData.account,
                            amount: parseFloat(newData.amount), type: newData.transactionType,
                            note: newData.note, securityKey: window.SECURITY_KEY, timestamp: new Date().toISOString()
                        });
                    }
                    setNewData({ dataType: 'snapshot', date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                        trader: '', account: 'Virtual', equity: '', amount: '', transactionType: 'DEPOSIT', note: '' });
                    setShowAddData(false);
                } catch (e) { alert('Failed!'); }
            };

            const getHeatmap = (v, vals) => {
                if (!vals.length) return 'bg-slate-600';
                const valid = vals.filter(x => !isNaN(x) && isFinite(x));
                if (!valid.length) return 'bg-slate-600';
                const min = Math.min(...valid), max = Math.max(...valid);
                if (min === max) return v >= 0 ? 'bg-green-500' : 'bg-red-500';
                const norm = (v - min) / (max - min);
                const cols = ['bg-red-900', 'bg-red-800', 'bg-red-700', 'bg-red-600', 'bg-red-500', 'bg-green-500', 'bg-green-600', 'bg-green-700', 'bg-green-800', 'bg-green-900'];
                return cols[Math.max(0, Math.min(cols.length - 1, Math.floor(norm * (cols.length - 1))))];
            };

            const getDD = (v, vals) => {
                if (!vals.length) return 'bg-slate-600';
                const valid = vals.filter(x => !isNaN(x) && isFinite(x));
                if (!valid.length) return 'bg-slate-600';
                const min = Math.min(...valid), max = Math.max(...valid);
                if (min === max) return v <= 5 ? 'bg-green-500' : 'bg-red-500';
                const norm = 1 - ((v - min) / (max - min));
                const cols = ['bg-red-900', 'bg-red-800', 'bg-red-700', 'bg-red-600', 'bg-red-500', 'bg-green-500', 'bg-green-600', 'bg-green-700', 'bg-green-800', 'bg-green-900'];
                return cols[Math.max(0, Math.min(cols.length - 1, Math.floor(norm * (cols.length - 1))))];
            };

            const getBorder = (d) => d === 3 ? 'border-l-green-500' : d === 2 ? 'border-l-yellow-500' : d === 1 ? 'border-l-orange-500' : '';

            const vals = { pl: dashboardData.map(d => d.pl), plPct: dashboardData.map(d => d.plPercent),
                daily: dashboardData.map(d => d.currentDailyPL3pt).filter(v => v !== null),
                dailyStart: dashboardData.map(d => d.dailyPLSinceStart), est: dashboardData.map(d => d.estDailyPL),
                dailyPct: dashboardData.map(d => d.dailyPlPercentSinceStart), curr: dashboardData.map(d => d.currentDrawdown),
                max: dashboardData.map(d => d.maxDrawdown), avg: dashboardData.map(d => d.avgDrawdown),
                rec: dashboardData.map(d => d.recoveryFactor) };

            const exportXLSX = (type) => {
                const wb = XLSX.utils.book_new();
                if (type === 'all' || type === 'transactions') {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(transactions.map(t => ({
                        Date: t.date, Trader: t.trader, Account: t.account, Amount: t.amount, Type: t.type, Note: t.note
                    }))), 'Transactions');
                }
                if (type === 'all' || type === 'snapshots') {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(snapshotsWithCalcs.map(s => ({
                        Date: s.date, Trader: s.trader, Account: s.account, Equity: s.equity, Max: s.runningMaxEquity,
                        DD: s.currentDrawdown, PrevDate: s.prevDate, Flow: s.flowSinceLast, PrevEq: s.prevEquity,
                        PnL: s.pnlPeriod, Days: s.daysSincePrev, PLperDay: s.plPerDay
                    }))), 'Snapshots');
                }
                if (type === 'all' || type === 'dashboard') {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dashboardData.map(d => ({
                        Trader: d.trader, Account: d.account, Date: d.latestDate, Equity: d.equity, NetInv: d.netInvested,
                        PL: d.pl, PLPct: d.plPercent, RecentPL: d.currentDailyPL3pt,
                        Days: d.currentDailyPL3ptDays, DailyStart: d.dailyPLSinceStart, Smart: d.estDailyPL,
                        DailyPct: d.dailyPlPercentSinceStart, CurrDD: d.currentDrawdown, MaxDD: d.maxDrawdown, 
                        AvgDD: d.avgDrawdown, RecFac: d.recoveryFactor, 
                        Activity: d.activityInfo?.status || 'N/A', 
                        ActivityPL: d.activityInfo?.metrics?.avgAbsDailyPL || '0',
                        RF_Grade: d.rfAssessment?.grade || 'N/A', 
                        DD_Risk: d.ddAssessment?.overallRisk || 'N/A',
                        Entry_Signal: d.entrySignal?.type || 'NONE', 
                        Exit_Signal: d.exitSignal?.type || 'NONE',
                        Action: d.actionSignal?.type || 'NONE', 
                        Triggers: d.triggers?.length || 0,
                        Warnings: d.warnings.join(', '), Decision: d.decision
                    }))), 'Dashboard');
                }
                XLSX.writeFile(wb, `etoro_advanced_${type}_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-6">
                    <div className="max-w-full mx-auto">
                        <div className="mb-8">
                            <div className="flex justify-between items-center mb-2">
                                <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
                                    eToro Advanced Decision Dashboard v11
                                </h1>
                                <div className="flex gap-4 items-center">
                                    <AlertPanel alerts={alerts} onDismiss={dismissAlert} />
                                    <FirebaseStatus status={firebaseStatus} />
                                </div>
                            </div>
                            <p className="text-slate-400">Real-time Analytics - {transactions.length} txs, {snapshots.length} snaps, {alerts.filter(a => !a.read).length} alerts</p>
                        </div>

                        <div className="flex gap-2 mb-6 flex-wrap">
                            {['dashboard', 'transactions', 'snapshots'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)}
                                    className={`px-6 py-3 rounded-lg font-semibold ${activeTab === tab ? 'bg-blue-600 shadow-lg' : 'bg-slate-800 hover:bg-slate-700'}`}>
                                    {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                </button>
                            ))}
                        </div>

                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                {/* Performance Summary */}
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Total P/L</div>
                                        <div className={`text-2xl font-bold ${totals.pl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {totals.pl.toFixed(0)} Ft
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Daily P/L Since Start</div>
                                        <div className={`text-2xl font-bold ${totals.dailyPLSinceStart >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {totals.dailyPLSinceStart.toFixed(0)} Ft
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Avg Max DD</div>
                                        <div className="text-2xl font-bold text-orange-400">
                                            {dashboardData.length ? (dashboardData.reduce((s, d) => s + d.maxDrawdown, 0) / dashboardData.length).toFixed(2) : '0.00'}%
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Active Traders</div>
                                        <div className="text-2xl font-bold text-blue-400">{dashboardData.length}</div>
                                    </div>
                                </div>

                                {/* Signal Summary */}
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-slate-800 rounded-xl p-4 border border-emerald-700">
                                        <div className="text-slate-400 text-xs mb-1">üíé Strong Entry Signals</div>
                                        <div className="text-2xl font-bold text-emerald-400">
                                            {signalSummary.strongEntry}
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-red-700">
                                        <div className="text-slate-400 text-xs mb-1">üö® Exit Alerts</div>
                                        <div className="text-2xl font-bold text-red-400">
                                            {signalSummary.exitAlerts}
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-green-700">
                                        <div className="text-slate-400 text-xs mb-1">üìà Increase Candidates</div>
                                        <div className="text-2xl font-bold text-green-400">
                                            {signalSummary.increaseCandidates}
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-orange-700">
                                        <div className="text-slate-400 text-xs mb-1">üîî Active Triggers</div>
                                        <div className="text-2xl font-bold text-orange-400">
                                            {signalSummary.activeTriggers}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-4 items-center bg-slate-800 rounded-xl p-4 border border-slate-700 flex-wrap">
                                    <span>Account:</span>
                                    <select value={accountFilter} onChange={(e) => setAccountFilter(e.target.value)}
                                        className="bg-slate-700 rounded-lg px-4 py-2">
                                        <option>All</option><option>Virtual</option><option>Real</option>
                                    </select>
                                    <button onClick={() => setShowFilters(!showFilters)}
                                        className={`px-4 py-2 rounded-lg font-semibold ${showFilters ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                        {showFilters ? 'Hide' : 'Show'} Filters ({Object.keys(filters).filter(k => filters[k]?.enabled).length})
                                    </button>
                                    {Object.keys(filters).some(k => filters[k]?.enabled) && (
                                        <button onClick={clearFilters} className="bg-orange-600 px-4 py-2 rounded-lg font-semibold">
                                            Clear Filters
                                        </button>
                                    )}
                                    <button onClick={() => exportXLSX('dashboard')} className="ml-auto bg-green-600 px-6 py-2 rounded-lg font-semibold">
                                        Export XLSX
                                    </button>
                                </div>

                                {showFilters && (
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 space-y-4">
                                        <div className="flex justify-between items-center">
                                            <h3 className="text-lg font-semibold">Advanced Filters</h3>
                                            <div className="flex gap-2">
                                                <input type="text" placeholder="View name..." value={filterName}
                                                    onChange={(e) => setFilterName(e.target.value)}
                                                    className="bg-slate-700 rounded-lg px-3 py-1 text-sm" />
                                                <button onClick={saveFilterView} className="bg-blue-600 px-4 py-1 rounded-lg text-sm font-semibold">
                                                    Save to Firebase
                                                </button>
                                            </div>
                                        </div>
                                        {savedFilters.length > 0 && (
                                            <div>
                                                <div className="text-sm font-semibold mb-2">Saved Views:</div>
                                                <div className="flex flex-wrap gap-2">
                                                    {savedFilters.map((v) => (
                                                        <div key={v.id} className="bg-slate-700 px-3 py-1 rounded-lg flex items-center gap-2">
                                                            <button onClick={() => loadFilterView(v)} className="text-blue-400 text-sm">{v.name}</button>
                                                            <button onClick={() => deleteFilterView(v.id, v.name)} className="text-red-400 text-xs">√ó</button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <FilterControl column="equity" label="Equity" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="netInvested" label="Net Invested" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="pl" label="P/L" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="plPercent" label="P/L %" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="recoveryFactor" label="Recovery" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="currentDailyPL3pt" label="Recent Daily" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="dailyPLSinceStart" label="Daily Start" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="estDailyPL" label="Smart Pred" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="currentDrawdown" label="Curr DD" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="maxDrawdown" label="Max DD" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="trader" label="Trader" type="text" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="account" label="Account" type="text" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="decision" label="Decision" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['BUY', 'SELL', 'HOLD', 'NO_DATA']} />
                                            <FilterControl column="warnings" label="Warnings" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['Has Warning', 'No Warning']} />
                                            <FilterControl column="entrySignal" label="Entry Signal" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['CONSERVATIVE_ENTRY', 'BALANCED_ENTRY', 'AGGRESSIVE_ENTRY', 'NO_ENTRY']} />
                                            <FilterControl column="exitSignal" label="Exit Alert" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['IMMEDIATE', 'MODERATE', 'OPTIONAL']} />
                                            <FilterControl column="actionSignal" label="Action" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['INCREASE', 'HOLD', 'REDUCE', 'MONITOR']} />
                                            <FilterControl column="rfGrade" label="RF Grade" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['S', 'A', 'B', 'C', 'C-', 'D', 'F']} />
                                            <FilterControl column="ddRisk" label="DD Risk" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['SAFE', 'ACCEPTABLE', 'RISKY', 'DANGEROUS']} />
                                            <FilterControl column="activity" label="Activity" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['VERY_ACTIVE', 'ACTIVE', 'MODERATE', 'LOW_ACTIVITY', 'DORMANT']} />
                                        </div>
                                    </div>
                                )}

                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 overflow-x-auto">
                                    <table className="w-full text-xs">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <SortableHeader column="trader" label="Trader" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />
                                                <SortableHeader column="account" label="Account" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />
                                                <th className="text-center py-3 px-2 font-semibold">Activity</th>
                                                <th className="text-center py-3 px-2 font-semibold">RF Grade</th>
                                                <th className="text-center py-3 px-2 font-semibold">DD Risk</th>
                                                <th className="text-center py-3 px-2 font-semibold">Entry</th>
                                                <th className="text-center py-3 px-2 font-semibold">Exit</th>
                                                <th className="text-center py-3 px-2 font-semibold">Action</th>
                                                <SortableHeader column="equity" label="Equity" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="pl" label="P/L" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="plPercent" label="P/L %" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="estDailyPL" label="Smart" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="currentDrawdown" label="Curr DD" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="maxDrawdown" label="Max DD" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="recoveryFactor" label="Recovery" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <th className="text-center py-3 px-2 font-semibold">Warning</th>
                                                <th className="text-center py-3 px-2 font-semibold">Decision</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {dashboardData.map(r => {
                                                const decStyle = getDecisionStyle(r.decision);
                                                return (
                                                <tr key={`${r.trader}-${r.account}`} className={getRowClasses(r)}>
                                                    <td className="py-3 px-2 font-semibold">{r.trader}</td>
                                                    <td className="py-3 px-2 text-slate-400">{r.account}</td>
                                                    
                                                    <td className="text-center py-3 px-2">
                                                        {r.activityInfo ? (
                                                            <Tooltip content={`Avg Daily P/L Movement: ${r.activityInfo.metrics?.avgAbsDailyPL || '0'} Ft | Active Days: ${r.activityInfo.metrics?.activityRatio || '0%'}`}>
                                                                <div className="flex flex-col items-center">
                                                                    <span className={`text-xs font-bold ${r.activityInfo.color || 'text-slate-500'}`}>
                                                                        {r.activityInfo.status || 'N/A'}
                                                                    </span>
                                                                    <span className="text-xs text-slate-400">
                                                                        {r.activityInfo.metrics?.avgAbsDailyPL || '0'} Ft/d
                                                                    </span>
                                                                </div>
                                                            </Tooltip>
                                                        ) : (
                                                            <span className="text-slate-500 text-xs">-</span>
                                                        )}
                                                    </td>
                                                    
                                                    <td className="text-center py-3 px-2">
                                                        {r.rfAssessment ? (
                                                            <Tooltip content={r.rfAssessment.label || ''}>
                                                                <div className={`inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold ${r.rfAssessment.color || 'bg-slate-600'}`}>
                                                                    <span>{r.rfAssessment.icon || '?'}</span>
                                                                    <span>{r.rfAssessment.grade || 'N/A'}</span>
                                                                </div>
                                                            </Tooltip>
                                                        ) : (
                                                            <span className="text-slate-500 text-xs">-</span>
                                                        )}
                                                    </td>
                                                    
                                                    <td className="text-center py-3 px-2">
                                                        {r.ddAssessment ? (
                                                            <div className="flex flex-col gap-1">
                                                                <span className={`text-xs ${r.ddAssessment.currentLevel?.color || 'text-slate-500'}`}>
                                                                    C:{r.ddAssessment.currentLevel?.label || 'N/A'}
                                                                </span>
                                                                <span className={`text-xs px-1 py-0.5 rounded ${
                                                                    r.ddAssessment.overallRisk === 'SAFE' ? 'bg-green-900/30 text-green-400' :
                                                                    r.ddAssessment.overallRisk === 'ACCEPTABLE' ? 'bg-yellow-900/30 text-yellow-400' :
                                                                    r.ddAssessment.overallRisk === 'RISKY' ? 'bg-orange-900/30 text-orange-400' :
                                                                    r.ddAssessment.overallRisk === 'DANGEROUS' ? 'bg-red-900/30 text-red-400' :
                                                                    'bg-slate-900/30 text-slate-400'
                                                                }`}>
                                                                    {r.ddAssessment.overallRisk || 'N/A'}
                                                                </span>
                                                            </div>
                                                        ) : (
                                                            <span className="text-slate-500 text-xs">-</span>
                                                        )}
                                                    </td>
                                                    
                                                    <td className="text-center py-3 px-2">
                                                        {r.entrySignal && r.entrySignal.type !== 'NO_ENTRY' ? (
                                                            <Tooltip content={r.entrySignal.strength || r.entrySignal.type || ''}>
                                                                <div className={`px-2 py-1 rounded-lg ${r.entrySignal.color || 'bg-slate-600'} text-white text-xs font-bold`}>
                                                                    {r.entrySignal.icon || '?'}
                                                                </div>
                                                            </Tooltip>
                                                        ) : (
                                                            <span className="text-slate-500 text-xs">-</span>
                                                        )}
                                                    </td>
                                                    
                                                    <td className="text-center py-3 px-2">
                                                        {r.exitSignal ? (
                                                            <Tooltip content={r.exitSignal.type || ''}>
                                                                <div className={`px-2 py-1 rounded-lg ${r.exitSignal.color || 'bg-slate-600'} text-white text-xs font-bold ${
                                                                    r.exitSignal.pulse ? 'animate-pulse' : ''
                                                                }`}>
                                                                    {r.exitSignal.icon || '?'}
                                                                </div>
                                                            </Tooltip>
                                                        ) : (
                                                            <span className="text-green-500 text-xs">‚úì</span>
                                                        )}
                                                    </td>
                                                    
                                                    <td className="text-center py-3 px-2">
                                                        {r.actionSignal ? (
                                                            <Tooltip content={r.actionSignal.type || ''}>
                                                                <div className={`px-2 py-1 rounded-lg ${r.actionSignal.color || 'bg-slate-600'} text-white text-xs`}>
                                                                    {r.actionSignal.icon || '?'}
                                                                </div>
                                                            </Tooltip>
                                                        ) : (
                                                            <span className="text-slate-500 text-xs">-</span>
                                                        )}
                                                    </td>
                                                    
                                                    <td className="text-right py-3 px-2">{r.equity.toFixed(0)}Ft</td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmap(r.pl, vals.pl)} font-semibold text-white`}>
                                                        {r.pl.toFixed(0)}Ft
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmap(r.plPercent, vals.plPct)} font-semibold text-white`}>
                                                        {r.plPercent.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmap(r.estDailyPL, vals.est)} text-white`}>
                                                        {r.estDailyPL.toFixed(0)}Ft
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getDD(r.currentDrawdown, vals.curr)} font-semibold text-white`}>
                                                        {r.currentDrawdown.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getDD(r.maxDrawdown, vals.max)} font-semibold text-white`}>
                                                        {r.maxDrawdown.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmap(r.recoveryFactor, vals.rec)} font-semibold text-white`}>
                                                        {r.recoveryFactor.toFixed(2)}
                                                    </td>
                                                    <td className="text-center py-3 px-2">
                                                        {r.warnings.length > 0 ? (
                                                            <div className="flex flex-col gap-1">
                                                                {r.warnings.map((w, i) => (
                                                                    <span key={i} className="px-2 py-1 bg-orange-600 rounded text-xs">
                                                                        ‚ö† {w}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <span className="text-slate-500">-</span>
                                                        )}
                                                    </td>
                                                    <td className="text-center py-3 px-2">
                                                        <span className={`px-3 py-1 rounded-lg font-bold text-white ${decStyle.bg}`}>
                                                            {decStyle.text}
                                                        </span>
                                                    </td>
                                                </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'transactions' && (
                            <div className="space-y-6">
                                <div className="flex gap-4">
                                    <button onClick={() => { setNewData({...newData, dataType: 'transaction'}); setShowAddData(true); }}
                                        className="bg-blue-600 px-6 py-3 rounded-lg font-semibold">Add Data</button>
                                    <button onClick={() => exportXLSX('transactions')} className="bg-green-600 px-6 py-3 rounded-lg font-semibold">Export</button>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <th className="text-left py-3 px-2">Date</th>
                                                <th className="text-left py-3 px-2">Trader</th>
                                                <th className="text-left py-3 px-2">Account</th>
                                                <th className="text-right py-3 px-2">Amount</th>
                                                <th className="text-left py-3 px-2">Type</th>
                                                <th className="text-left py-3 px-2">Note</th>
                                                <th className="text-center py-3 px-2">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {transactions.map(t => (
                                                <tr key={t.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-3 px-2">{t.date}</td>
                                                    <td className="py-3 px-2 font-semibold">{t.trader}</td>
                                                    <td className="py-3 px-2 text-slate-400">{t.account}</td>
                                                    <td className="text-right py-3 px-2">{t.amount}Ft</td>
                                                    <td className="py-3 px-2">
                                                        <span className={`px-2 py-1 rounded text-xs font-semibold ${t.type === 'DEPOSIT' ? 'bg-green-600' : 'bg-red-600'}`}>{t.type}</span>
                                                    </td>
                                                    <td className="py-3 px-2 text-slate-400">{t.note}</td>
                                                    <td className="text-center py-3 px-2">
                                                        <button onClick={() => deleteTransaction(t.id, t.trader, t.date)}
                                                            className="text-red-400 hover:text-red-300 font-bold text-lg">
                                                            √ó
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'snapshots' && (
                            <div className="space-y-6">
                                <div className="flex gap-4">
                                    <button onClick={() => { setNewData({...newData, dataType: 'snapshot'}); setShowAddData(true); }}
                                        className="bg-blue-600 px-6 py-3 rounded-lg font-semibold">Add Data</button>
                                    <button onClick={() => exportXLSX('snapshots')} className="bg-green-600 px-6 py-3 rounded-lg font-semibold">Export</button>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <th className="text-left py-3 px-2">Date</th>
                                                <th className="text-left py-3 px-2">Trader</th>
                                                <th className="text-left py-3 px-2">Account</th>
                                                <th className="text-right py-3 px-2">Equity</th>
                                                <th className="text-right py-3 px-2">Max</th>
                                                <th className="text-right py-3 px-2">DD%</th>
                                                <th className="text-left py-3 px-2">PrevDate</th>
                                                <th className="text-right py-3 px-2">Flow</th>
                                                <th className="text-right py-3 px-2">PrevEq</th>
                                                <th className="text-right py-3 px-2">PnL</th>
                                                <th className="text-right py-3 px-2">Days</th>
                                                <th className="text-right py-3 px-2">PL/day</th>
                                                <th className="text-center py-3 px-2">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {snapshotsWithCalcs.map(s => (
                                                <tr key={s.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-3 px-2">{s.date}</td>
                                                    <td className="py-3 px-2 font-semibold">{s.trader}</td>
                                                    <td className="py-3 px-2 text-slate-400">{s.account}</td>
                                                    <td className="text-right py-3 px-2">{s.equity}Ft</td>
                                                    <td className="text-right py-3 px-2 text-blue-400">{s.runningMaxEquity?.toFixed(0)}Ft</td>
                                                    <td className={`text-right py-3 px-2 ${s.currentDrawdown > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                        {s.currentDrawdown?.toFixed(2)}%
                                                    </td>
                                                    <td className="py-3 px-2 text-slate-400">{s.prevDate}</td>
                                                    <td className="text-right py-3 px-2">{s.flowSinceLast?.toFixed(0)}Ft</td>
                                                    <td className="text-right py-3 px-2">{s.prevEquity}Ft</td>
                                                    <td className={`text-right py-3 px-2 ${s.pnlPeriod >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {s.pnlPeriod?.toFixed(0)}Ft
                                                    </td>
                                                    <td className="text-right py-3 px-2">{s.daysSincePrev}</td>
                                                    <td className={`text-right py-3 px-2 ${s.plPerDay >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {s.plPerDay?.toFixed(2)}Ft
                                                    </td>
                                                    <td className="text-center py-3 px-2">
                                                        <button onClick={() => deleteSnapshot(s.id, s.trader, s.date)}
                                                            className="text-red-400 hover:text-red-300 font-bold text-lg">
                                                            √ó
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {showAddData && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-semibold">Add Data</h3>
                                        <button onClick={() => setShowAddData(false)} className="text-slate-400 hover:text-white text-2xl">√ó</button>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="flex gap-2">
                                            <button onClick={() => setNewData({...newData, dataType: 'snapshot'})}
                                                className={`flex-1 py-2 rounded-lg font-semibold ${newData.dataType === 'snapshot' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                                Snapshot
                                            </button>
                                            <button onClick={() => setNewData({...newData, dataType: 'transaction'})}
                                                className={`flex-1 py-2 rounded-lg font-semibold ${newData.dataType === 'transaction' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                                Transaction
                                            </button>
                                        </div>
                                        <input type="text" placeholder="Date (YYYY.MM.DD)" value={newData.date}
                                            onChange={(e) => setNewData({ ...newData, date: e.target.value })}
                                            className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                        {newData.dataType === 'snapshot' ? (
                                            <select value={newData.trader} onChange={(e) => setNewData({ ...newData, trader: e.target.value })}
                                                className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                                <option value="">Select Trader</option>
                                                {traderNames.map(n => <option key={n} value={n}>{n}</option>)}
                                            </select>
                                        ) : (
                                            <input type="text" placeholder="Trader" value={newData.trader}
                                                onChange={(e) => setNewData({ ...newData, trader: e.target.value })}
                                                className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                        )}
                                        <select value={newData.account} onChange={(e) => setNewData({ ...newData, account: e.target.value })}
                                            className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                            <option>Virtual</option>
                                            <option>Real</option>
                                        </select>
                                        {newData.dataType === 'snapshot' ? (
                                            <input type="number" placeholder="Equity" value={newData.equity}
                                                onChange={(e) => setNewData({ ...newData, equity: e.target.value })}
                                                className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                        ) : (
                                            <>
                                                <input type="number" placeholder="Amount" value={newData.amount}
                                                    onChange={(e) => setNewData({ ...newData, amount: e.target.value })}
                                                    className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                                <select value={newData.transactionType} onChange={(e) => setNewData({ ...newData, transactionType: e.target.value })}
                                                    className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                                    <option>DEPOSIT</option>
                                                    <option>WITHDRAWAL</option>
                                                    <option>REALLOCATION</option>
                                                </select>
                                                <input type="text" placeholder="Note" value={newData.note}
                                                    onChange={(e) => setNewData({ ...newData, note: e.target.value })}
                                                    className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                            </>
                                        )}
                                        <button onClick={addData} className="w-full bg-blue-600 px-6 py-2 rounded-lg font-semibold">
                                            Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EtoroTracker />);
    </script>
</body>
</html>