<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eToro Copy Trader Dashboard v17</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setDoc, getDoc, updateDoc, getDocs, where, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBVE6eRSapt2fwVnLoQm2EfcScksg0OWiU",
            authDomain: "etoro-tracker.firebaseapp.com",
            projectId: "etoro-tracker",
            storageBucket: "etoro-tracker.firebasestorage.app",
            messagingSenderId: "941552714377",
            appId: "1:941552714377:web:8c44519dc1352aea7bbc58"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.firebaseDb = db;
        window.firebaseUtils = { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setDoc, getDoc, updateDoc, getDocs, where, limit };
        window.SECURITY_KEY = "my-secret-etoro-key-2024";
        window.firebaseReady = true;
        
        window.quotaCounter = {
            reads: 0,
            writes: 0,
            lastReset: new Date().toDateString()
        };window.QUOTA_COLLECTION = 'quota_tracking';
        window.getTodayQuotaDocId = () => {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        };
    </script>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        function Tooltip({ content, children }) {
            const [show, setShow] = useState(false);
            return (
                <div className="relative inline-block"
                     onMouseEnter={() => setShow(true)}
                     onMouseLeave={() => setShow(false)}>
                    {children}
                    {show && (
                        <div className="absolute z-50 bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg shadow-xl max-w-xs border border-slate-700 whitespace-nowrap">
                            {content}
                            <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1 border-4 border-transparent border-t-slate-900"></div>
                        </div>
                    )}
                </div>
            );
        }

        function QuotaMeter({ reads, writes }) {
            const DAILY_READ_LIMIT = 40000;
            const DAILY_WRITE_LIMIT = 8000;
            
            const readPercent = Math.min((reads / DAILY_READ_LIMIT) * 100, 100);
            const writePercent = Math.min((writes / DAILY_WRITE_LIMIT) * 100, 100);
            
            const getColor = (percent) => {
                if (percent > 87.5) return 'bg-red-600';
                if (percent > 62.5) return 'bg-orange-600';
                if (percent > 37.5) return 'bg-yellow-600';
                return 'bg-green-600';
            };
            
            return (
                <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                    <div className="text-sm font-semibold mb-2">üìä Today's Firebase Usage</div>
                    <div className="space-y-3">
                        <div>
                            <div className="flex justify-between text-xs text-slate-400 mb-1">
                                <span>Reads: {reads.toLocaleString()} / {DAILY_READ_LIMIT.toLocaleString()}</span>
                                <span>{readPercent.toFixed(1)}%</span>
                            </div>
                            <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div className={`h-full ${getColor(readPercent)} transition-all`} style={{width: `${readPercent}%`}}></div>
                            </div>
                        </div>
                        <div>
                            <div className="flex justify-between text-xs text-slate-400 mb-1">
                                <span>Writes: {writes.toLocaleString()} / {DAILY_WRITE_LIMIT.toLocaleString()}</span>
                                <span>{writePercent.toFixed(1)}%</span>
                            </div>
                            <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div className={`h-full ${getColor(writePercent)} transition-all`} style={{width: `${writePercent}%`}}></div>
                            </div>
                        </div>
                    </div>
                    {(readPercent > 75 || writePercent > 75) && (
                        <div className="mt-2 text-xs text-orange-400">
                            ‚ö†Ô∏è High usage detected - tracker may slow down to prevent quota exceeded
                        </div>
                    )}
                </div>
            );
        }

        function AlertPanel({ alerts, onDismiss }) {
            const [showAlerts, setShowAlerts] = useState(false);
            const unreadCount = alerts.filter(a => !a.read).length;
            
            return (
                <div className="relative">
                    <button 
                        onClick={() => setShowAlerts(!showAlerts)}
                        className="relative bg-slate-800 p-3 rounded-lg border border-slate-700 hover:bg-slate-700"
                    >
                        <span className="text-2xl">üîî</span>
                        {unreadCount > 0 && (
                            <span className="absolute -top-2 -right-2 bg-red-600 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center animate-pulse">
                                {unreadCount}
                            </span>
                        )}
                    </button>
                    
                    {showAlerts && (
                        <div className="absolute top-16 right-0 w-96 max-h-96 overflow-y-auto bg-slate-800 rounded-lg border border-slate-700 shadow-2xl z-50">
                            <div className="p-4 border-b border-slate-700">
                                <h3 className="font-bold">Active Alerts</h3>
                            </div>
                            
                            {alerts.length === 0 ? (
                                <div className="p-4 text-center text-slate-400">
                                    No alerts
                                </div>
                            ) : (
                                <div className="divide-y divide-slate-700">
                                    {alerts.map(alert => (
                                        <div key={alert.id} className={`p-4 ${
                                            alert.level === 'CRITICAL' ? 'bg-red-900/20' :
                                            alert.level === 'WARNING' ? 'bg-orange-900/20' :
                                            'bg-blue-900/20'
                                        }`}>
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                                                            alert.level === 'CRITICAL' ? 'bg-red-600' :
                                                            alert.level === 'WARNING' ? 'bg-orange-600' :
                                                            'bg-blue-600'
                                                        } text-white`}>
                                                            {alert.level}
                                                        </span>
                                                        <span className="text-xs text-slate-400">
                                                            {new Date(alert.timestamp).toLocaleString()}
                                                        </span>
                                                    </div>
                                                    <div className="font-semibold text-sm">
                                                        {alert.trader} ({alert.account})
                                                    </div>
                                                    <div className="text-sm text-slate-300 mt-1">
                                                        {alert.message}
                                                    </div>
                                                </div>
                                                <button 
                                                    onClick={() => onDismiss(alert.id)}
                                                    className="text-slate-400 hover:text-white"
                                                >
                                                    √ó
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function FirebaseStatus({ status }) {
            const colors = {
                connected: 'bg-green-500',
                readonly: 'bg-yellow-500',
                disconnected: 'bg-red-500',
                checking: 'bg-gray-500'
            };
            const labels = {
                connected: 'Connected & Writable',
                readonly: 'Connected (Read Only)',
                disconnected: 'Disconnected',
                checking: 'Checking...'
            };
            return (
                <div className="flex items-center gap-2 bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
                    <div className={`w-3 h-3 rounded-full ${colors[status]} ${status === 'connected' ? 'animate-pulse' : ''}`}></div>
                    <span className="text-sm">{labels[status]}</span>
                </div>
            );
        }

        function FilterControl({ column, label, type, filters, updateFilter, options }) {
            const filter = filters[column] || { enabled: false, type, min: '', max: '', value: '' };
            return (
                <div className="bg-slate-700 rounded-lg p-3">
                    <div className="flex items-center gap-2 mb-2">
                        <input type="checkbox" checked={filter.enabled}
                            onChange={(e) => updateFilter(column, { ...filter, enabled: e.target.checked })}
                            className="w-4 h-4" />
                        <label className="text-sm font-semibold">{label}</label>
                    </div>
                    {type === 'range' && (
                        <div className="flex gap-2">
                            <input type="number" placeholder="Min" value={filter.min || ''}
                                onChange={(e) => updateFilter(column, { ...filter, min: e.target.value, type: 'range', enabled: true })}
                                className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm" />
                            <input type="number" placeholder="Max" value={filter.max || ''}
                                onChange={(e) => updateFilter(column, { ...filter, max: e.target.value, type: 'range', enabled: true })}
                                className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm" />
                        </div>
                    )}
                    {type === 'text' && (
                        <input type="text" placeholder={`Search...`} value={filter.value || ''}
                            onChange={(e) => updateFilter(column, { ...filter, value: e.target.value, type: 'text', enabled: true })}
                            className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm" />
                    )}
                    {type === 'select' && options && (
                        <select value={filter.value || ''} 
                            onChange={(e) => updateFilter(column, { ...filter, value: e.target.value, type: 'select', enabled: true })}
                            className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm">
                            <option value="">All</option>
                            {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                    )}
                </div>
            );
        }

        function SortableHeader({ column, label, sortColumn, sortDirection, handleSort, align = 'left' }) {
            return (
                <th className={`text-${align} py-3 px-2 font-semibold cursor-pointer hover:bg-slate-700`}
                    onClick={() => handleSort(column)}>
                    <div className={`flex items-center gap-1 ${align === 'right' ? 'justify-end' : align === 'center' ? 'justify-center' : ''}`}>
                        {label}
                        {sortColumn === column && <span className="text-blue-400">{sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>}
                    </div>
                </th>
            );
        }

        function EtoroTracker() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [accountFilter, setAccountFilter] = useState('All');
            const [showAddData, setShowAddData] = useState(false);
            const [transactions, setTransactions] = useState([]);
            const [snapshots, setSnapshots] = useState([]);
            const [alerts, setAlerts] = useState([]);
            const [traderStatuses, setTraderStatuses] = useState([]);
            const [sortColumn, setSortColumn] = useState('trader');
            const [sortDirection, setSortDirection] = useState('asc');
            const [snapshotSortColumn, setSnapshotSortColumn] = useState('date');
            const [snapshotSortDirection, setSnapshotSortDirection] = useState('desc');
            const [showFilters, setShowFilters] = useState(false);
            const [showColumnSettings, setShowColumnSettings] = useState(false);
            const [filters, setFilters] = useState({});
            const [savedViews, setSavedViews] = useState([]);
            const [currentViewId, setCurrentViewId] = useState(null);
            const [currentViewName, setCurrentViewName] = useState('Default');
            const [showSaveViewDialog, setShowSaveViewDialog] = useState(false);
            const [newViewName, setNewViewName] = useState('');
            const [firebaseStatus, setFirebaseStatus] = useState('checking');
            const [integrityReport, setIntegrityReport] = useState(null);
            const [lastIntegrityCheck, setLastIntegrityCheck] = useState(null);
            const [isCheckingIntegrity, setIsCheckingIntegrity] = useState(false);
            const [dismissedAlerts, setDismissedAlerts] = useState([]);
            const [showTraderStatusDialog, setShowTraderStatusDialog] = useState(false);
            const [traderStatusForm, setTraderStatusForm] = useState({ trader: '', account: '', status: 'ACTIVE', reason: '' });
            const [quotaReads, setQuotaReads] = useState(0);
            const [quotaWrites, setQuotaWrites] = useState(0);const [quotaExceeded, setQuotaExceeded] = useState(false);
            const quotaSyncTimeoutRef = useRef(null);const lastProcessedTimestampRef = useRef(null);
            const [alertsCache, setAlertsCache] = useState(new Map());
            const [alertsCacheLoaded, setAlertsCacheLoaded] = useState(false);
            const [consecutiveErrors, setConsecutiveErrors] = useState(0);
            const previousDataRef = useRef(null);
            const autoSaveTimeoutRef = useRef(null);
            const prevVisibleColumnsRef = useRef(null);
            const prevFiltersRef = useRef(null);
            const lastWriteTimeRef = useRef(0);
            
            const [visibleColumns, setVisibleColumns] = useState({
                trader: true, account: true, date: true, status: true, activity: true, rfGrade: true, ddRisk: true,
                entrySignal: true, exitSignal: true, actionSignal: true, warning: true, decision: true,
                equity: true, netInvested: true, pl: true, plPercent: true, recentDaily: true,
                dailySince: true, smartPred: true, dailyPct: true, currentDD: true, maxDD: true,
                avgDD: true, recovery: true
            });
            
            const [newData, setNewData] = useState({
                dataType: 'snapshot',
                date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                trader: '', account: 'Virtual', equity: '', amount: '', transactionType: 'DEPOSIT', note: ''
            });

            const trackRead = () => {
                const today = new Date().toDateString();
                if (window.quotaCounter.lastReset !== today) {
                    window.quotaCounter.reads = 0;
                    window.quotaCounter.writes = 0;
                    window.quotaCounter.lastReset = today;
                }
                window.quotaCounter.reads++;
                setQuotaReads(window.quotaCounter.reads);
                
                // Debounced Firebase sync
                if (quotaSyncTimeoutRef.current) {
                    clearTimeout(quotaSyncTimeoutRef.current);
                }
                quotaSyncTimeoutRef.current = setTimeout(async () => {
                    try {
                        const { doc, setDoc } = window.firebaseUtils;
                        const db = window.firebaseDb;
                        const docId = window.getTodayQuotaDocId();
                        await setDoc(doc(db, window.QUOTA_COLLECTION, docId), {
                            date: docId,
                            reads: window.quotaCounter.reads,
                            writes: window.quotaCounter.writes,
                            lastUpdated: new Date().toISOString(),
                            securityKey: window.SECURITY_KEY
                        }, { merge: true });
                    } catch (e) {
                        console.error('Quota sync failed:', e);
                    }
                }, 30000);
            };

            const trackWrite = () => {
                const today = new Date().toDateString();
                if (window.quotaCounter.lastReset !== today) {
                    window.quotaCounter.reads = 0;
                    window.quotaCounter.writes = 0;
                    window.quotaCounter.lastReset = today;
                }
                window.quotaCounter.writes++;
                setQuotaWrites(window.quotaCounter.writes);
                
                // Debounced Firebase sync
                if (quotaSyncTimeoutRef.current) {
                    clearTimeout(quotaSyncTimeoutRef.current);
                }
                quotaSyncTimeoutRef.current = setTimeout(async () => {
                    try {
                        const { doc, setDoc } = window.firebaseUtils;
                        const db = window.firebaseDb;
                        const docId = window.getTodayQuotaDocId();
                        await setDoc(doc(db, window.QUOTA_COLLECTION, docId), {
                            date: docId,
                            reads: window.quotaCounter.reads,
                            writes: window.quotaCounter.writes,
                            lastUpdated: new Date().toISOString(),
                            securityKey: window.SECURITY_KEY
                        }, { merge: true });
                    } catch (e) {
                        console.error('Quota sync failed:', e);
                    }
                }, 30000);
            };

            const checkQuotaLimit = (type = 'read') => {
                const DAILY_READ_LIMIT = 40000;
                const DAILY_WRITE_LIMIT = 8000;
                
                if (type === 'read' && window.quotaCounter.reads > DAILY_READ_LIMIT) {
                    console.error('üö® DAILY READ LIMIT EXCEEDED!');
                    alert('‚ö†Ô∏è Daily quota limit reached! Tracker paused for safety. Please wait until midnight for reset.');
                    throw new Error('Quota limit exceeded');
                }
                
                if (type === 'write' && window.quotaCounter.writes > DAILY_WRITE_LIMIT) {
                    console.error('üö® DAILY WRITE LIMIT EXCEEDED!');
                    alert('‚ö†Ô∏è Daily write limit reached! Tracker paused for safety. Please wait until midnight for reset.');
                    throw new Error('Quota limit exceeded');
                }
            };

            const rateLimitedWrite = async (fn) => {
                const MIN_WRITE_INTERVAL = 2000;
                const now = Date.now();
                
                if (now - lastWriteTimeRef.current < MIN_WRITE_INTERVAL) {
                    console.warn('‚ö†Ô∏è Rate limit: Write too frequent, skipping');
                    return null;
                }
                
                lastWriteTimeRef.current = now;
                checkQuotaLimit('write');
                trackWrite();
                return await fn();
            };

            const circuitBreaker = async (fn, context = 'operation') => {
                const MAX_ERRORS = 5;
                
                if (consecutiveErrors >= MAX_ERRORS) {
                    console.error('üö® CIRCUIT BREAKER: Too many errors, operation blocked');
                    alert('‚õî Tracker stopped due to repeated errors. Please refresh the page to restart.');
                    throw new Error('Circuit breaker activated');
                }
                
                try {
                    const result = await fn();
                    setConsecutiveErrors(0);
                    return result;
                } catch (e) {
                    console.error(`‚ùå ${context} failed:`, e);
                    setConsecutiveErrors(prev => prev + 1);
                    throw e;
                }
            };

            const deepEqual = (obj1, obj2) => {
                return JSON.stringify(obj1) === JSON.stringify(obj2);
            };

            useEffect(() => {
                if (!currentViewId || currentViewName !== 'Default') return;
                
                const columnsChanged = !deepEqual(visibleColumns, prevVisibleColumnsRef.current);
                const filtersChanged = !deepEqual(filters, prevFiltersRef.current);
                
                if (!columnsChanged && !filtersChanged) return;
                
                prevVisibleColumnsRef.current = visibleColumns;
                prevFiltersRef.current = filters;
                
                if (autoSaveTimeoutRef.current) {
                    clearTimeout(autoSaveTimeoutRef.current);
                }
                
                autoSaveTimeoutRef.current = setTimeout(async () => {
                    try {
                        await rateLimitedWrite(async () => {
                            const { doc, updateDoc } = window.firebaseUtils;
                            const db = window.firebaseDb;
                            await updateDoc(doc(db, 'views', currentViewId), {
                                visibleColumns,
                                filters,
                                lastUsed: new Date().toISOString(),
                                timestamp: new Date().toISOString()
                            });
                            console.log('‚úÖ Auto-saved Default view');
                        });
                    } catch (e) {
                        console.error('Auto-save failed:', e);
                    }
                }, 2000);
                
                return () => {
                    if (autoSaveTimeoutRef.current) {
                        clearTimeout(autoSaveTimeoutRef.current);
                    }
                };
            }, [visibleColumns, filters, currentViewId, currentViewName]);

            const loadLastProcessedTimestamp = async () => {
                try {
                    const { doc, getDoc } = window.firebaseUtils;
                    const db = window.firebaseDb;
                    const timestampDoc = await getDoc(doc(db, 'system_state', 'alert_processing'));
                    trackRead();
                    
                    if (timestampDoc.exists()) {
                        const data = timestampDoc.data();
                        lastProcessedTimestampRef.current = data.lastProcessedTimestamp;
                        console.log('‚úÖ Loaded lastProcessedTimestamp:', data.lastProcessedTimestamp);
                    } else {
                        console.log('‚ÑπÔ∏è No previous timestamp found, starting fresh');
                        lastProcessedTimestampRef.current = new Date().toISOString();
                    }
                } catch (e) {
                    console.error('Failed to load lastProcessedTimestamp:', e);
                    lastProcessedTimestampRef.current = new Date().toISOString();
                }
            };

            const updateLastProcessedTimestamp = async (timestamp) => {
                try {
                    await rateLimitedWrite(async () => {
                        const { doc, setDoc } = window.firebaseUtils;
                        const db = window.firebaseDb;
                        await setDoc(doc(db, 'system_state', 'alert_processing'), {
                            lastProcessedTimestamp: timestamp,
                            lastUpdated: new Date().toISOString(),
                            securityKey: window.SECURITY_KEY
                        });
                        console.log('‚úÖ Updated lastProcessedTimestamp:', timestamp);
                    });
                } catch (e) {
                    console.error('Failed to update lastProcessedTimestamp:', e);
                }
            };useEffect(() => {
                const initFirebase = async () => {
                    if (!window.firebaseReady) {
                        setTimeout(initFirebase, 100);
                        return;
                    }
                    const { collection, onSnapshot, query, doc, getDoc, setDoc, where } = window.firebaseUtils;
                    const db = window.firebaseDb;// Load today's quota from Firebase
                    try {
                        const quotaDocId = window.getTodayQuotaDocId();
                        const quotaDoc = await getDoc(doc(db, window.QUOTA_COLLECTION, quotaDocId));
                        if (quotaDoc.exists()) {
                            const data = quotaDoc.data();
                            window.quotaCounter.reads = data.reads || 0;
                            window.quotaCounter.writes = data.writes || 0;
                            setQuotaReads(data.reads || 0);
                            setQuotaWrites(data.writes || 0);
                            console.log('‚úÖ Quota loaded from Firebase:', data);
                        } else {
                            console.log('‚ÑπÔ∏è No quota data for today, starting fresh');
                        }
                    } catch (e) {
                        console.error('Failed to load quota from Firebase:', e);
                    }
                    
                    const sixMonthsAgo = new Date();
                    sixMonthsAgo.setDate(sixMonthsAgo.getDate() - 180);
                    
                    const twelveMonthsAgo = new Date();
                    twelveMonthsAgo.setDate(twelveMonthsAgo.getDate() - 365);
                    
                    onSnapshot(query(
                        collection(db, 'transactions'),
                        where('timestamp', '>', twelveMonthsAgo.toISOString())
                    ), (snapshot) => {
                        trackRead();
                        setTransactions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setFirebaseStatus('connected');
                    }, (error) => {
                        console.error('Firebase error:', error);
                        setFirebaseStatus('disconnected');
                    });
                    
                    onSnapshot(query(
                        collection(db, 'snapshots'),
                        where('timestamp', '>', sixMonthsAgo.toISOString())
                    ), (snapshot) => {
                        trackRead();
                        setSnapshots(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });

                    onSnapshot(query(collection(db, 'views')), (snapshot) => {
                        trackRead();
                        const views = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setSavedViews(views);
                        
                        if (!currentViewId) {
                            (async () => {
                                try {
                                    const prefDoc = await getDoc(doc(db, 'user_preferences', 'default'));
                                    trackRead();
                                    let viewToLoad = null;
                                    
                                    if (prefDoc.exists() && prefDoc.data().lastUsedViewId) {
                                        viewToLoad = views.find(v => v.id === prefDoc.data().lastUsedViewId);
                                    }
                                    
                                    if (!viewToLoad) {
                                        viewToLoad = views.find(v => v.name === 'Default');
                                        if (!viewToLoad) {
                                            await rateLimitedWrite(async () => {
                                                const defaultViewRef = doc(collection(db, 'views'));
                                                await setDoc(defaultViewRef, {
                                                    name: 'Default',
                                                    visibleColumns,
                                                    filters: {},
                                                    lastUsed: new Date().toISOString(),
                                                    timestamp: new Date().toISOString(),
                                                    securityKey: window.SECURITY_KEY
                                                });
                                                viewToLoad = { id: defaultViewRef.id, name: 'Default', visibleColumns, filters: {} };
                                            });
                                        }
                                    }
                                    
                                    if (viewToLoad) {
                                        loadView(viewToLoad);
                                    }
                                } catch (e) {
                                    console.error('Failed to load last view:', e);
                                }
                            })();
                        }
                    });

                    onSnapshot(query(collection(db, 'alerts')), (snapshot) => {
                        trackRead();
                        
                        // Mark cache as loaded after first snapshot
                        if (!alertsCacheLoaded) {
                            setAlertsCacheLoaded(true);
                            console.log('‚úÖ Alerts cache initialized');
                        }
                        
                        // Use docChanges() for incremental updates
                        const changes = snapshot.docChanges();
                        
                        setAlerts(prevAlerts => {
                            let updatedAlerts = [...prevAlerts];
                            
                            changes.forEach(change => {
                                const alertData = { id: change.doc.id, ...change.doc.data() };
                                
                                if (change.type === 'added') {
                                    updatedAlerts.push(alertData);
                                } else if (change.type === 'modified') {
                                    const index = updatedAlerts.findIndex(a => a.id === change.doc.id);
                                    if (index !== -1) {
                                        updatedAlerts[index] = alertData;
                                    }
                                } else if (change.type === 'removed') {
                                    updatedAlerts = updatedAlerts.filter(a => a.id !== change.doc.id);
                                }
                            });
                            
                            // Sort by timestamp desc
                            return updatedAlerts.sort((a, b) => 
                                new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
                            );
                        });
                        
                        const newCache = new Map(alertsCache);
                        changes.forEach(change => {
                            const data = change.doc.data();
                            const key = `${data.trader}-${data.account}-${data.type}-${data.level}`;
                            
                            if (change.type === 'added') {
                                newCache.set(key, change.doc.id);
                            } else if (change.type === 'removed') {
                                newCache.delete(key);
                            }
                        });
                        setAlertsCache(newCache);
                    });

                    onSnapshot(collection(db, 'trader_status'), (snapshot) => {
                        trackRead();
                        setTraderStatuses(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });

                    const prefDoc = await getDoc(doc(db, 'user_preferences', 'default'));
                    trackRead();
                    if (prefDoc.exists() && prefDoc.data().dismissedAlerts) {
                        setDismissedAlerts(prefDoc.data().dismissedAlerts);
                    }
                    
                    await loadLastProcessedTimestamp();
                };
                initFirebase();

                const healthCheck = setInterval(async () => {
                    try {
                        if (!window.firebaseReady) {
                            setFirebaseStatus('disconnected');
                            return;
                        }
                        
                        // Read-only health check - just test Firestore connectivity
                        const { collection, getDocs, query, limit } = window.firebaseUtils;
                        const db = window.firebaseDb;
                        
                        // Try to read 1 document from quota_tracking (lightweight check)
                        await getDocs(query(collection(db, window.QUOTA_COLLECTION), limit(1)));
                        trackRead();
                        
                        setFirebaseStatus('connected');
                        console.log('‚úÖ Health check passed (read-only)');
                    } catch (error) {
                        console.error('Health check failed:', error);
                        setFirebaseStatus(error.code === 'permission-denied' ? 'readonly' : 'disconnected');
                    }
                }, 10 * 60 * 1000);

                return () => clearInterval(healthCheck);
            }, []);

            useEffect(() => {
                const cleanupStaleAlerts = async () => {
                    if (!dashboardData || dashboardData.length === 0) return;
                    
                    try {
                        await circuitBreaker(async () => {
                            const { getDocs, collection, deleteDoc, doc } = window.firebaseUtils;
                            const db = window.firebaseDb;
                            
                            const STALE_THRESHOLD_HOURS = 2;
                            const now = Date.now();
                            
                            const alertsSnapshot = await getDocs(collection(db, 'alerts'));
                            trackRead();
                            const allAlerts = alertsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            
                            for (const alert of allAlerts) {
                                const traderExists = dashboardData.find(d => 
                                    d.trader === alert.trader && d.account === alert.account
                                );
                                
                                if (!traderExists) {
                                    await rateLimitedWrite(async () => {
                                        await deleteDoc(doc(db, 'alerts', alert.id));
                                    });
                                    console.log(`‚úÖ Cleaned up alert for removed trader: ${alert.trader}`);
                                    continue;
                                }
                                
                                const row = traderExists;
                                const triggers = row.triggers || [];
                                const triggerStillActive = triggers.some(t => 
                                    t.type === alert.type && t.level === alert.level
                                );
                                
                                if (!triggerStillActive) {
                                    // Check alert age - only delete if older than STALE_THRESHOLD_HOURS
                                    const alertAge = now - new Date(alert.timestamp).getTime();
                                    const alertAgeHours = alertAge / (1000 * 60 * 60);
                                    
                                    if (alertAgeHours >= STALE_THRESHOLD_HOURS) {
                                        await rateLimitedWrite(async () => {
                                            await deleteDoc(doc(db, 'alerts', alert.id));
                                        });
                                        console.log(`‚úÖ Cleaned up stale alert (${alertAgeHours.toFixed(1)}h old): ${alert.trader} - ${alert.type}`);
                                    } else {
                                        console.log(`‚è≥ Alert still fresh (${alertAgeHours.toFixed(1)}h old), keeping: ${alert.trader} - ${alert.type}`);
                                    }
                                }
                            }
                        }, 'Alert cleanup');
                    } catch (e) {
                        console.error('Alert cleanup failed:', e);
                    }
                };
                
                const cleanupInterval = setInterval(cleanupStaleAlerts, 15 * 60 * 1000);
                cleanupStaleAlerts();
                
                return () => clearInterval(cleanupInterval);
            }, [dashboardData]);

            const loadView = async (view) => {
                setCurrentViewId(view.id);
                setCurrentViewName(view.name);
                setVisibleColumns(view.visibleColumns || visibleColumns);
                setFilters(view.filters || {});
                
                prevVisibleColumnsRef.current = view.visibleColumns || visibleColumns;
                prevFiltersRef.current = view.filters || {};
                
                try {
                    await rateLimitedWrite(async () => {
                        const { doc, updateDoc, setDoc } = window.firebaseUtils;
                        const db = window.firebaseDb;
                        await updateDoc(doc(db, 'views', view.id), {
                            lastUsed: new Date().toISOString()
                        });
                        await setDoc(doc(db, 'user_preferences', 'default'), {
                            lastUsedViewId: view.id,
                            securityKey: window.SECURITY_KEY
                        });
                    });
                } catch (e) {
                    console.error('Failed to update lastUsed:', e);
                }
            };

            const saveViewAs = async () => {
                if (!newViewName.trim()) {
                    alert('Please enter a view name');
                    return;
                }
                
                try {
                    await circuitBreaker(async () => {
                        await rateLimitedWrite(async () => {
                            const { collection, addDoc } = window.firebaseUtils;
                            const db = window.firebaseDb;
                            const viewRef = await addDoc(collection(db, 'views'), {
                                name: newViewName,
                                visibleColumns,
                                filters,
                                lastUsed: new Date().toISOString(),
                                timestamp: new Date().toISOString(),
                                securityKey: window.SECURITY_KEY
                            });
                            
                            setNewViewName('');
                            setShowSaveViewDialog(false);
                            loadView({ id: viewRef.id, name: newViewName, visibleColumns, filters });
                            alert(`‚úÖ View "${newViewName}" saved successfully!`);
                        });
                    }, 'Save view');
                } catch (e) {
                    console.error('Failed to save view:', e);
                    alert('Failed to save view: ' + e.message);
                }
            };

            const deleteView = async (viewId, viewName) => {
                if (viewName === 'Default') {
                    alert('Cannot delete the Default view');
                    return;
                }
                
                if (!confirm(`Delete view "${viewName}"?`)) return;
                
                try {
                    await circuitBreaker(async () => {
                        await rateLimitedWrite(async () => {
                            const { deleteDoc, doc } = window.firebaseUtils;
                            await deleteDoc(doc(window.firebaseDb, 'views', viewId));
                            
                            if (currentViewId === viewId) {
                                const defaultView = savedViews.find(v => v.name === 'Default');
                                if (defaultView) {
                                    loadView(defaultView);
                                }
                            }
                        });
                    }, 'Delete view');
                } catch (e) {
                    console.error('Failed to delete view:', e);
                    alert('Failed to delete view: ' + e.message);
                }
            };

            const selectAllColumns = () => {
                const allSelected = {};
                Object.keys(visibleColumns).forEach(col => {
                    allSelected[col] = true;
                });
                setVisibleColumns(allSelected);
            };

            const selectNoneColumns = () => {
                const allHidden = {};
                Object.keys(visibleColumns).forEach(col => {
                    allHidden[col] = false;
                });
                setVisibleColumns(allHidden);
            };

            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                const parts = dateStr.split('.');
                if (parts.length === 3) return new Date(parts[0], parts[1] - 1, parts[2]);
                return new Date(dateStr);
            };

            const daysBetween = (d1, d2) => {
                const date1 = parseDate(d1), date2 = parseDate(d2);
                return date1 && date2 ? Math.floor((date1 - date2) / (1000 * 60 * 60 * 24)) : 0;
            };

            const weightedAverage = (snaps, days = 14) => {
                if (!snaps.length) return 0;
                const sorted = [...snaps].sort((a, b) => parseDate(b.date) - parseDate(a.date));
                const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
                const recent = sorted.filter(s => parseDate(s.date) >= cutoff && s.plPerDay !== 0);
                if (!recent.length) return 0;
                let sum = 0, totalW = 0;
                for (let i = 0; i < Math.min(recent.length, days); i++) {
                    const w = Math.exp(-i / 5);
                    sum += recent[i].plPerDay * w;
                    totalW += w;
                }
                return totalW > 0 ? sum / totalW : 0;
            };

            const getTraderStatus = (trader, account) => {
                const status = traderStatuses.find(s => s.trader === trader && s.account === account);
                return status || { status: 'ACTIVE' };
            };

            const getTradeDecision = (row) => {
                if (row.traderStatus.status === 'PAUSED') return 'PAUSED';
                if (row.daysSinceStart < 30 || !row.estDailyPL) return 'NO_DATA';
                if (row.recoveryFactor < 1.5 && row.maxDrawdown > 25) return 'SELL';
                if (row.estDailyPL < 0 && row.currentDailyPL3pt !== null && row.currentDailyPL3pt < 0) return 'SELL';
                if (row.currentDrawdown > 25) return 'SELL';
                if (row.plPercent < -10) return 'SELL';
                if (
                    row.estDailyPL >= 900 &&
                    row.plPercent >= 14 &&
                    row.recoveryFactor >= 2.5 &&
                    row.currentDrawdown < 15 &&
                    row.maxDrawdown < 25
                ) return 'BUY';
                return 'HOLD';
            };

            const getWarnings = (row) => {
                const warnings = [];
                if (row.traderStatus.status === 'PAUSED') warnings.push('Paused');
                if (row.currentDrawdown > 20) warnings.push('High DD');
                if (row.estDailyPL < 0) warnings.push('Declining');
                if (row.daysSinceStart < 30) warnings.push('Low Data');
                return warnings;
            };

            const getTraderActivityStatus = (trader, account, snapshotsWithCalcs) => {
                try {
                    const last30Snaps = snapshotsWithCalcs
                        .filter(s => s.trader === trader && s.account === account)
                        .sort((a, b) => parseDate(b.date) - parseDate(a.date))
                        .slice(0, 30);
                    
                    if (last30Snaps.length < 10) return {
                        status: 'INSUFFICIENT_DATA',
                        color: 'text-slate-500',
                        metrics: { avgAbsDailyPL: '0', activityRatio: '0%' }
                    };
                    
                    const dailyPLs = last30Snaps.map(s => s.plPerDay || 0).filter(pl => pl !== 0);
                    if (dailyPLs.length === 0) return {
                        status: 'INSUFFICIENT_DATA',
                        color: 'text-slate-500',
                        metrics: { avgAbsDailyPL: '0', activityRatio: '0%' }
                    };
                    
                    const avgAbsPL = dailyPLs.reduce((sum, pl) => sum + Math.abs(pl), 0) / dailyPLs.length;
                    
                    let significantChangeDays = 0;
                    for (let i = 0; i < last30Snaps.length - 1; i++) {
                        const change = Math.abs(last30Snaps[i].equity - last30Snaps[i+1].equity);
                        const changePercent = last30Snaps[i+1].equity > 0 ? (change / last30Snaps[i+1].equity) * 100 : 0;
                        if (changePercent > 0.1) significantChangeDays++;
                    }
                    const activityRatio = last30Snaps.length > 1 ? significantChangeDays / (last30Snaps.length - 1) : 0;
                    
                    const zeroDays = dailyPLs.filter(pl => Math.abs(pl) < 10).length;
                    const zeroRatio = zeroDays / dailyPLs.length;
                    
                    let status, color;
                    if (zeroRatio > 0.7) {
                        status = 'DORMANT';
                        color = 'text-blue-400';
                    } else if (avgAbsPL < 100) {
                        status = 'LOW_ACTIVITY';
                        color = 'text-yellow-400';
                    } else if (avgAbsPL < 300) {
                        status = 'MODERATE';
                        color = 'text-green-400';
                    } else if (avgAbsPL < 800) {
                        status = 'ACTIVE';
                        color = 'text-emerald-400';
                    } else {
                        status = 'VERY_ACTIVE';
                        color = 'text-violet-400';
                    }
                    
                    return {
                        status,
                        color,
                        metrics: {
                            avgAbsDailyPL: avgAbsPL.toFixed(0),
                            activityRatio: (activityRatio * 100).toFixed(0) + '%'
                        }
                    };
                } catch (e) {
                    console.error('Activity detection error:', e);
                    return {
                        status: 'ERROR',
                        color: 'text-red-500',
                        metrics: { avgAbsDailyPL: '0', activityRatio: '0%' }
                    };
                }
            };

            const getEntrySignal = (row) => {
                if (row.traderStatus.status === 'PAUSED') return {
                    type: 'PAUSED',
                    strength: 'NONE',
                    color: 'bg-gray-600',
                    icon: '‚è∏Ô∏è'
                };
                
                if (row.daysSinceStart < 30) return {
                    type: 'NO_ENTRY',
                    strength: 'NONE',
                    color: 'bg-gray-600',
                    icon: '‚õî'
                };
                
                const conservativeScore = 
                    (row.daysSinceStart >= 90 ? 1 : 0) +
                    (row.estDailyPL >= 800 ? 1 : 0) +
                    (row.plPercent >= 15 ? 1 : 0) +
                    (row.recoveryFactor >= 2.5 ? 1 : 0) +
                    (row.maxDrawdown <= 20 ? 1 : 0) +
                    (row.currentDrawdown <= 10 ? 1 : 0) +
                    (row.avgDrawdown <= 12 ? 1 : 0) +
                    (row.currentDailyPL3pt > 500 ? 1 : 0);
                
                if (conservativeScore >= 7) return {
                    type: 'CONSERVATIVE_ENTRY',
                    strength: 'STRONG',
                    amount: 'LARGE',
                    color: 'bg-emerald-600',
                    icon: 'üíé'
                };
                
                const balancedScore = 
                    (row.daysSinceStart >= 60 ? 1 : 0) +
                    (row.estDailyPL >= 500 ? 1 : 0) +
                    (row.plPercent >= 10 ? 1 : 0) +
                    (row.recoveryFactor >= 2.0 ? 1 : 0) +
                    (row.maxDrawdown <= 25 ? 1 : 0) +
                    (row.currentDrawdown <= 15 ? 1 : 0) +
                    (row.currentDailyPL3pt > 200 ? 1 : 0);
                
                if (balancedScore >= 6) return {
                    type: 'BALANCED_ENTRY',
                    strength: 'MODERATE',
                    amount: 'MEDIUM',
                    color: 'bg-blue-600',
                    icon: '‚öñÔ∏è'
                };
                
                const aggressiveScore = 
                    (row.daysSinceStart >= 30 ? 1 : 0) +
                    (row.estDailyPL >= 1200 ? 1 : 0) +
                    (row.plPercent >= 8 ? 1 : 0) +
                    (row.recoveryFactor >= 1.5 ? 1 : 0) +
                    (row.maxDrawdown <= 35 ? 1 : 0) +
                    (row.currentDrawdown <= 20 ? 1 : 0) +
                    (row.currentDailyPL3pt > 800 ? 1 : 0) +
                    (row.warnings.length === 0 ? 1 : 0);
                
                if (aggressiveScore >= 6) return {
                    type: 'AGGRESSIVE_ENTRY',
                    strength: 'SPECULATIVE',
                    amount: 'SMALL',
                    color: 'bg-purple-600',
                    icon: 'üöÄ'
                };
                
                return {
                    type: 'NO_ENTRY',
                    strength: 'NONE',
                    color: 'bg-gray-600',
                    icon: '‚õî'
                };
            };

            const getExitSignal = (row) => {
                if (row.traderStatus.status === 'PAUSED') return null;
                
                if (
                    row.currentDrawdown >= 30 ||
                    row.plPercent <= -15 ||
                    (row.estDailyPL < -500 && row.currentDailyPL3pt < -500) ||
                    row.recoveryFactor < 0.8 ||
                    (row.currentDrawdown > 20 && row.estDailyPL < 0)
                ) return {
                    type: 'EMERGENCY_EXIT',
                    urgency: 'IMMEDIATE',
                    color: 'bg-red-700',
                    icon: 'üö®',
                    pulse: true
                };
                
                if (
                    (row.estDailyPL < 0 && row.daysSinceStart > 30) ||
                    (row.recoveryFactor < 1.5 && row.maxDrawdown > 25) ||
                    row.currentDrawdown > 18
                ) return {
                    type: 'PLANNED_EXIT',
                    urgency: 'MODERATE',
                    color: 'bg-orange-600',
                    icon: '‚ö†Ô∏è',
                    pulse: false
                };
                
                if (
                    row.plPercent >= 50 ||
                    (row.plPercent >= 30 && row.currentDrawdown > 15)
                ) return {
                    type: 'PROFIT_TAKING',
                    urgency: 'OPTIONAL',
                    color: 'bg-yellow-600',
                    icon: 'üí∞',
                    pulse: false
                };
                
                return null;
            };

            const getActionSignal = (row) => {
                if (row.traderStatus.status === 'PAUSED') return {
                    type: 'PAUSED',
                    color: 'bg-gray-600',
                    icon: '‚è∏Ô∏è'
                };
                
                if (
                    row.plPercent >= 15 && row.plPercent < 40 &&
                    row.estDailyPL >= 800 &&
                    row.currentDailyPL3pt > row.dailyPLSinceStart * 1.2 &&
                    row.currentDrawdown <= 10 &&
                    row.recoveryFactor >= 2.5 &&
                    row.warnings.length === 0
                ) return {
                    type: 'INCREASE',
                    color: 'bg-green-600',
                    icon: 'üìà'
                };
                
                if (
                    row.plPercent >= 0 && row.plPercent < 30 &&
                    row.currentDrawdown <= 15 &&
                    row.estDailyPL >= 0 &&
                    row.recoveryFactor >= 1.8
                ) return {
                    type: 'HOLD',
                    color: 'bg-slate-600',
                    icon: '‚úã'
                };
                
                if (
                    row.currentDrawdown > 20 ||
                    row.recoveryFactor < 1.5 ||
                    row.estDailyPL < -200
                ) return {
                    type: 'REDUCE',
                    color: 'bg-orange-600',
                    icon: 'üìâ'
                };
                
                return {
                    type: 'MONITOR',
                    color: 'bg-slate-500',
                    icon: 'üëÅÔ∏è'
                };
            };

            const getRFAssessment = (row) => {
                try {
                    const rf = row.recoveryFactor || 0;
                    if (rf < 0.5) return { grade: 'F', label: 'CATASTROPHIC', color: 'text-red-900 bg-red-100', icon: 'üíÄ' };
                    if (rf < 1.0) return { grade: 'D', label: 'VERY_WEAK', color: 'text-red-700 bg-red-50', icon: 'üî¥' };
                    if (rf < 1.5) return { grade: 'C-', label: 'WEAK', color: 'text-orange-600 bg-orange-50', icon: 'üü†' };
                    if (rf < 2.0) return { grade: 'C', label: 'ACCEPTABLE', color: 'text-yellow-600 bg-yellow-50', icon: 'üü°' };
                    if (rf < 2.5) return { grade: 'B', label: 'GOOD', color: 'text-green-600 bg-green-50', icon: 'üü¢' };
                    if (rf < 3.5) return { grade: 'A', label: 'EXCELLENT', color: 'text-emerald-600 bg-emerald-50', icon: '‚úÖ' };
                    return { grade: 'S', label: 'EXCEPTIONAL', color: 'text-violet-700 bg-violet-50', icon: 'üíé' };
                } catch (e) {
                    console.error('RF assessment error:', e);
                    return { grade: 'N/A', label: 'ERROR', color: 'text-slate-500 bg-slate-100', icon: '?' };
                }
            };

            const getDDAssessment = (row) => {
                try {
                    const currentDrawdown = row.currentDrawdown || 0;
                    const maxDrawdown = row.maxDrawdown || 0;
                    
                    let currentLevel, maxLevel, overallRisk;
                    
                    if (currentDrawdown <= 5) currentLevel = { label: 'EXCELLENT', color: 'text-emerald-500' };
                    else if (currentDrawdown <= 10) currentLevel = { label: 'GOOD', color: 'text-green-500' };
                    else if (currentDrawdown <= 15) currentLevel = { label: 'MODERATE', color: 'text-yellow-500' };
                    else if (currentDrawdown <= 20) currentLevel = { label: 'HIGH', color: 'text-orange-500' };
                    else if (currentDrawdown <= 25) currentLevel = { label: 'DANGEROUS', color: 'text-red-500' };
                    else if (currentDrawdown <= 30) currentLevel = { label: 'CRITICAL', color: 'text-red-600' };
                    else currentLevel = { label: 'CATASTROPHIC', color: 'text-red-800' };
                    
                    if (maxDrawdown <= 15) maxLevel = { label: 'LOW_RISK', color: 'text-emerald-500' };
                    else if (maxDrawdown <= 25) maxLevel = { label: 'MEDIUM_RISK', color: 'text-yellow-500' };
                    else if (maxDrawdown <= 35) maxLevel = { label: 'HIGH_RISK', color: 'text-orange-500' };
                    else maxLevel = { label: 'VERY_HIGH_RISK', color: 'text-red-600' };
                    
                    if (currentDrawdown < 10 && maxDrawdown < 15) overallRisk = 'SAFE';
                    else if (currentDrawdown < 20 && maxDrawdown < 25) overallRisk = 'ACCEPTABLE';
                    else if (currentDrawdown < 30 && maxDrawdown < 35) overallRisk = 'RISKY';
                    else overallRisk = 'DANGEROUS';
                    
                    return { currentLevel, maxLevel, overallRisk };
                } catch (e) {
                    console.error('DD assessment error:', e);
                    return {
                        currentLevel: { label: 'ERROR', color: 'text-slate-500' },
                        maxLevel: { label: 'ERROR', color: 'text-slate-500' },
                        overallRisk: 'UNKNOWN'
                    };
                }
            };

            const detectTriggers = (row, previousRow) => {
                if (!previousRow || row.traderStatus.status === 'PAUSED') return [];
                
                const triggers = [];
                
                if (row.currentDrawdown >= 25 && previousRow.currentDrawdown < 25) {
                    triggers.push({
                        level: 'CRITICAL',
                        type: 'DD_THRESHOLD',
                        icon: 'üö®',
                        message: `DD reached critical 25% (was ${previousRow.currentDrawdown.toFixed(1)}%)`,
                        color: 'bg-red-600'
                    });
                }
                
                if (row.plPercent <= -10 && previousRow.plPercent > -10) {
                    triggers.push({
                        level: 'CRITICAL',
                        type: 'LOSS_THRESHOLD',
                        icon: 'üö®',
                        message: `Total loss exceeded -10% (was ${previousRow.plPercent.toFixed(1)}%)`,
                        color: 'bg-red-600'
                    });
                }
                
                if (row.currentDrawdown > previousRow.currentDrawdown + 5) {
                    triggers.push({
                        level: 'WARNING',
                        type: 'DD_SPIKE',
                        icon: '‚ö†Ô∏è',
                        message: `DD increased by ${(row.currentDrawdown - previousRow.currentDrawdown).toFixed(1)}%`,
                        color: 'bg-orange-600'
                    });
                }
                
                if (row.estDailyPL < 0 && previousRow.estDailyPL >= 0) {
                    triggers.push({
                        level: 'WARNING',
                        type: 'TREND_REVERSAL',
                        icon: '‚ö†Ô∏è',
                        message: 'Smart Pred turned negative',
                        color: 'bg-orange-600'
                    });
                }
                
                if (row.recoveryFactor < 1.5 && previousRow.recoveryFactor >= 1.5) {
                    triggers.push({
                        level: 'WARNING',
                        type: 'RF_DECLINE',
                        icon: '‚ö†Ô∏è',
                        message: `RF dropped below 1.5 (was ${previousRow.recoveryFactor.toFixed(2)})`,
                        color: 'bg-orange-600'
                    });
                }
                
                if (row.plPercent >= 30 && previousRow.plPercent < 30) {
                    triggers.push({
                        level: 'OPPORTUNITY',
                        type: 'PROFIT_MILESTONE',
                        icon: 'üí∞',
                        message: '30% profit reached',
                        color: 'bg-yellow-600'
                    });
                }
                
                return triggers;
            };

            const snapshotsWithCalcs = useMemo(() => {
                const sorted = [...snapshots].sort((a, b) => `${b.trader}-${b.account}-${b.date}`.localeCompare(`${a.trader}-${a.account}-${a.date}`));
                const byKey = {};
                sorted.forEach(s => {
                    const k = `${s.trader}-${s.account}`;
                    if (!byKey[k]) byKey[k] = [];
                    byKey[k].push(s);
                });
                Object.values(byKey).forEach(snaps => {
                    snaps.sort((a, b) => parseDate(a.date) - parseDate(b.date));
                    let maxEq = 0;
                    snaps.forEach(s => {
                        maxEq = Math.max(maxEq, s.equity);
                        s.runningMaxEquity = maxEq;
                        s.currentDrawdown = maxEq > 0 ? ((maxEq - s.equity) / maxEq) * 100 : 0;
                    });
                });
                return sorted.map((snap, i) => {
                    const prev = sorted.slice(i + 1).find(s => s.trader === snap.trader && s.account === snap.account);
                    const flow = transactions.filter(t => t.trader === snap.trader && t.account === snap.account &&
                        (!prev || parseDate(t.date) > parseDate(prev.date)) && parseDate(t.date) <= parseDate(snap.date)
                    ).reduce((sum, t) => sum + (t.type === 'DEPOSIT' ? t.amount : t.type === 'WITHDRAWAL' ? -t.amount : 0), 0);
                    const pnl = snap.equity - (prev ? prev.equity : 0) - flow;
                    const days = prev ? daysBetween(snap.date, prev.date) : 0;
                    return { ...snap, prevDate: prev?.date || '', flowSinceLast: flow, prevEquity: prev?.equity || 0, pnlPeriod: pnl, daysSincePrev: days, plPerDay: days > 0 ? pnl / days : 0 };
                });
            }, [snapshots, transactions]);

            const dashboardData = useMemo(() => {
                const pairs = new Map();
                snapshotsWithCalcs.forEach(s => {
                    const k = `${s.trader}-${s.account}`;
                    if (!pairs.has(k) || parseDate(s.date) > parseDate(pairs.get(k).date)) pairs.set(k, s);
                });
                let data = Array.from(pairs.values()).map(s => {
                    const txs = transactions.filter(t => t.trader === s.trader && t.account === s.account);
                    const netInv = txs.reduce((sum, t) => sum + (t.type === 'DEPOSIT' ? t.amount : t.type === 'WITHDRAWAL' ? -t.amount : 0), 0);
                    const pl = s.equity - netInv;
                    const plPct = netInv > 0 ? (pl / netInv) * 100 : 0;
                    const firstDate = txs.length ? txs.reduce((e, t) => parseDate(t.date) < parseDate(e.date) ? t : e).date : s.date;
                    const days = daysBetween(new Date().toISOString().split('T')[0].replace(/-/g, '.'), firstDate) + 1;
                    const tSnaps = snapshotsWithCalcs.filter(x => x.trader === s.trader && x.account === s.account).sort((a, b) => parseDate(b.date) - parseDate(a.date));
                    const last3 = tSnaps.slice(0, 3).filter(x => x.plPerDay !== 0);
                    const dds = tSnaps.map(x => x.currentDrawdown || 0).filter(d => d > 0);
                    const traderStatus = getTraderStatus(s.trader, s.account);
                    const row = {
                        trader: s.trader, account: s.account, latestDate: s.date, equity: s.equity, netInvested: netInv, pl, plPercent: plPct,
                        currentDailyPL3pt: last3.length ? last3.reduce((sum, x) => sum + x.plPerDay, 0) / last3.length : null,
                        currentDailyPL3ptDays: last3.length, dailyPLSinceStart: days > 0 ? pl / days : 0,
                        estDailyPL: weightedAverage(tSnaps), dailyPlPercentSinceStart: days > 0 ? plPct / days : 0, daysSinceStart: days,
                        currentDrawdown: s.currentDrawdown || 0, maxDrawdown: dds.length ? Math.max(...dds) : 0,
                        avgDrawdown: dds.length ? dds.reduce((a, b) => a + b, 0) / dds.length : 0,
                        recoveryFactor: dds.length && Math.max(...dds) > 0 ? plPct / Math.max(...dds) : 0,
                        traderStatus
                    };
                    row.warnings = getWarnings(row);
                    row.decision = getTradeDecision(row);
                    
                    try {
                        row.activityInfo = getTraderActivityStatus(row.trader, row.account, snapshotsWithCalcs);
                    } catch (e) {
                        console.error('Activity status error:', e);
                        row.activityInfo = {
                            status: 'INSUFFICIENT_DATA',
                            color: 'text-slate-500',
                            metrics: { avgAbsDailyPL: '0', activityRatio: '0%' }
                        };
                    }
                    
                    try {
                        row.entrySignal = getEntrySignal(row);
                    } catch (e) {
                        console.error('Entry signal error:', e);
                        row.entrySignal = { type: 'NO_ENTRY', strength: 'NONE', color: 'bg-gray-600', icon: '‚õî' };
                    }
                    
                    try {
                        row.exitSignal = getExitSignal(row);
                    } catch (e) {
                        console.error('Exit signal error:', e);
                        row.exitSignal = null;
                    }
                    
                    try {
                        row.actionSignal = getActionSignal(row);
                    } catch (e) {
                        console.error('Action signal error:', e);
                        row.actionSignal = { type: 'MONITOR', color: 'bg-slate-500', icon: 'üëÅÔ∏è' };
                    }
                    
                    try {
                        row.rfAssessment = getRFAssessment(row);
                    } catch (e) {
                        console.error('RF assessment error:', e);
                        row.rfAssessment = { grade: 'N/A', label: 'UNKNOWN', color: 'text-slate-500 bg-slate-100', icon: '?' };
                    }
                    
                    try {
                        row.ddAssessment = getDDAssessment(row);
                    } catch (e) {
                        console.error('DD assessment error:', e);
                        row.ddAssessment = {
                            currentLevel: { label: 'UNKNOWN', color: 'text-slate-500' },
                            maxLevel: { label: 'UNKNOWN', color: 'text-slate-500' },
                            overallRisk: 'UNKNOWN'
                        };
                    }
                    
                    try {
                        const prevRow = previousDataRef.current?.find(p => p.trader === row.trader && p.account === row.account);
                        row.triggers = detectTriggers(row, prevRow);
                    } catch (e) {
                        console.error('Trigger detection error:', e);
                        row.triggers = [];
                    }
                    
                    return row;
                });
                
                data = accountFilter === 'All' ? data : data.filter(d => d.account === accountFilter);
                Object.keys(filters).forEach(col => {
                    const f = filters[col];
                    if (f?.enabled) {
                        data = data.filter(row => {
                            if (f.type === 'range') {
                                const min = f.min !== '' ? parseFloat(f.min) : -Infinity;
                                const max = f.max !== '' ? parseFloat(f.max) : Infinity;
                                return row[col] >= min && row[col] <= max;
                            }
                            if (f.type === 'text') return row[col].toLowerCase().includes(f.value.toLowerCase());
                            if (f.type === 'select') {
                                if (col === 'decision') return row.decision === f.value;
                                if (col === 'warnings') return f.value === 'Has Warning' ? row.warnings.length > 0 : row.warnings.length === 0;
                                if (col === 'entrySignal') return row.entrySignal && row.entrySignal.type === f.value;
                                if (col === 'exitSignal') return row.exitSignal && row.exitSignal.urgency === f.value;
                                if (col === 'actionSignal') return row.actionSignal && row.actionSignal.type === f.value;
                                if (col === 'rfGrade') return row.rfAssessment && row.rfAssessment.grade === f.value;
                                if (col === 'ddRisk') return row.ddAssessment && row.ddAssessment.overallRisk === f.value;
                                if (col === 'activity') return row.activityInfo && row.activityInfo.status === f.value;
                                if (col === 'status') return row.traderStatus && row.traderStatus.status === f.value;
                            }
                            return true;
                        });
                    }
                });
                data.sort((a, b) => {
                    let av = a[sortColumn], bv = b[sortColumn];
                    if (sortColumn === 'warnings') {
                        av = a.warnings.length;
                        bv = b.warnings.length;
                    }
                    if (sortColumn === 'activity') {
                        av = a.activityInfo?.status || '';
                        bv = b.activityInfo?.status || '';
                    }
                    if (sortColumn === 'rfGrade') {
                        av = a.rfAssessment?.grade || '';
                        bv = b.rfAssessment?.grade || '';
                    }
                    if (sortColumn === 'ddRisk') {
                        av = a.ddAssessment?.overallRisk || '';
                        bv = b.ddAssessment?.overallRisk || '';
                    }
                    if (sortColumn === 'entrySignal') {
                        av = a.entrySignal?.type || '';
                        bv = b.entrySignal?.type || '';
                    }
                    if (sortColumn === 'exitSignal') {
                        av = a.exitSignal?.urgency || '';
                        bv = b.exitSignal?.urgency || '';
                    }
                    if (sortColumn === 'actionSignal') {
                        av = a.actionSignal?.type || '';
                        bv = b.actionSignal?.type || '';
                    }
                    if (sortColumn === 'status') {
                        av = a.traderStatus?.status || '';
                        bv = b.traderStatus?.status || '';
                    }
                    if (typeof av === 'string') return sortDirection === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
                    if (av === null) av = -Infinity;
                    if (bv === null) bv = -Infinity;
                    return sortDirection === 'asc' ? av - bv : bv - av;
                });
                
                previousDataRef.current = data;
                return data;
            }, [snapshotsWithCalcs, transactions, accountFilter, filters, sortColumn, sortDirection, traderStatuses]);

            useEffect(() => {
                const createAlerts = async () => {
                    if (!dashboardData || dashboardData.length === 0) return;
                    
                    // Wait for alerts cache to load before creating alerts
                    if (!alertsCacheLoaded) {
                        console.log('‚è≥ Waiting for alerts cache to load...');
                        return;
                    }
                    
                    try {
                        await circuitBreaker(async () => {
                            const { collection, addDoc } = window.firebaseUtils;
                            const db = window.firebaseDb;
                            
                            // Collect all triggers with timestamps
                            const allTriggersWithTimestamps = [];
                            for (const row of dashboardData) {
                                if (row.triggers && Array.isArray(row.triggers) && row.triggers.length > 0) {
                                    for (const trigger of row.triggers) {
                                        if (trigger && (trigger.level === 'CRITICAL' || trigger.level === 'WARNING')) {
                                            allTriggersWithTimestamps.push({
                                                trader: row.trader,
                                                account: row.account,
                                                trigger,
                                                timestamp: new Date().toISOString()
                                            });
                                        }
                                    }
                                }
                            }
                            
                            // Filter only new triggers (timestamp > lastProcessed)
                            const lastProcessed = lastProcessedTimestampRef.current;
                            const newTriggers = lastProcessed 
                                ? allTriggersWithTimestamps.filter(t => t.timestamp > lastProcessed)
                                : allTriggersWithTimestamps;
                            
                            // Dynamic burst protection - prevent duplicate alerts
                            const uniqueTriggers = new Map();
                            for (const item of newTriggers) {
                                const key = `${item.trader}-${item.account}-${item.trigger.type}-${item.trigger.level}`;
                                if (!uniqueTriggers.has(key)) {
                                    uniqueTriggers.set(key, item);
                                }
                            }
                            
                            const deduplicatedTriggers = Array.from(uniqueTriggers.values());
                            
                            if (deduplicatedTriggers.length !== newTriggers.length) {
                                console.warn(`‚ö†Ô∏è Deduplicated ${newTriggers.length - deduplicatedTriggers.length} duplicate triggers`);
                            }
                            
                            const burstThreshold = Math.max(deduplicatedTriggers.length * 1.5, 10);
                            
                            if (deduplicatedTriggers.length > burstThreshold) {
                                console.warn(`‚ö†Ô∏è Alert burst detected: ${deduplicatedTriggers.length} > ${burstThreshold}. Skipping alert creation.`);
                                return;
                            }
                            
                            // Process only deduplicated new triggers
                            let createdCount = 0;
                            for (const item of deduplicatedTriggers) {
                                const alertKey = `${item.trader}-${item.account}-${item.trigger.type}-${item.trigger.level}`;
                                const dismissKey = `${item.trader}-${item.account}-${item.trigger.type}`;
                                
                                if (!alertsCache.has(alertKey) && !dismissedAlerts.includes(dismissKey)) {
                                    await rateLimitedWrite(async () => {
                                        await addDoc(collection(db, 'alerts'), {
                                            trader: item.trader,
                                            account: item.account,
                                            level: item.trigger.level,
                                            type: item.trigger.type,
                                            message: item.trigger.message,
                                            timestamp: item.timestamp,
                                            read: false,
                                            securityKey: window.SECURITY_KEY
                                        });
                                        createdCount++;
                                        console.log(`‚úÖ Alert created: ${item.trader} - ${item.trigger.type}`);
                                    });
                                }
                            }
                            
                            // Update lastProcessedTimestamp and persist to Firebase
                            if (allTriggersWithTimestamps.length > 0) {
                                const latestTimestamp = Math.max(...allTriggersWithTimestamps.map(t => new Date(t.timestamp).getTime()));
                                const newTimestamp = new Date(latestTimestamp).toISOString();
                                lastProcessedTimestampRef.current = newTimestamp;
                                
                                await updateLastProcessedTimestamp(newTimestamp);
                            }
                            
                            if (createdCount > 0) {
                                console.log(`üìä Alert creation summary: ${createdCount} new alerts created`);
                            }
                        }, 'Alert creation');
                    } catch (e) {
                        console.error('Alert creation failed:', e);
                    }
                };
                
                const timeout = setTimeout(createAlerts, 3000);
                return () => clearTimeout(timeout);
            }, [snapshots.length, transactions.length, alertsCache, dismissedAlerts, alertsCacheLoaded]);

            const runIntegrityCheck = async () => {
                setIsCheckingIntegrity(true);
                
                try {
                    await circuitBreaker(async () => {
                        const now = Date.now();
                        const thirtyDaysAgo = now - (30 * 24 * 60 * 60 * 1000);
                        
                        const recentTx = transactions.filter(t => parseDate(t.date) >= new Date(thirtyDaysAgo));
                        const recentSnaps = snapshots.filter(s => parseDate(s.date) >= new Date(thirtyDaysAgo));
                        
                        const issues = {
                            transactions: [],
                            snapshots: [],
                            alerts: [],
                            views: []
                        };
                        
                        const txMap = new Map();
                        for (const tx of recentTx) {
                            const key = `${tx.trader}-${tx.account}-${tx.date}-${tx.amount}-${tx.type}`;
                            if (txMap.has(key)) {
                                issues.transactions.push({
                                    severity: 'WARNING',
                                    type: 'DUPLICATE',
                                    message: `Duplicate transaction detected`,
                                    data: { trader: tx.trader, date: tx.date, amount: tx.amount },
                                    autoFixable: false
                                });
                            }
                            txMap.set(key, tx);
                            
                            if (parseDate(tx.date) > new Date()) {
                                issues.transactions.push({
                                    severity: 'WARNING',
                                    type: 'FUTURE_DATE',
                                    message: `Transaction dated in the future`,
                                    data: { trader: tx.trader, date: tx.date },
                                    autoFixable: false
                                });
                            }
                            
                            if (tx.amount < 0) {
                                issues.transactions.push({
                                    severity: 'CRITICAL',
                                    type: 'NEGATIVE_AMOUNT',
                                    message: `Negative transaction amount`,
                                    data: { trader: tx.trader, date: tx.date, amount: tx.amount },
                                    autoFixable: false
                                });
                            }
                        }
                        
                        const snapMap = new Map();
                        for (const snap of recentSnaps) {
                            const key = `${snap.trader}-${snap.account}-${snap.date}`;
                            if (snapMap.has(key)) {
                                issues.snapshots.push({
                                    severity: 'WARNING',
                                    type: 'DUPLICATE',
                                    message: `Duplicate snapshot detected`,
                                    data: { trader: snap.trader, date: snap.date },
                                    autoFixable: false
                                });
                            }
                            snapMap.set(key, snap);
                            
                            if (snap.equity < 0) {
                                issues.snapshots.push({
                                    severity: 'CRITICAL',
                                    type: 'NEGATIVE_EQUITY',
                                    message: `Negative equity value`,
                                    data: { trader: snap.trader, date: snap.date, equity: snap.equity },
                                    autoFixable: false
                                });
                            }
                            
                            const hasTx = transactions.some(t => t.trader === snap.trader && t.account === snap.account);
                            if (!hasTx) {
                                issues.snapshots.push({
                                    severity: 'WARNING',
                                    type: 'ORPHAN',
                                    message: `Snapshot exists without any transactions`,
                                    data: { trader: snap.trader, account: snap.account },
                                    autoFixable: false
                                });
                            }
                        }
                        
                        for (const alert of alerts) {
                            const traderExists = dashboardData.find(d => 
                                d.trader === alert.trader && d.account === alert.account
                            );
                            
                            if (!traderExists) {
                                issues.alerts.push({
                                    severity: 'WARNING',
                                    type: 'NON_EXISTENT_TRADER',
                                    message: `Alert references removed trader`,
                                    data: { trader: alert.trader, account: alert.account, alertId: alert.id },
                                    autoFixable: true
                                });
                                continue;
                            }
                            
                            const row = traderExists;
                            const triggerActive = row.triggers?.some(t => 
                                t.type === alert.type && t.level === alert.level
                            );
                            
                            if (!triggerActive) {
                                const alertAge = now - new Date(alert.timestamp).getTime();
                                const daysOld = Math.floor(alertAge / (24 * 60 * 60 * 1000));
                                const alertAgeHours = alertAge / (1000 * 60 * 60);
                                
                                // Only mark as stale if trigger is inactive AND older than 2 hours
                                if (alertAgeHours >= 2) {
                                    issues.alerts.push({
                                        severity: 'INFO',
                                        type: 'STALE',
                                        message: `Alert trigger no longer active (${daysOld} days old, ${alertAgeHours.toFixed(1)}h)`,
                                        data: { trader: alert.trader, level: alert.level, type: alert.type, alertId: alert.id, age: daysOld, ageHours: alertAgeHours.toFixed(1) },
                                        autoFixable: true
                                    });
                                }
                            }
                        }
                        
                        const validColumnNames = Object.keys(visibleColumns);
                        for (const view of savedViews) {
                            if (view.visibleColumns) {
                                const invalidCols = Object.keys(view.visibleColumns).filter(
                                    col => !validColumnNames.includes(col)
                                );
                                
                                if (invalidCols.length > 0) {
                                    issues.views.push({
                                        severity: 'WARNING',
                                        type: 'INVALID_COLUMNS',
                                        message: `View contains invalid column names`,
                                        data: { viewName: view.name, invalidColumns: invalidCols },
                                        autoFixable: false
                                    });
                                }
                            }
                            
                            if (view.name !== 'Default') {
                                const lastUsed = new Date(view.lastUsed);
                                const daysSinceUsed = Math.floor((now - lastUsed.getTime()) / (24 * 60 * 60 * 1000));
                                
                                if (daysSinceUsed > 30) {
                                    issues.views.push({
                                        severity: 'INFO',
                                        type: 'ORPHAN_VIEW',
                                        message: `View not used in ${daysSinceUsed} days`,
                                        data: { viewName: view.name, viewId: view.id, daysSinceUsed },
                                        autoFixable: false
                                    });
                                }
                            }
                        }
                        
                        const totalIssues = 
                            issues.transactions.length + 
                            issues.snapshots.length + 
                            issues.alerts.length + 
                            issues.views.length;
                        
                        const criticalCount = [
                            ...issues.transactions,
                            ...issues.snapshots,
                            ...issues.alerts,
                            ...issues.views
                        ].filter(i => i.severity === 'CRITICAL').length;
                        
                        const warningCount = [
                            ...issues.transactions,
                            ...issues.snapshots,
                            ...issues.alerts,
                            ...issues.views
                        ].filter(i => i.severity === 'WARNING').length;
                        
                        setIntegrityReport({
                            summary: {
                                total: totalIssues,
                                critical: criticalCount,
                                warnings: warningCount,
                                info: totalIssues - criticalCount - warningCount
                            },
                            details: issues
                        });
                        
                        setLastIntegrityCheck(new Date().toISOString());
                    }, 'Integrity check');
                } catch (e) {
                    console.error('Integrity check failed:', e);
                    alert('Integrity check failed: ' + e.message);
                } finally {
                    setIsCheckingIntegrity(false);
                }
            };

            const autoCleanupIssues = async () => {
                if (!integrityReport) return;
                
                if (!confirm('Auto-cleanup will remove stale alerts and non-existent trader alerts. Continue?')) {
                    return;
                }
                
                try {
                    await circuitBreaker(async () => {
                        const { deleteDoc, doc } = window.firebaseUtils;
                        const db = window.firebaseDb;
                        
                        let cleanedCount = 0;
                        
                        const autoFixableAlerts = integrityReport.details.alerts.filter(i => i.autoFixable);
                        
                        for (const issue of autoFixableAlerts) {
                            if (issue.data.alertId) {
                                await rateLimitedWrite(async () => {
                                    await deleteDoc(doc(db, 'alerts', issue.data.alertId));
                                });
                                cleanedCount++;
                            }
                        }
                        
                        alert(`‚úÖ Auto-cleanup completed! Removed ${cleanedCount} stale/invalid alerts.`);
                        runIntegrityCheck();
                    }, 'Auto cleanup');
                } catch (e) {
                    console.error('Auto-cleanup failed:', e);
                    alert('Auto-cleanup failed: ' + e.message);
                }
            };

            const totals = useMemo(() => ({
                pl: dashboardData.reduce((s, d) => s + d.pl, 0),
                dailyPLSinceStart: dashboardData.reduce((s, d) => s + d.dailyPLSinceStart, 0),
                estDailyPL: dashboardData.reduce((s, d) => s + d.estDailyPL, 0)
            }), [dashboardData]);

            const signalSummary = useMemo(() => ({
                strongEntry: dashboardData.filter(d => d.entrySignal && d.entrySignal.type === 'CONSERVATIVE_ENTRY').length,
                exitAlerts: dashboardData.filter(d => d.exitSignal && d.exitSignal.urgency === 'IMMEDIATE').length,
                increaseCandidates: dashboardData.filter(d => d.actionSignal && d.actionSignal.type === 'INCREASE').length,
                activeTriggers: dashboardData.reduce((sum, d) => sum + (d.triggers?.length || 0), 0)
            }), [dashboardData]);

            const traderNames = useMemo(() => [...new Set(transactions.map(t => t.trader))].sort(), [transactions]);

            const handleSort = (col) => {
                if (sortColumn === col) setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                else { setSortColumn(col); setSortDirection('asc'); }
            };

            const handleSnapshotSort = (col) => {
                if (snapshotSortColumn === col) setSnapshotSortDirection(snapshotSortDirection === 'asc' ? 'desc' : 'asc');
                else { setSnapshotSortColumn(col); setSnapshotSortDirection('asc'); }
            };

            const updateFilter = (col, data) => setFilters(prev => ({ ...prev, [col]: data }));
            const clearFilters = () => setFilters({});

            const dismissAlert = async (id) => {
                try {
                    await circuitBreaker(async () => {
                        const { deleteDoc, doc, setDoc, getDoc } = window.firebaseUtils;
                        const db = window.firebaseDb;
                        
                        const alert = alerts.find(a => a.id === id);
                        if (!alert) return;
                        
                        await rateLimitedWrite(async () => {
                            await deleteDoc(doc(db, 'alerts', id));
                        });
                        
                        const dismissedKey = `${alert.trader}-${alert.account}-${alert.type}`;
                        const newDismissedAlerts = [...dismissedAlerts, dismissedKey];
                        setDismissedAlerts(newDismissedAlerts);
                        
                        await rateLimitedWrite(async () => {
                            const prefDocRef = doc(db, 'user_preferences', 'default');
                            const prefDoc = await getDoc(prefDocRef);
                            trackRead();
                            
                            if (prefDoc.exists()) {
                                await setDoc(prefDocRef, {
                                    ...prefDoc.data(),
                                    dismissedAlerts: newDismissedAlerts
                                });
                            } else {
                                await setDoc(prefDocRef, {
                                    dismissedAlerts: newDismissedAlerts,
                                    securityKey: window.SECURITY_KEY
                                });
                            }
                        });
                        
                        console.log(`‚úÖ Alert dismissed: ${dismissedKey}`);
                    }, 'Dismiss alert');
                } catch (e) {
                    console.error('Dismiss failed:', e);
                    alert('Dismiss failed: ' + e.message);
                }
            };

            const deleteTransaction = async (id, trader, date) => {
                if (!confirm(`Delete transaction for ${trader} on ${date}?`)) return;
                try {
                    await circuitBreaker(async () => {
                        await rateLimitedWrite(async () => {
                            const { deleteDoc, doc } = window.firebaseUtils;
                            const db = window.firebaseDb;
                            await deleteDoc(doc(db, 'transactions', id));
                            alert('‚úÖ Transaction deleted successfully!');
                        });
                    }, 'Delete transaction');
                } catch (e) {
                    console.error('Delete error:', e);
                    alert('Delete failed: ' + e.message);
                }
            };

            const deleteSnapshot = async (id, trader, date) => {
                if (!confirm(`Delete snapshot for ${trader} on ${date}?`)) return;
                try {
                    await circuitBreaker(async () => {
                        await rateLimitedWrite(async () => {
                            const { deleteDoc, doc } = window.firebaseUtils;
                            const db = window.firebaseDb;
                            await deleteDoc(doc(db, 'snapshots', id));
                            alert('‚úÖ Snapshot deleted successfully!');
                        });
                    }, 'Delete snapshot');
                } catch (e) {
                    console.error('Delete error:', e);
                    alert('Delete failed: ' + e.message);
                }
            };

            const saveTraderStatus = async () => {
                if (!traderStatusForm.trader || !traderStatusForm.account) {
                    alert('Please select trader and account');
                    return;
                }
                
                try {
                    await circuitBreaker(async () => {
                        const { collection, addDoc, getDocs, query, where, updateDoc, doc } = window.firebaseUtils;
                        const db = window.firebaseDb;
                        
                        const q = query(
                            collection(db, 'trader_status'),
                            where('trader', '==', traderStatusForm.trader),
                            where('account', '==', traderStatusForm.account)
                        );
                        const existing = await getDocs(q);
                        trackRead();
                        
                        const statusData = {
                            trader: traderStatusForm.trader,
                            account: traderStatusForm.account,
                            status: traderStatusForm.status,
                            reason: traderStatusForm.reason,
                            timestamp: new Date().toISOString(),
                            securityKey: window.SECURITY_KEY
                        };
                        
                        await rateLimitedWrite(async () => {
                            if (!existing.empty) {
                                await updateDoc(doc(db, 'trader_status', existing.docs[0].id), statusData);
                            } else {
                                await addDoc(collection(db, 'trader_status'), statusData);
                            }
                        });
                        
                        setShowTraderStatusDialog(false);
                        setTraderStatusForm({ trader: '', account: '', status: 'ACTIVE', reason: '' });
                        
                        alert('‚úÖ Trader status updated!');
                    }, 'Save trader status');
                } catch (e) {
                    console.error('Status update failed:', e);
                    alert('Failed to update status: ' + e.message);
                }
            };

            const getDecisionStyle = (decision) => {
                switch(decision) {
                    case 'BUY': return { bg: 'bg-green-600', text: '‚ñ≤ BUY' };
                    case 'SELL': return { bg: 'bg-red-600', text: '‚ñº SELL' };
                    case 'HOLD': return { bg: 'bg-yellow-600', text: '‚ñ† HOLD' };
                    case 'PAUSED': return { bg: 'bg-gray-600', text: '‚è∏Ô∏è PAUSED' };
                    default: return { bg: 'bg-slate-600', text: '- N/A' };
                }
            };

            const getRowClasses = (row) => {
                const classes = ['border-b', 'border-slate-700/50', 'hover:bg-slate-700/30'];
                
                if (row.traderStatus.status === 'PAUSED') {
                    classes.push('bg-slate-800/50', 'opacity-70');
                } else if (row.exitSignal && row.exitSignal.urgency === 'IMMEDIATE') {
                    classes.push('bg-red-900/20', 'border-l-4', 'border-l-red-600');
                } else if (row.entrySignal && row.entrySignal.type === 'CONSERVATIVE_ENTRY') {
                    classes.push('bg-emerald-900/10', 'border-l-4', 'border-l-emerald-600');
                } else if (row.exitSignal && row.exitSignal.urgency === 'MODERATE') {
                    classes.push('bg-orange-900/10', 'border-l-4', 'border-l-orange-600');
                }
                
                return classes.join(' ');
            };

            const addData = async () => {
                console.log('üîµ addData called, dataType:', newData.dataType);
                console.log('üîµ Data to save:', newData);
                
                try {
                    await circuitBreaker(async () => {
                        if (newData.dataType === 'snapshot') {
                            if (!newData.trader) {
                                alert('‚ö†Ô∏è Trader is required!');
                                return;
                            }
                            if (!newData.equity || isNaN(parseFloat(newData.equity))) {
                                alert('‚ö†Ô∏è Valid equity value is required!');
                                return;
                            }
                            
                            console.log('üü¢ Validation passed, saving snapshot...');
                            
                            await rateLimitedWrite(async () => {
                                const { collection, addDoc } = window.firebaseUtils;
                                const db = window.firebaseDb;
                                const docRef = await addDoc(collection(db, 'snapshots'), {
                                    date: newData.date,
                                    trader: newData.trader,
                                    account: newData.account,
                                    equity: parseFloat(newData.equity),
                                    securityKey: window.SECURITY_KEY,
                                    timestamp: new Date().toISOString()
                                });
                                
                                console.log('‚úÖ SNAPSHOT SAVED! ID:', docRef.id);
                                alert(`‚úÖ Snapshot saved! ID: ${docRef.id}`);
                                setNewData({...newData, equity: ''});
                            });
                        } else if (newData.dataType === 'transaction' && newData.trader && newData.amount) {
                            await rateLimitedWrite(async () => {
                                const { collection, addDoc } = window.firebaseUtils;
                                const db = window.firebaseDb;
                                const docRef = await addDoc(collection(db, 'transactions'), {
                                    date: newData.date,
                                    trader: newData.trader,
                                    account: newData.account,
                                    amount: parseFloat(newData.amount),
                                    type: newData.transactionType,
                                    note: newData.note,
                                    securityKey: window.SECURITY_KEY,
                                    timestamp: new Date().toISOString()
                                });
                                console.log('‚úÖ TRANSACTION SAVED! ID:', docRef.id);
                                alert(`‚úÖ Transaction saved!`);
                            });
                        }
                    }, 'Add data');
                } catch (e) {
                    console.error('‚ùå SAVE FAILED:', e);
                    console.error('Error details:', {
                        message: e.message,
                        code: e.code,
                        stack: e.stack
                    });
                    alert(`‚ùå Failed: ${e.message}`);
                }
            };

            const getHeatmap = (v, vals) => {
                if (!vals.length) return 'bg-slate-600';
                const valid = vals.filter(x => !isNaN(x) && isFinite(x));
                if (!valid.length) return 'bg-slate-600';
                const min = Math.min(...valid), max = Math.max(...valid);
                if (min === max) return v >= 0 ? 'bg-green-500' : 'bg-red-500';
                const norm = (v - min) / (max - min);
                const cols = ['bg-red-900', 'bg-red-800', 'bg-red-700', 'bg-red-600', 'bg-red-500', 'bg-green-500', 'bg-green-600', 'bg-green-700', 'bg-green-800', 'bg-green-900'];
                return cols[Math.max(0, Math.min(cols.length - 1, Math.floor(norm * (cols.length - 1))))];
            };

            const getDD = (v, vals) => {
                if (!vals.length) return 'bg-slate-600';
                const valid = vals.filter(x => !isNaN(x) && isFinite(x));
                if (!valid.length) return 'bg-slate-600';
                const min = Math.min(...valid), max = Math.max(...valid);
                if (min === max) return v <= 5 ? 'bg-green-500' : 'bg-red-500';
                const norm = 1 - ((v - min) / (max - min));
                const cols = ['bg-red-900', 'bg-red-800', 'bg-red-700', 'bg-red-600', 'bg-red-500', 'bg-green-500', 'bg-green-600', 'bg-green-700', 'bg-green-800', 'bg-green-900'];
                return cols[Math.max(0, Math.min(cols.length - 1, Math.floor(norm * (cols.length - 1))))];
            };

            const getBorder = (d) => d === 3 ? 'border-l-green-500' : d === 2 ? 'border-l-yellow-500' : d === 1 ? 'border-l-orange-500' : '';

            const vals = { pl: dashboardData.map(d => d.pl), plPct: dashboardData.map(d => d.plPercent),
                daily: dashboardData.map(d => d.currentDailyPL3pt).filter(v => v !== null),
                dailyStart: dashboardData.map(d => d.dailyPLSinceStart), est: dashboardData.map(d => d.estDailyPL),
                dailyPct: dashboardData.map(d => d.dailyPlPercentSinceStart), curr: dashboardData.map(d => d.currentDrawdown),
                max: dashboardData.map(d => d.maxDrawdown), avg: dashboardData.map(d => d.avgDrawdown),
                rec: dashboardData.map(d => d.recoveryFactor) };

            const exportXLSX = (type) => {
                const wb = XLSX.utils.book_new();
                if (type === 'all' || type === 'transactions') {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(transactions.map(t => ({
                        Date: t.date, Trader: t.trader, Account: t.account, Amount: t.amount, Type: t.type, Note: t.note
                    }))), 'Transactions');
                }
                if (type === 'all' || type === 'snapshots') {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(snapshotsWithCalcs.map(s => ({
                        Date: s.date, Trader: s.trader, Account: s.account, Equity: s.equity, Max: s.runningMaxEquity,
                        DD: s.currentDrawdown, PrevDate: s.prevDate, Flow: s.flowSinceLast, PrevEq: s.prevEquity,
                        PnL: s.pnlPeriod, Days: s.daysSincePrev, PLperDay: s.plPerDay
                    }))), 'Snapshots');
                }
                if (type === 'all' || type === 'dashboard') {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dashboardData.map(d => ({
                        Trader: d.trader, Account: d.account, Status: d.traderStatus.status, Date: d.latestDate, Equity: d.equity, NetInv: d.netInvested,
                        PL: d.pl, PLPct: d.plPercent, RecentPL: d.currentDailyPL3pt,
                        Days: d.currentDailyPL3ptDays, DailyStart: d.dailyPLSinceStart, Smart: d.estDailyPL,
                        DailyPct: d.dailyPlPercentSinceStart, CurrDD: d.currentDrawdown, MaxDD: d.maxDrawdown, 
                        AvgDD: d.avgDrawdown, RecFac: d.recoveryFactor, 
                        Activity: d.activityInfo?.status || 'N/A', 
                        ActivityPL: d.activityInfo?.metrics?.avgAbsDailyPL || '0',
                        RF_Grade: d.rfAssessment?.grade || 'N/A', 
                        DD_Risk: d.ddAssessment?.overallRisk || 'N/A',
                        Entry_Signal: d.entrySignal?.type || 'NONE', 
                        Exit_Signal: d.exitSignal?.type || 'NONE',
                        Action: d.actionSignal?.type || 'NONE', 
                        Triggers: d.triggers?.length || 0,
                        Warnings: d.warnings.join(', '), Decision: d.decision
                    }))), 'Dashboard');
                }
                XLSX.writeFile(wb, `etoro_advanced_${type}_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const sortedSnapshots = useMemo(() => {
                return [...snapshotsWithCalcs].sort((a, b) => {
                    let av = a[snapshotSortColumn];
                    let bv = b[snapshotSortColumn];
                    
                    if (snapshotSortColumn === 'date') {
                        av = parseDate(a.date);
                        bv = parseDate(b.date);
                    }
                    
                    if (typeof av === 'string') {
                        return snapshotSortDirection === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
                    }
                    
                    if (av === null || av === undefined) av = -Infinity;
                    if (bv === null || bv === undefined) bv = -Infinity;
                    
                    return snapshotSortDirection === 'asc' ? av - bv : bv - av;
                });
            }, [snapshotsWithCalcs, snapshotSortColumn, snapshotSortDirection]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-6">
                    <div className="max-w-full mx-auto">
                        <div className="mb-8">
                            <div className="flex justify-between items-center mb-2">
                                <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
                                    eToro Advanced Decision Dashboard v17
                                </h1>
                                <div className="flex gap-4 items-center">
                                    <QuotaMeter reads={quotaReads} writes={quotaWrites} />
                                    <AlertPanel alerts={alerts} onDismiss={dismissAlert} />
                                    <FirebaseStatus status={firebaseStatus} />
                                </div>
                            </div>
                            <p className="text-slate-400">Real-time Analytics - {transactions.length} txs, {snapshots.length} snaps, {alerts.filter(a => !a.read).length} alerts</p>
                        </div>

                        <div className="flex gap-2 mb-6 flex-wrap">
                            {['dashboard', 'transactions', 'snapshots', 'integrity'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)}
                                    className={`px-6 py-3 rounded-lg font-semibold ${activeTab === tab ? 'bg-blue-600 shadow-lg' : 'bg-slate-800 hover:bg-slate-700'}`}>
                                    {tab === 'integrity' ? (
                                        <span className="flex items-center gap-2">
                                            üîç Integrity
                                            {integrityReport && integrityReport.summary.total > 0 && (
                                                <span className="bg-orange-600 text-xs px-2 py-0.5 rounded-full">
                                                    {integrityReport.summary.total}
                                                </span>
                                            )}
                                        </span>
                                    ) : (
                                        tab.charAt(0).toUpperCase() + tab.slice(1)
                                    )}
                                </button>
                            ))}
                        </div>

                        {activeTab === 'integrity' && (
                            <div className="space-y-6">
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                    <div className="flex justify-between items-center mb-4">
                                        <div>
                                            <h2 className="text-2xl font-bold mb-2">Data Integrity Check</h2>
                                            <p className="text-slate-400 text-sm">
                                                Validates last 30 days of data for duplicates, errors, and inconsistencies
                                            </p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={runIntegrityCheck}
                                                disabled={isCheckingIntegrity}
                                                className="bg-blue-600 px-6 py-3 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                                                {isCheckingIntegrity ? '‚è≥ Checking...' : 'üîÑ Run Check'}
                                            </button>
                                            {integrityReport && integrityReport.summary.total > 0 && (
                                                <button 
                                                    onClick={autoCleanupIssues}
                                                    className="bg-green-600 px-6 py-3 rounded-lg font-semibold">
                                                    üßπ Auto-Cleanup
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {lastIntegrityCheck && (
                                        <div className="text-sm text-slate-400 mb-4">
                                            Last check: {new Date(lastIntegrityCheck).toLocaleString()}
                                        </div>
                                    )}
                                    
                                    {integrityReport && (
                                        <>
                                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                                <div className="bg-slate-700 rounded-lg p-4">
                                                    <div className="text-slate-400 text-xs mb-1">Total Issues</div>
                                                    <div className="text-3xl font-bold text-white">
                                                        {integrityReport.summary.total}
                                                    </div>
                                                </div>
                                                <div className="bg-red-900/30 rounded-lg p-4">
                                                    <div className="text-red-400 text-xs mb-1">Critical</div>
                                                    <div className="text-3xl font-bold text-red-400">
                                                        {integrityReport.summary.critical}
                                                    </div>
                                                </div>
                                                <div className="bg-orange-900/30 rounded-lg p-4">
                                                    <div className="text-orange-400 text-xs mb-1">Warnings</div>
                                                    <div className="text-3xl font-bold text-orange-400">
                                                        {integrityReport.summary.warnings}
                                                    </div>
                                                </div>
                                                <div className="bg-blue-900/30 rounded-lg p-4">
                                                    <div className="text-blue-400 text-xs mb-1">Info</div>
                                                    <div className="text-3xl font-bold text-blue-400">
                                                        {integrityReport.summary.info}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {integrityReport.summary.total === 0 ? (
                                                <div className="bg-green-900/20 border border-green-700 rounded-lg p-6 text-center">
                                                    <div className="text-4xl mb-2">‚úÖ</div>
                                                    <div className="text-xl font-semibold text-green-400">All Clear!</div>
                                                    <div className="text-slate-400 mt-2">No issues detected in the last 30 days</div>
                                                </div>
                                            ) : (
                                                <div className="space-y-4">
                                                    {Object.entries(integrityReport.details).map(([category, issues]) => (
                                                        issues.length > 0 && (
                                                            <div key={category} className="bg-slate-700 rounded-lg p-4">
                                                                <h3 className="text-lg font-semibold mb-3 capitalize">
                                                                    {category} ({issues.length})
                                                                </h3>
                                                                <div className="space-y-2">
                                                                    {issues.map((issue, idx) => (
                                                                        <div key={idx} className={`p-3 rounded-lg border-l-4 ${
                                                                            issue.severity === 'CRITICAL' ? 'bg-red-900/20 border-red-600' :
                                                                            issue.severity === 'WARNING' ? 'bg-orange-900/20 border-orange-600' :
                                                                            'bg-blue-900/20 border-blue-600'
                                                                        }`}>
                                                                            <div className="flex justify-between items-start">
                                                                                <div className="flex-1">
                                                                                    <div className="flex items-center gap-2 mb-1">
                                                                                        <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                                                                                            issue.severity === 'CRITICAL' ? 'bg-red-600' :
                                                                                            issue.severity === 'WARNING' ? 'bg-orange-600' :
                                                                                            'bg-blue-600'
                                                                                        } text-white`}>
                                                                                            {issue.severity}
                                                                                        </span>
                                                                                        <span className="text-xs px-2 py-0.5 bg-slate-600 rounded">
                                                                                            {issue.type}
                                                                                        </span>
                                                                                        {issue.autoFixable && (
                                                                                            <span className="text-xs px-2 py-0.5 bg-green-600 rounded">
                                                                                                AUTO-FIXABLE
                                                                                            </span>
                                                                                        )}
                                                                                    </div>
                                                                                    <div className="text-sm text-slate-300 mb-2">
                                                                                        {issue.message}
                                                                                    </div>
                                                                                    <div className="text-xs text-slate-400 font-mono">
                                                                                        {JSON.stringify(issue.data)}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )
                                                    ))}
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Total P/L</div>
                                        <div className={`text-2xl font-bold ${totals.pl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {totals.pl.toFixed(0)} Ft
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Daily P/L Since Start</div>
                                        <div className={`text-2xl font-bold ${totals.dailyPLSinceStart >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {totals.dailyPLSinceStart.toFixed(0)} Ft
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Avg Max DD</div>
                                        <div className="text-2xl font-bold text-orange-400">
                                            {dashboardData.length ? (dashboardData.reduce((s, d) => s + d.maxDrawdown, 0) / dashboardData.length).toFixed(2) : '0.00'}%
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Active Traders</div>
                                        <div className="text-2xl font-bold text-blue-400">{dashboardData.length}</div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-slate-800 rounded-xl p-4 border border-emerald-700">
                                        <div className="text-slate-400 text-xs mb-1">üíé Strong Entry Signals</div>
                                        <div className="text-2xl font-bold text-emerald-400">
                                            {signalSummary.strongEntry}
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-red-700">
                                        <div className="text-slate-400 text-xs mb-1">üö® Exit Alerts</div>
                                        <div className="text-2xl font-bold text-red-400">
                                            {signalSummary.exitAlerts}
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-green-700">
                                        <div className="text-slate-400 text-xs mb-1">üìà Increase Candidates</div>
                                        <div className="text-2xl font-bold text-green-400">
                                            {signalSummary.increaseCandidates}
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-orange-700">
                                        <div className="text-slate-400 text-xs mb-1">üîî Active Triggers</div>
                                        <div className="text-2xl font-bold text-orange-400">
                                            {signalSummary.activeTriggers}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-4 items-center bg-slate-800 rounded-xl p-4 border border-slate-700 flex-wrap">
                                    <span>Account:</span>
                                    <select value={accountFilter} onChange={(e) => setAccountFilter(e.target.value)}
                                        className="bg-slate-700 rounded-lg px-4 py-2">
                                        <option>All</option><option>Virtual</option><option>Real</option>
                                    </select>
                                    
                                    <div className="flex items-center gap-2">
                                        <span className="text-sm text-slate-400">Current View:</span>
                                        <select value={currentViewId || ''} onChange={(e) => {
                                            const view = savedViews.find(v => v.id === e.target.value);
                                            if (view) loadView(view);
                                        }}
                                        className="bg-slate-700 rounded-lg px-4 py-2">
                                            {savedViews.map(v => (
                                                <option key={v.id} value={v.id}>{v.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    
                                    <button onClick={() => setShowSaveViewDialog(true)}
                                        className="bg-purple-600 px-4 py-2 rounded-lg font-semibold">
                                        üíæ Save View As...
                                    </button>
                                    
                                    <button onClick={() => setShowFilters(!showFilters)}
                                        className={`px-4 py-2 rounded-lg font-semibold ${showFilters ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                        {showFilters ? 'Hide' : 'Show'} Filters ({Object.keys(filters).filter(k => filters[k]?.enabled).length})
                                    </button>
                                    {Object.keys(filters).some(k => filters[k]?.enabled) && (
                                        <button onClick={clearFilters} className="bg-orange-600 px-4 py-2 rounded-lg font-semibold">
                                            Clear Filters
                                        </button>
                                    )}
                                    <button onClick={() => setShowColumnSettings(!showColumnSettings)}
                                        className="bg-purple-600 px-4 py-2 rounded-lg font-semibold">
                                        ‚öôÔ∏è Columns
                                    </button>
                                    <button onClick={() => setShowTraderStatusDialog(true)}
                                        className="bg-indigo-600 px-4 py-2 rounded-lg font-semibold">
                                        ‚è∏Ô∏è Manage Status
                                    </button>
                                    <button onClick={() => exportXLSX('dashboard')} className="ml-auto bg-green-600 px-6 py-2 rounded-lg font-semibold">
                                        Export XLSX
                                    </button>
                                </div>

                                {showColumnSettings && (
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-lg font-semibold">Column Visibility</h3>
                                            <div className="flex gap-2">
                                                <button onClick={selectAllColumns} className="bg-green-600 px-4 py-2 rounded-lg font-semibold text-sm">
                                                    Select All
                                                </button>
                                                <button onClick={selectNoneColumns} className="bg-red-600 px-4 py-2 rounded-lg font-semibold text-sm">
                                                    Select None
                                                </button>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                                            {Object.keys(visibleColumns).map(col => (
                                                <label key={col} className="flex items-center gap-2 text-sm cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={visibleColumns[col]}
                                                        onChange={(e) => setVisibleColumns({...visibleColumns, [col]: e.target.checked})}
                                                        className="w-4 h-4"
                                                    />
                                                    <span>{col.replace(/([A-Z])/g, ' $1').trim()}</span>
                                                </label>
                                            ))}
                                        </div>
                                        
                                        {currentViewName !== 'Default' && (
                                            <div className="mt-4 pt-4 border-t border-slate-700">
                                                <button onClick={() => deleteView(currentViewId, currentViewName)}
                                                    className="bg-red-600 px-4 py-2 rounded-lg font-semibold">
                                                    üóëÔ∏è Delete Current View
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {showFilters && (
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 space-y-4">
                                        <h3 className="text-lg font-semibold">Advanced Filters</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <FilterControl column="equity" label="Equity" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="netInvested" label="Net Invested" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="pl" label="P/L" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="plPercent" label="P/L %" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="recoveryFactor" label="Recovery" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="currentDailyPL3pt" label="Recent Daily" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="dailyPLSinceStart" label="Daily Start" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="estDailyPL" label="Smart Pred" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="currentDrawdown" label="Curr DD" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="maxDrawdown" label="Max DD" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="trader" label="Trader" type="text" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="account" label="Account" type="text" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="decision" label="Decision" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['BUY', 'SELL', 'HOLD', 'PAUSED', 'NO_DATA']} />
                                            <FilterControl column="warnings" label="Warnings" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['Has Warning', 'No Warning']} />
                                            <FilterControl column="entrySignal" label="Entry Signal" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['CONSERVATIVE_ENTRY', 'BALANCED_ENTRY', 'AGGRESSIVE_ENTRY', 'PAUSED', 'NO_ENTRY']} />
                                            <FilterControl column="exitSignal" label="Exit Alert" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['IMMEDIATE', 'MODERATE', 'OPTIONAL']} />
                                            <FilterControl column="actionSignal" label="Action" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['INCREASE', 'HOLD', 'REDUCE', 'MONITOR', 'PAUSED']} />
                                            <FilterControl column="rfGrade" label="RF Grade" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['S', 'A', 'B', 'C', 'C-', 'D', 'F']} />
                                            <FilterControl column="ddRisk" label="DD Risk" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['SAFE', 'ACCEPTABLE', 'RISKY', 'DANGEROUS']} />
                                            <FilterControl column="activity" label="Activity" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['VERY_ACTIVE', 'ACTIVE', 'MODERATE', 'LOW_ACTIVITY', 'DORMANT']} />
                                            <FilterControl column="status" label="Status" type="select" filters={filters} updateFilter={updateFilter} 
                                                options={['ACTIVE', 'PAUSED', 'CLOSED']} />
                                        </div>
                                    </div>
                                )}

                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 overflow-x-auto">
                                    <table className="w-full text-xs">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                {visibleColumns.trader && <SortableHeader column="trader" label="Trader" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />}
                                                {visibleColumns.account && <SortableHeader column="account" label="Account" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />}
                                                {visibleColumns.status && <SortableHeader column="status" label="Status" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />}
                                                {visibleColumns.date && <SortableHeader column="latestDate" label="Date" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />}
                                                {visibleColumns.activity && <SortableHeader column="activity" label="Activity" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />}
                                                {visibleColumns.rfGrade && <SortableHeader column="rfGrade" label="RF Grade" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />}
                                                {visibleColumns.ddRisk && <SortableHeader column="ddRisk" label="DD Risk" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />}
                                                {visibleColumns.entrySignal && <SortableHeader column="entrySignal" label="Entry" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />}
                                                {visibleColumns.exitSignal && <SortableHeader column="exitSignal" label="Exit" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />}
                                                {visibleColumns.actionSignal && <SortableHeader column="actionSignal" label="Action" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />}
                                                {visibleColumns.warning && <SortableHeader column="warnings" label="Warning" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />}
                                                {visibleColumns.decision && <SortableHeader column="decision" label="Decision" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="center" />}
                                                {visibleColumns.equity && <SortableHeader column="equity" label="Equity" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                                {visibleColumns.netInvested && <SortableHeader column="netInvested" label="Net Inv" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                                {visibleColumns.pl && <SortableHeader column="pl" label="P/L" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                                {visibleColumns.plPercent && <SortableHeader column="plPercent" label="P/L %" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                                {visibleColumns.recentDaily && <SortableHeader column="currentDailyPL3pt" label="Recent Daily" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                                {visibleColumns.dailySince && <SortableHeader column="dailyPLSinceStart" label="Daily Start" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                                {visibleColumns.smartPred && <SortableHeader column="estDailyPL" label="Smart Pred" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                                {visibleColumns.dailyPct && <SortableHeader column="dailyPlPercentSinceStart" label="Daily %" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                                {visibleColumns.currentDD && <SortableHeader column="currentDrawdown" label="Curr DD" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                                {visibleColumns.maxDD && <SortableHeader column="maxDrawdown" label="Max DD" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                                {visibleColumns.avgDD && <SortableHeader column="avgDrawdown" label="Avg DD" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                                {visibleColumns.recovery && <SortableHeader column="recoveryFactor" label="Recovery" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {dashboardData.map(r => {
                                                const decStyle = getDecisionStyle(r.decision);
                                                return (
                                                <tr key={`${r.trader}-${r.account}`} className={getRowClasses(r)}>
                                                    {visibleColumns.trader && <td className="py-3 px-2 font-semibold">{r.trader}</td>}
                                                    {visibleColumns.account && <td className="py-3 px-2 text-slate-400">{r.account}</td>}
                                                    {visibleColumns.status && (
                                                        <td className="text-center py-3 px-2">
                                                            <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                                r.traderStatus.status === 'PAUSED' ? 'bg-gray-600 text-white' :
                                                                r.traderStatus.status === 'CLOSED' ? 'bg-red-900 text-white' :
                                                                'bg-green-700 text-white'
                                                            }`}>
                                                                {r.traderStatus.status === 'PAUSED' ? '‚è∏Ô∏è' : r.traderStatus.status === 'CLOSED' ? 'üö´' : '‚úÖ'} {r.traderStatus.status}
                                                            </span>
                                                        </td>
                                                    )}
                                                    {visibleColumns.date && <td className="py-3 px-2 text-slate-400 text-sm">{r.latestDate}</td>}
                                                    
                                                    {visibleColumns.activity && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.activityInfo ? (
                                                                <Tooltip content={`Avg Daily: ${r.activityInfo.metrics?.avgAbsDailyPL || '0'} Ft | Active: ${r.activityInfo.metrics?.activityRatio || '0%'}`}>
                                                                    <div className="flex flex-col items-center">
                                                                        <span className={`text-xs font-bold ${r.activityInfo.color || 'text-slate-500'}`}>
                                                                            {r.activityInfo.status || 'N/A'}
                                                                        </span>
                                                                        <span className="text-xs text-slate-400">
                                                                            {r.activityInfo.metrics?.avgAbsDailyPL || '0'} Ft/d
                                                                        </span>
                                                                    </div>
                                                                </Tooltip>
                                                            ) : (
                                                                <span className="text-slate-500 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    )}
                                                    
                                                    {visibleColumns.rfGrade && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.rfAssessment ? (
                                                                <Tooltip content={r.rfAssessment.label || ''}>
                                                                    <div className={`inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold ${r.rfAssessment.color || 'bg-slate-600'}`}>
                                                                        <span>{r.rfAssessment.icon || '?'}</span>
                                                                        <span>{r.rfAssessment.grade || 'N/A'}</span>
                                                                    </div>
                                                                </Tooltip>
                                                            ) : (
                                                                <span className="text-slate-500 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    )}
                                                    
                                                    {visibleColumns.ddRisk && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.ddAssessment ? (
                                                                <div className="flex flex-col gap-1">
                                                                    <span className={`text-xs ${r.ddAssessment.currentLevel?.color || 'text-slate-500'}`}>
                                                                        {r.ddAssessment.currentLevel?.label || 'N/A'}
                                                                    </span>
                                                                    <span className={`text-xs px-1 py-0.5 rounded ${
                                                                        r.ddAssessment.overallRisk === 'SAFE' ? 'bg-green-900/30 text-green-400' :
                                                                        r.ddAssessment.overallRisk === 'ACCEPTABLE' ? 'bg-yellow-900/30 text-yellow-400' :
                                                                        r.ddAssessment.overallRisk === 'RISKY' ? 'bg-orange-900/30 text-orange-400' :
                                                                        r.ddAssessment.overallRisk === 'DANGEROUS' ? 'bg-red-900/30 text-red-400' :
                                                                        'bg-slate-900/30 text-slate-400'
                                                                    }`}>
                                                                        {r.ddAssessment.overallRisk || 'N/A'}
                                                                    </span>
                                                                </div>
                                                            ) : (
                                                                <span className="text-slate-500 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    )}
                                                    
                                                    {visibleColumns.entrySignal && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.entrySignal && r.entrySignal.type !== 'NO_ENTRY' ? (
                                                                <Tooltip content={r.entrySignal.strength || r.entrySignal.type || ''}>
                                                                    <div className={`px-2 py-1 rounded-lg ${r.entrySignal.color || 'bg-slate-600'} text-white text-xs font-bold`}>
                                                                        {r.entrySignal.icon || '?'}
                                                                    </div>
                                                                </Tooltip>
                                                            ) : (
                                                                <span className="text-slate-500 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    )}
                                                    
                                                    {visibleColumns.exitSignal && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.exitSignal ? (
                                                                <Tooltip content={r.exitSignal.type || ''}>
                                                                    <div className={`px-2 py-1 rounded-lg ${r.exitSignal.color || 'bg-slate-600'} text-white text-xs font-bold ${
                                                                        r.exitSignal.pulse ? 'animate-pulse' : ''
                                                                    }`}>
                                                                        {r.exitSignal.icon || '?'}
                                                                    </div>
                                                                </Tooltip>
                                                            ) : (
                                                                <span className="text-green-500 text-xs">‚úì</span>
                                                            )}
                                                        </td>
                                                    )}
                                                    
                                                    {visibleColumns.actionSignal && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.actionSignal ? (
                                                                <Tooltip content={r.actionSignal.type || ''}>
                                                                    <div className={`px-2 py-1 rounded-lg ${r.actionSignal.color || 'bg-slate-600'} text-white text-xs`}>
                                                                        {r.actionSignal.icon || '?'}
                                                                    </div>
                                                                </Tooltip>
                                                            ) : (
                                                                <span className="text-slate-500 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    )}
                                                    
                                                    {visibleColumns.warning && (
                                                        <td className="text-center py-3 px-2">
                                                            {r.warnings.length > 0 ? (
                                                                <div className="flex flex-col gap-1">
                                                                    {r.warnings.map((w, i) => (
                                                                        <span key={i} className="px-2 py-1 bg-orange-600 rounded text-xs">
                                                                            ‚ö† {w}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            ) : (
                                                                <span className="text-slate-500">-</span>
                                                            )}
                                                        </td>
                                                    )}
                                                    
                                                    {visibleColumns.decision && (
                                                        <td className="text-center py-3 px-2">
                                                            <span className={`px-3 py-1 rounded-lg font-bold text-white whitespace-nowrap ${decStyle.bg}`}>
                                                                {decStyle.text}
                                                            </span>
                                                        </td>
                                                    )}
                                                    
                                                    {visibleColumns.equity && <td className="text-right py-3 px-2">{r.equity.toFixed(0)}Ft</td>}
                                                    {visibleColumns.netInvested && <td className="text-right py-3 px-2">{r.netInvested.toFixed(0)}Ft</td>}
                                                    {visibleColumns.pl && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.pl, vals.pl)} font-semibold text-white`}>
                                                            {r.pl.toFixed(0)}Ft
                                                        </td>
                                                    )}
                                                    {visibleColumns.plPercent && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.plPercent, vals.plPct)} font-semibold text-white`}>
                                                            {r.plPercent.toFixed(2)}%
                                                        </td>
                                                    )}
                                                    {visibleColumns.recentDaily && (
                                                        <td className={`text-right py-3 px-2 border-l-4 ${r.currentDailyPL3pt !== null ? `${getHeatmap(r.currentDailyPL3pt, vals.daily)} ${getBorder(r.currentDailyPL3ptDays)}` : 'bg-slate-700'} text-white`}>
                                                            {r.currentDailyPL3pt !== null ? `${r.currentDailyPL3pt.toFixed(0)}Ft (${r.currentDailyPL3ptDays})` : ''}
                                                        </td>
                                                    )}
                                                    {visibleColumns.dailySince && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.dailyPLSinceStart, vals.dailyStart)} text-white`}>
                                                            {r.dailyPLSinceStart.toFixed(0)}Ft
                                                        </td>
                                                    )}
                                                    {visibleColumns.smartPred && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.estDailyPL, vals.est)} text-white`}>
                                                            {r.estDailyPL.toFixed(0)}Ft
                                                        </td>
                                                    )}
                                                    {visibleColumns.dailyPct && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.dailyPlPercentSinceStart, vals.dailyPct)} text-white`}>
                                                            {r.dailyPlPercentSinceStart.toFixed(2)}%
                                                        </td>
                                                    )}
                                                    {visibleColumns.currentDD && (
                                                        <td className={`text-right py-3 px-2 ${getDD(r.currentDrawdown, vals.curr)} font-semibold text-white`}>
                                                            {r.currentDrawdown.toFixed(2)}%
                                                        </td>
                                                    )}
                                                    {visibleColumns.maxDD && (
                                                        <td className={`text-right py-3 px-2 ${getDD(r.maxDrawdown, vals.max)} font-semibold text-white`}>
                                                            {r.maxDrawdown.toFixed(2)}%
                                                        </td>
                                                    )}
                                                    {visibleColumns.avgDD && (
                                                        <td className={`text-right py-3 px-2 ${getDD(r.avgDrawdown, vals.avg)} font-semibold text-white`}>
                                                            {r.avgDrawdown.toFixed(2)}%
                                                        </td>
                                                    )}
                                                    {visibleColumns.recovery && (
                                                        <td className={`text-right py-3 px-2 ${getHeatmap(r.recoveryFactor, vals.rec)} font-semibold text-white`}>
                                                            {r.recoveryFactor.toFixed(2)}
                                                        </td>
                                                    )}
                                                </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'transactions' && (
                            <div className="space-y-6">
                                <div className="flex gap-4">
                                    <button onClick={() => { setNewData({...newData, dataType: 'transaction'}); setShowAddData(true); }}
                                        className="bg-blue-600 px-6 py-3 rounded-lg font-semibold">Add Data</button>
                                    <button onClick={() => exportXLSX('transactions')} className="bg-green-600 px-6 py-3 rounded-lg font-semibold">Export</button>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <th className="text-left py-3 px-2">Date</th>
                                                <th className="text-left py-3 px-2">Trader</th>
                                                <th className="text-left py-3 px-2">Account</th>
                                                <th className="text-right py-3 px-2">Amount</th>
                                                <th className="text-left py-3 px-2">Type</th>
                                                <th className="text-left py-3 px-2">Note</th>
                                                <th className="text-center py-3 px-2">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {transactions.map(t => (
                                                <tr key={t.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-3 px-2">{t.date}</td>
                                                    <td className="py-3 px-2 font-semibold">{t.trader}</td>
                                                    <td className="py-3 px-2 text-slate-400">{t.account}</td>
                                                    <td className="text-right py-3 px-2">{t.amount}Ft</td>
                                                    <td className="py-3 px-2">
                                                        <span className={`px-2 py-1 rounded text-xs font-semibold ${t.type === 'DEPOSIT' ? 'bg-green-600' : 'bg-red-600'}`}>{t.type}</span>
                                                    </td>
                                                    <td className="py-3 px-2 text-slate-400">{t.note}</td>
                                                    <td className="text-center py-3 px-2">
                                                        <button onClick={() => deleteTransaction(t.id, t.trader, t.date)}
                                                            className="text-red-400 hover:text-red-300 font-bold text-lg">
                                                            √ó
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'snapshots' && (
                            <div className="space-y-6">
                                <div className="flex gap-4">
                                    <button onClick={() => { setNewData({...newData, dataType: 'snapshot'}); setShowAddData(true); }}
                                        className="bg-blue-600 px-6 py-3 rounded-lg font-semibold">Add Data</button>
                                    <button onClick={() => exportXLSX('snapshots')} className="bg-green-600 px-6 py-3 rounded-lg font-semibold">Export</button>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <SortableHeader column="date" label="Date" sortColumn={snapshotSortColumn} sortDirection={snapshotSortDirection} handleSort={handleSnapshotSort} />
                                                <SortableHeader column="trader" label="Trader" sortColumn={snapshotSortColumn} sortDirection={snapshotSortDirection} handleSort={handleSnapshotSort} />
                                                <SortableHeader column="account" label="Account" sortColumn={snapshotSortColumn} sortDirection={snapshotSortDirection} handleSort={handleSnapshotSort} />
                                                <SortableHeader column="equity" label="Equity" sortColumn={snapshotSortColumn} sortDirection={snapshotSortDirection} handleSort={handleSnapshotSort} align="right" />
                                                <SortableHeader column="runningMaxEquity" label="Max" sortColumn={snapshotSortColumn} sortDirection={snapshotSortDirection} handleSort={handleSnapshotSort} align="right" />
                                                <SortableHeader column="currentDrawdown" label="DD%" sortColumn={snapshotSortColumn} sortDirection={snapshotSortDirection} handleSort={handleSnapshotSort} align="right" />
                                                <th className="text-left py-3 px-2">PrevDate</th>
                                                <SortableHeader column="flowSinceLast" label="Flow" sortColumn={snapshotSortColumn} sortDirection={snapshotSortDirection} handleSort={handleSnapshotSort} align="right" />
                                                <SortableHeader column="prevEquity" label="PrevEq" sortColumn={snapshotSortColumn} sortDirection={snapshotSortDirection} handleSort={handleSnapshotSort} align="right" />
                                                <SortableHeader column="pnlPeriod" label="PnL" sortColumn={snapshotSortColumn} sortDirection={snapshotSortDirection} handleSort={handleSnapshotSort} align="right" />
                                                <SortableHeader column="daysSincePrev" label="Days" sortColumn={snapshotSortColumn} sortDirection={snapshotSortDirection} handleSort={handleSnapshotSort} align="right" />
                                                <SortableHeader column="plPerDay" label="PL/day" sortColumn={snapshotSortColumn} sortDirection={snapshotSortDirection} handleSort={handleSnapshotSort} align="right" />
                                                <th className="text-center py-3 px-2">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {sortedSnapshots.map(s => (
                                                <tr key={s.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-3 px-2">{s.date}</td>
                                                    <td className="py-3 px-2 font-semibold">{s.trader}</td>
                                                    <td className="py-3 px-2 text-slate-400">{s.account}</td>
                                                    <td className="text-right py-3 px-2">{s.equity}Ft</td>
                                                    <td className="text-right py-3 px-2 text-blue-400">{s.runningMaxEquity?.toFixed(0)}Ft</td>
                                                    <td className={`text-right py-3 px-2 ${s.currentDrawdown > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                        {s.currentDrawdown?.toFixed(2)}%
                                                    </td>
                                                    <td className="py-3 px-2 text-slate-400">{s.prevDate}</td>
                                                    <td className="text-right py-3 px-2">{s.flowSinceLast?.toFixed(0)}Ft</td>
                                                    <td className="text-right py-3 px-2">{s.prevEquity}Ft</td>
                                                    <td className={`text-right py-3 px-2 ${s.pnlPeriod >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {s.pnlPeriod?.toFixed(0)}Ft
                                                    </td>
                                                    <td className="text-right py-3 px-2">{s.daysSincePrev}</td>
                                                    <td className={`text-right py-3 px-2 ${s.plPerDay >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {s.plPerDay?.toFixed(2)}Ft
                                                    </td>
                                                    <td className="text-center py-3 px-2">
                                                        <button onClick={() => deleteSnapshot(s.id, s.trader, s.date)}
                                                            className="text-red-400 hover:text-red-300 font-bold text-lg">
                                                            √ó
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {showAddData && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-semibold">Add Data</h3>
                                        <button onClick={() => setShowAddData(false)} className="text-slate-400 hover:text-white text-2xl">√ó</button>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="flex gap-2">
                                            <button onClick={() => setNewData({...newData, dataType: 'snapshot'})}
                                                className={`flex-1 py-2 rounded-lg font-semibold ${newData.dataType === 'snapshot' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                                Snapshot
                                            </button>
                                            <button onClick={() => setNewData({...newData, dataType: 'transaction'})}
                                                className={`flex-1 py-2 rounded-lg font-semibold ${newData.dataType === 'transaction' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                                Transaction
                                            </button>
                                        </div>
                                        <input type="text" placeholder="Date (YYYY.MM.DD)" value={newData.date}
                                            onChange={(e) => setNewData({ ...newData, date: e.target.value })}
                                            className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                        {newData.dataType === 'snapshot' ? (
                                            <select value={newData.trader} onChange={(e) => setNewData({ ...newData, trader: e.target.value })}
                                                className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                                <option value="">Select Trader</option>
                                                {traderNames.map(n => <option key={n} value={n}>{n}</option>)}
                                            </select>
                                        ) : (
                                            <input type="text" placeholder="Trader" value={newData.trader}
                                                onChange={(e) => setNewData({ ...newData, trader: e.target.value })}
                                                className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                        )}
                                        <select value={newData.account} onChange={(e) => setNewData({ ...newData, account: e.target.value })}
                                            className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                            <option>Virtual</option>
                                            <option>Real</option>
                                        </select>
                                        {newData.dataType === 'snapshot' ? (
                                            <input type="number" placeholder="Equity" value={newData.equity}
                                                onChange={(e) => setNewData({ ...newData, equity: e.target.value })}
                                                className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                        ) : (
                                            <>
                                                <input type="number" placeholder="Amount" value={newData.amount}
                                                    onChange={(e) => setNewData({ ...newData, amount: e.target.value })}
                                                    className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                                <select value={newData.transactionType} onChange={(e) => setNewData({ ...newData, transactionType: e.target.value })}
                                                    className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                                    <option>DEPOSIT</option>
                                                    <option>WITHDRAWAL</option>
                                                    <option>REALLOCATION</option>
                                                </select>
                                                <input type="text" placeholder="Note" value={newData.note}
                                                    onChange={(e) => setNewData({ ...newData, note: e.target.value })}
                                                    className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                            </>
                                        )}
                                        <button onClick={addData} className="w-full bg-blue-600 px-6 py-2 rounded-lg font-semibold">
                                            Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showSaveViewDialog && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-semibold">Save View</h3>
                                        <button onClick={() => setShowSaveViewDialog(false)} className="text-slate-400 hover:text-white text-2xl">√ó</button>
                                    </div>
                                    <div className="space-y-4">
                                        <input type="text" placeholder="View name (e.g., Risk Analysis)" value={newViewName}
                                            onChange={(e) => setNewViewName(e.target.value)}
                                            className="w-full bg-slate-700 rounded-lg px-4 py-2" />
                                        <div className="text-sm text-slate-400">
                                            This will save your current column visibility and filter settings.
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={saveViewAs} className="flex-1 bg-blue-600 px-6 py-2 rounded-lg font-semibold">
                                                Save
                                            </button>
                                            <button onClick={() => setShowSaveViewDialog(false)} className="flex-1 bg-slate-700 px-6 py-2 rounded-lg font-semibold">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showTraderStatusDialog && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-semibold">Manage Trader Status</h3>
                                        <button onClick={() => setShowTraderStatusDialog(false)} className="text-slate-400 hover:text-white text-2xl">√ó</button>
                                    </div>
                                    <div className="space-y-4">
                                        <select value={traderStatusForm.trader} onChange={(e) => setTraderStatusForm({...traderStatusForm, trader: e.target.value})}
                                            className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                            <option value="">Select Trader</option>
                                            {dashboardData.map(d => (
                                                <option key={`${d.trader}-${d.account}`} value={d.trader}>{d.trader}</option>
                                            ))}
                                        </select>
                                        <select value={traderStatusForm.account} onChange={(e) => setTraderStatusForm({...traderStatusForm, account: e.target.value})}
                                            className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                            <option value="">Select Account</option>
                                            <option>Virtual</option>
                                            <option>Real</option>
                                        </select>
                                        <select value={traderStatusForm.status} onChange={(e) => setTraderStatusForm({...traderStatusForm, status: e.target.value})}
                                            className="w-full bg-slate-700 rounded-lg px-4 py-2">
                                            <option value="ACTIVE">‚úÖ Active</option>
                                            <option value="PAUSED">‚è∏Ô∏è Paused</option>
                                            <option value="CLOSED">üö´ Closed</option>
                                        </select>
                                        <textarea placeholder="Reason (optional)" value={traderStatusForm.reason}
                                            onChange={(e) => setTraderStatusForm({...traderStatusForm, reason: e.target.value})}
                                            className="w-full bg-slate-700 rounded-lg px-4 py-2 h-24"
                                        />
                                        <div className="flex gap-2">
                                            <button onClick={saveTraderStatus} className="flex-1 bg-blue-600 px-6 py-2 rounded-lg font-semibold">
                                                Save Status
                                            </button>
                                            <button onClick={() => setShowTraderStatusDialog(false)} className="flex-1 bg-slate-700 px-6 py-2 rounded-lg font-semibold">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EtoroTracker />);
    </script>
</body>
</html>