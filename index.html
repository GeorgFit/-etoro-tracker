<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eToro Copy Trader Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.5.0/dist/Recharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBVE6eRSapt2fwVnLoQm2EfcScksg0OWiU",
            authDomain: "etoro-tracker.firebaseapp.com",
            projectId: "etoro-tracker",
            storageBucket: "etoro-tracker.firebasestorage.app",
            messagingSenderId: "941552714377",
            appId: "1:941552714377:web:8c44519dc1352aea7bbc58"
        };

        const SECURITY_KEY = "my-secret-etoro-key-2024";
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.firebaseDb = db;
        window.firebaseUtils = { collection, addDoc, onSnapshot, query, orderBy };
        window.SECURITY_KEY = SECURITY_KEY;
        window.firebaseReady = true;
    </script>

    <script type="text/babel">
        function initApp() {
            const { useState, useMemo, useEffect } = React;
            
            // Check if Recharts is available, otherwise skip charts
            const hasRecharts = typeof Recharts !== 'undefined';
            let LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer;
            
            if (hasRecharts) {
                ({ LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts);
            }

        function EtoroTracker() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [accountFilter, setAccountFilter] = useState('All');
            const [showAddData, setShowAddData] = useState(false);
            const [selectedTraders, setSelectedTraders] = useState([]);
            const [chartType, setChartType] = useState('equity');
            const [transactions, setTransactions] = useState([]);
            const [snapshots, setSnapshots] = useState([]);
            const [sortColumn, setSortColumn] = useState('trader');
            const [sortDirection, setSortDirection] = useState('asc');
            const [showFilters, setShowFilters] = useState(false);
            const [filters, setFilters] = useState({});
            const [savedFilters, setSavedFilters] = useState([]);
            const [filterName, setFilterName] = useState('');
            const [newData, setNewData] = useState({
                dataType: 'snapshot',
                date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                trader: '',
                account: 'Virtual',
                equity: '',
                amount: '',
                transactionType: 'DEPOSIT',
                note: ''
            });

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.firebaseReady) {
                        setTimeout(initFirebase, 100);
                        return;
                    }

                    const { collection, onSnapshot, query, orderBy } = window.firebaseUtils;
                    const db = window.firebaseDb;

                    const transQuery = query(collection(db, 'transactions'), orderBy('date', 'desc'));
                    onSnapshot(transQuery, (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setTransactions(data);
                    });

                    const snapQuery = query(collection(db, 'snapshots'), orderBy('date', 'desc'));
                    onSnapshot(snapQuery, (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setSnapshots(data);
                    });
                };

                initFirebase();
            }, []);

            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                const parts = dateStr.split('.');
                if (parts.length === 3) return new Date(parts[0], parts[1] - 1, parts[2]);
                return new Date(dateStr);
            };

            const daysBetween = (date1Str, date2Str) => {
                const d1 = parseDate(date1Str);
                const d2 = parseDate(date2Str);
                if (!d1 || !d2) return 0;
                return Math.floor((d1 - d2) / (1000 * 60 * 60 * 24));
            };

            const weightedAverage = (snapsWithDates, maxDays = 14) => {
                if (snapsWithDates.length === 0) return 0;
                const sorted = [...snapsWithDates].sort((a, b) => parseDate(b.date) - parseDate(a.date));
                const today = new Date();
                const cutoffDate = new Date(today.getTime() - (maxDays * 24 * 60 * 60 * 1000));
                const recentSnaps = sorted.filter(s => parseDate(s.date) >= cutoffDate && s.plPerDay !== 0);
                if (recentSnaps.length === 0) return 0;
                const weights = [];
                const n = Math.min(recentSnaps.length, maxDays);
                let totalWeight = 0;
                for (let i = 0; i < n; i++) {
                    const weight = Math.exp(-i / 5);
                    weights.push(weight);
                    totalWeight += weight;
                }
                const normalizedWeights = weights.map(w => w / totalWeight);
                let weightedSum = 0;
                for (let i = 0; i < Math.min(n, recentSnaps.length); i++) {
                    weightedSum += recentSnaps[i].plPerDay * normalizedWeights[i];
                }
                return weightedSum;
            };

            const snapshotsWithCalcs = useMemo(() => {
                const sorted = [...snapshots].sort((a, b) => {
                    const keyA = `${a.trader}-${a.account}-${a.date}`;
                    const keyB = `${b.trader}-${b.account}-${b.date}`;
                    return keyB.localeCompare(keyA);
                });

                const byTraderAccount = {};
                sorted.forEach(snap => {
                    const key = `${snap.trader}-${snap.account}`;
                    if (!byTraderAccount[key]) byTraderAccount[key] = [];
                    byTraderAccount[key].push(snap);
                });

                Object.keys(byTraderAccount).forEach(key => {
                    const snaps = byTraderAccount[key].sort((a, b) => parseDate(a.date) - parseDate(b.date));
                    let runningMaxEquity = 0;
                    snaps.forEach(snap => {
                        runningMaxEquity = Math.max(runningMaxEquity, snap.equity);
                        snap.runningMaxEquity = runningMaxEquity;
                        snap.currentDrawdown = runningMaxEquity > 0 ? ((runningMaxEquity - snap.equity) / runningMaxEquity) * 100 : 0;
                    });
                });

                return sorted.map((snap, index) => {
                    const prevSnaps = sorted.filter((s, i) => i > index && s.trader === snap.trader && s.account === snap.account);
                    const prevSnap = prevSnaps.length > 0 ? prevSnaps[0] : null;
                    const prevDate = prevSnap ? prevSnap.date : '';
                    const prevEquity = prevSnap ? prevSnap.equity : 0;

                    let flowSinceLast = 0;
                    if (prevDate) {
                        flowSinceLast = transactions.filter(t => 
                            t.trader === snap.trader && t.account === snap.account &&
                            parseDate(t.date) > parseDate(prevDate) && parseDate(t.date) <= parseDate(snap.date)
                        ).reduce((sum, t) => {
                            if (t.type === 'DEPOSIT') return sum + t.amount;
                            if (t.type === 'WITHDRAWAL') return sum - t.amount;
                            return sum;
                        }, 0);
                    } else {
                        flowSinceLast = transactions.filter(t => 
                            t.trader === snap.trader && t.account === snap.account && parseDate(t.date) <= parseDate(snap.date)
                        ).reduce((sum, t) => {
                            if (t.type === 'DEPOSIT') return sum + t.amount;
                            if (t.type === 'WITHDRAWAL') return sum - t.amount;
                            return sum;
                        }, 0);
                    }

                    const pnlPeriod = snap.equity - prevEquity - flowSinceLast;
                    const daysSincePrev = prevDate ? daysBetween(snap.date, prevDate) : 0;
                    const plPerDay = daysSincePrev > 0 ? pnlPeriod / daysSincePrev : 0;

                    return { ...snap, prevDate, flowSinceLast, prevEquity, pnlPeriod, daysSincePrev, plPerDay };
                });
            }, [snapshots, transactions]);

            const dashboardData = useMemo(() => {
                const traderAccountPairs = new Map();
                snapshotsWithCalcs.forEach(snap => {
                    const key = `${snap.trader}-${snap.account}`;
                    if (!traderAccountPairs.has(key) || parseDate(snap.date) > parseDate(traderAccountPairs.get(key).date)) {
                        traderAccountPairs.set(key, snap);
                    }
                });

                const data = Array.from(traderAccountPairs.values()).map(latestSnap => {
                    const traderTransactions = transactions.filter(t => t.trader === latestSnap.trader && t.account === latestSnap.account);
                    const netInvested = traderTransactions.reduce((sum, t) => {
                        if (t.type === 'DEPOSIT') return sum + t.amount;
                        if (t.type === 'WITHDRAWAL') return sum - t.amount;
                        return sum;
                    }, 0);

                    const pl = latestSnap.equity - netInvested;
                    const plPercent = netInvested > 0 ? (pl / netInvested) * 100 : 0;
                    const firstTransactionDate = traderTransactions.length > 0 ? traderTransactions.reduce((earliest, t) => 
                        parseDate(t.date) < parseDate(earliest.date) ? t : earliest
                    ).date : latestSnap.date;
                    const daysSinceStart = daysBetween(new Date().toISOString().split('T')[0].replace(/-/g, '.'), firstTransactionDate) + 1;

                    const traderSnaps = snapshotsWithCalcs.filter(s => s.trader === latestSnap.trader && s.account === latestSnap.account)
                        .sort((a, b) => parseDate(b.date) - parseDate(a.date));

                    const last3Snaps = traderSnaps.slice(0, 3).filter(s => s.plPerDay !== 0);
                    const currentDailyPL3pt = last3Snaps.length >= 1 ? last3Snaps.reduce((sum, s) => sum + s.plPerDay, 0) / last3Snaps.length : null;
                    const currentDailyPL3ptDays = last3Snaps.length;

                    const estDailyPL = weightedAverage(traderSnaps, 14);
                    const dailyPLSinceStart = daysSinceStart > 0 ? pl / daysSinceStart : 0;
                    const dailyPlPercentSinceStart = daysSinceStart > 0 ? plPercent / daysSinceStart : 0;

                    const currentDrawdown = latestSnap.currentDrawdown || 0;
                    const allDrawdowns = traderSnaps.map(s => s.currentDrawdown || 0).filter(dd => dd > 0);
                    const maxDrawdown = allDrawdowns.length > 0 ? Math.max(...allDrawdowns) : 0;
                    const avgDrawdown = allDrawdowns.length > 0 ? allDrawdowns.reduce((sum, dd) => sum + dd, 0) / allDrawdowns.length : 0;
                    const recoveryFactor = maxDrawdown > 0 ? plPercent / maxDrawdown : 0;

                    return {
                        trader: latestSnap.trader, account: latestSnap.account, latestDate: latestSnap.date,
                        equity: latestSnap.equity, netInvested, pl, plPercent, currentDailyPL3pt, currentDailyPL3ptDays,
                        dailyPLSinceStart, estDailyPL, dailyPlPercentSinceStart, daysSinceStart,
                        currentDrawdown, maxDrawdown, avgDrawdown, recoveryFactor
                    };
                });

                let filtered = accountFilter === 'All' ? data : data.filter(d => d.account === accountFilter);
                
                Object.keys(filters).forEach(column => {
                    const filter = filters[column];
                    if (!filter || !filter.enabled) return;
                    
                    filtered = filtered.filter(row => {
                        const value = row[column];
                        if (filter.type === 'range') {
                            const min = filter.min !== '' ? parseFloat(filter.min) : -Infinity;
                            const max = filter.max !== '' ? parseFloat(filter.max) : Infinity;
                            return value >= min && value <= max;
                        } else if (filter.type === 'text') {
                            return row[column].toLowerCase().includes(filter.value.toLowerCase());
                        }
                        return true;
                    });
                });

                filtered.sort((a, b) => {
                    let aVal = a[sortColumn];
                    let bVal = b[sortColumn];
                    
                    if (typeof aVal === 'string') {
                        return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    }
                    
                    if (aVal === null) aVal = -Infinity;
                    if (bVal === null) bVal = -Infinity;
                    
                    return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                });

                return filtered;
            }, [snapshotsWithCalcs, transactions, accountFilter, filters, sortColumn, sortDirection]);

            const totals = useMemo(() => ({
                pl: dashboardData.reduce((sum, d) => sum + d.pl, 0),
                dailyPLSinceStart: dashboardData.reduce((sum, d) => sum + d.dailyPLSinceStart, 0),
                estDailyPL: dashboardData.reduce((sum, d) => sum + d.estDailyPL, 0)
            }), [dashboardData]);

            const traderNames = useMemo(() => [...new Set(transactions.map(t => t.trader))].sort(), [transactions]);

            useEffect(() => {
                if (traderNames.length > 0 && selectedTraders.length === 0) {
                    setSelectedTraders(traderNames.slice(0, Math.min(5, traderNames.length)));
                }
            }, [traderNames]);

            const chartColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1', '#14b8a6', '#a855f7', '#eab308', '#22c55e', '#f43f5e'];

            const timelineData = useMemo(() => {
                if (!selectedTraders.length) return [];
                const filtered = snapshotsWithCalcs.filter(s => 
                    selectedTraders.includes(s.trader) && 
                    (accountFilter === 'All' || s.account === accountFilter)
                );
                const dates = [...new Set(filtered.map(s => s.date))].sort((a, b) => parseDate(a) - parseDate(b));
                return dates.map(date => {
                    const point = { date };
                    selectedTraders.forEach(trader => {
                        const snap = filtered.find(s => s.trader === trader && s.date === date);
                        if (snap) {
                            const txs = transactions.filter(t => t.trader === trader && t.account === snap.account);
                            const netInv = txs.filter(t => parseDate(t.date) <= parseDate(date))
                                .reduce((sum, t) => sum + (t.type === 'DEPOSIT' ? t.amount : t.type === 'WITHDRAWAL' ? -t.amount : 0), 0);
                            const pl = snap.equity - netInv;
                            const plPct = netInv > 0 ? (pl / netInv) * 100 : 0;
                            point[`${trader}_equity`] = snap.equity;
                            point[`${trader}_pl`] = pl;
                            point[`${trader}_plPercent`] = plPct;
                            point[`${trader}_drawdown`] = snap.currentDrawdown || 0;
                        }
                    });
                    return point;
                });
            }, [snapshotsWithCalcs, selectedTraders, accountFilter, transactions]);

            const toggleTrader = (trader) => {
                setSelectedTraders(prev => 
                    prev.includes(trader) ? prev.filter(t => t !== trader) : [...prev, trader]
                );
            };

            const selectAllTraders = () => setSelectedTraders([...traderNames]);
            const clearAllTraders = () => setSelectedTraders([]);

            const handleSort = (column) => {
                if (sortColumn === column) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortColumn(column);
                    setSortDirection('asc');
                }
            };

            const updateFilter = (column, filterData) => {
                setFilters(prev => ({
                    ...prev,
                    [column]: filterData
                }));
            };

            const clearFilters = () => {
                setFilters({});
            };

            const saveFilterView = () => {
                if (!filterName.trim()) {
                    alert('Please enter a filter name');
                    return;
                }
                const newView = {
                    name: filterName,
                    filters: filters,
                    timestamp: new Date().toISOString()
                };
                setSavedFilters(prev => [...prev, newView]);
                setFilterName('');
                alert(`Filter view "${filterName}" saved!`);
            };

            const loadFilterView = (view) => {
                setFilters(view.filters);
            };

            const deleteFilterView = (index) => {
                if (confirm(`Delete filter view "${savedFilters[index].name}"?`)) {
                    setSavedFilters(prev => prev.filter((_, i) => i !== index));
                }
            };

            const addData = async () => {
                try {
                    const { collection, addDoc } = window.firebaseUtils;
                    const db = window.firebaseDb;

                    if (newData.dataType === 'snapshot' && newData.trader && newData.equity) {
                        await addDoc(collection(db, 'snapshots'), {
                            date: newData.date, trader: newData.trader, account: newData.account,
                            equity: parseFloat(newData.equity), securityKey: window.SECURITY_KEY,
                            timestamp: new Date().toISOString()
                        });
                    } else if (newData.trader && newData.amount) {
                        await addDoc(collection(db, 'transactions'), {
                            date: newData.date, trader: newData.trader, account: newData.account,
                            amount: parseFloat(newData.amount), type: newData.transactionType,
                            note: newData.note, securityKey: window.SECURITY_KEY,
                            timestamp: new Date().toISOString()
                        });
                    }

                    setNewData({
                        dataType: 'snapshot', date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                        trader: '', account: 'Virtual', equity: '', amount: '', transactionType: 'DEPOSIT', note: ''
                    });
                    setShowAddData(false);
                } catch (error) {
                    console.error('Add data error:', error);
                    alert('Failed to add data!');
                }
            };

            const getHeatmapColor = (value, values, isPercent = true) => {
                if (values.length === 0) return 'bg-slate-600';
                const validValues = values.filter(v => !isNaN(v) && isFinite(v));
                if (validValues.length === 0) return 'bg-slate-600';
                const min = Math.min(...validValues);
                const max = Math.max(...validValues);
                if (min === max) return value >= 0 ? 'bg-green-500' : 'bg-red-500';
                const range = max - min;
                const normalized = (value - min) / range;
                const colors = ['bg-red-900', 'bg-red-800', 'bg-red-700', 'bg-red-600', 'bg-red-500',
                    'bg-green-500', 'bg-green-600', 'bg-green-700', 'bg-green-800', 'bg-green-900'];
                const index = Math.floor(normalized * (colors.length - 1));
                return colors[Math.max(0, Math.min(colors.length - 1, index))];
            };

            const getDailyPLBorderColor = (days) => {
                if (days === 3) return 'border-l-green-500';
                if (days === 2) return 'border-l-yellow-500';
                if (days === 1) return 'border-l-orange-500';
                return '';
            };

            const getDrawdownColor = (value, values) => {
                if (values.length === 0) return 'bg-slate-600';
                const validValues = values.filter(v => !isNaN(v) && isFinite(v));
                if (validValues.length === 0) return 'bg-slate-600';
                const min = Math.min(...validValues);
                const max = Math.max(...validValues);
                if (min === max) return value <= 5 ? 'bg-green-500' : 'bg-red-500';
                const range = max - min;
                const normalized = 1 - ((value - min) / range);
                const colors = ['bg-red-900', 'bg-red-800', 'bg-red-700', 'bg-red-600', 'bg-red-500',
                    'bg-green-500', 'bg-green-600', 'bg-green-700', 'bg-green-800', 'bg-green-900'];
                const index = Math.floor(normalized * (colors.length - 1));
                return colors[Math.max(0, Math.min(colors.length - 1, index))];
            };

            const plValues = dashboardData.map(d => d.pl);
            const plPercentValues = dashboardData.map(d => d.plPercent);
            const dailyPLValues = dashboardData.map(d => d.currentDailyPL3pt).filter(v => v !== null);
            const dailyPLSinceStartValues = dashboardData.map(d => d.dailyPLSinceStart);
            const estDailyPLValues = dashboardData.map(d => d.estDailyPL);
            const dailyPercentValues = dashboardData.map(d => d.dailyPlPercentSinceStart);
            const currentDDValues = dashboardData.map(d => d.currentDrawdown);
            const maxDDValues = dashboardData.map(d => d.maxDrawdown);
            const avgDDValues = dashboardData.map(d => d.avgDrawdown);
            const recoveryFactorValues = dashboardData.map(d => d.recoveryFactor);

            const exportToXLSX = (type) => {
                const wb = XLSX.utils.book_new();
                if (type === 'all' || type === 'transactions') {
                    const transData = transactions.map(t => ({
                        Date: t.date, Trader: t.trader, Account: t.account,
                        Amount: t.amount, Type: t.type, Note: t.note
                    }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(transData), 'Transactions');
                }
                if (type === 'all' || type === 'snapshots') {
                    const snapData = snapshotsWithCalcs.map(s => ({
                        Date: s.date, Trader: s.trader, Account: s.account, Equity: s.equity,
                        Running_Max_Equity: s.runningMaxEquity, 'Drawdown_%': s.currentDrawdown,
                        Prev_Date: s.prevDate, Flow_Since_Last: s.flowSinceLast,
                        Prev_Equity: s.prevEquity, PnL_Period: s.pnlPeriod,
                        Days_Since_Prev: s.daysSincePrev, PL_per_Day: s.plPerDay
                    }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(snapData), 'Snapshots');
                }
                if (type === 'all' || type === 'dashboard') {
                    const dashData = dashboardData.map(d => ({
                        Trader: d.trader, Account: d.account, Latest_Date: d.latestDate,
                        Equity: d.equity, Net_Invested: d.netInvested, 'P/L': d.pl, 'P/L_%': d.plPercent,
                        Recovery_Factor: d.recoveryFactor, Recent_Daily_PL: d.currentDailyPL3pt !== null ? d.currentDailyPL3pt : '',
                        'Days_in_avg': d.currentDailyPL3ptDays, daily_PL_since_start: d.dailyPLSinceStart,
                        Smart_Prediction_14d: d.estDailyPL, 'Daily_PL%_Since_Start': d.dailyPlPercentSinceStart,
                        'Current_DD_%': d.currentDrawdown, 'Max_DD_%': d.maxDrawdown, 'Avg_DD_%': d.avgDrawdown
                    }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dashData), 'Trader_View');
                }
                if (type === 'timeline') {
                    const timelineExport = timelineData.map(point => {
                        const row = { Date: point.date };
                        selectedTraders.forEach(trader => {
                            row[`${trader}_Equity`] = point[`${trader}_equity`] || '';
                            row[`${trader}_PL`] = point[`${trader}_pl`] || '';
                            row[`${trader}_PL%`] = point[`${trader}_plPercent`] || '';
                            row[`${trader}_DD%`] = point[`${trader}_drawdown`] || '';
                        });
                        return row;
                    });
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(timelineExport), 'Timeline');
                }
                XLSX.writeFile(wb, `etoro_data_${type}_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-6">
                    <div className="max-w-full mx-auto">
                        <div className="mb-8">
                            <h1 className="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
                                eToro Copy Trader Dashboard
                            </h1>
                            <p className="text-slate-400">Firebase Real-time Sync Active - {transactions.length} transactions, {snapshots.length} snapshots</p>
                        </div>

                        <div className="flex gap-2 mb-6 flex-wrap">
                            <button onClick={() => setActiveTab('dashboard')}
                                className={`px-6 py-3 rounded-lg font-semibold transition-all ${activeTab === 'dashboard' ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                Trader View
                            </button>
                            <button onClick={() => setActiveTab('timeline')}
                                className={`px-6 py-3 rounded-lg font-semibold transition-all ${activeTab === 'timeline' ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                Performance Timeline
                            </button>
                            <button onClick={() => setActiveTab('transactions')}
                                className={`px-6 py-3 rounded-lg font-semibold transition-all ${activeTab === 'transactions' ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                Transactions
                            </button>
                            <button onClick={() => setActiveTab('snapshots')}
                                className={`px-6 py-3 rounded-lg font-semibold transition-all ${activeTab === 'snapshots' ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                Snapshots
                            </button>
                        </div>

                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Total P/L</div>
                                        <div className={`text-2xl font-bold ${totals.pl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {totals.pl.toFixed(0)} Ft
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Daily P/L Since Start</div>
                                        <div className={`text-2xl font-bold ${totals.dailyPLSinceStart >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {totals.dailyPLSinceStart.toFixed(0)} Ft
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Avg Max Drawdown</div>
                                        <div className="text-2xl font-bold text-orange-400">
                                            {dashboardData.length > 0 ? (dashboardData.reduce((sum, d) => sum + d.maxDrawdown, 0) / dashboardData.length).toFixed(2) : '0.00'}%
                                        </div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                        <div className="text-slate-400 text-xs mb-1">Active Traders</div>
                                        <div className="text-2xl font-bold text-blue-400">{dashboardData.length}</div>
                                    </div>
                                </div>

                                <div className="flex gap-4 items-center bg-slate-800 rounded-xl p-4 border border-slate-700 flex-wrap">
                                    <span className="text-slate-300">Account Type:</span>
                                    <select value={accountFilter} onChange={(e) => setAccountFilter(e.target.value)}
                                        className="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option>All</option>
                                        <option>Virtual</option>
                                        <option>Real</option>
                                    </select>
                                    <button onClick={() => setShowFilters(!showFilters)}
                                        className={`px-4 py-2 rounded-lg font-semibold transition-colors ${showFilters ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'}`}>
                                        {showFilters ? 'Hide Filters' : 'Show Filters'} ({Object.keys(filters).filter(k => filters[k]?.enabled).length})
                                    </button>
                                    {Object.keys(filters).some(k => filters[k]?.enabled) && (
                                        <button onClick={clearFilters}
                                            className="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg font-semibold transition-colors">
                                            Clear Filters
                                        </button>
                                    )}
                                    <button onClick={() => exportToXLSX('dashboard')}
                                        className="ml-auto bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold transition-colors shadow-lg">
                                        Export XLSX
                                    </button>
                                </div>

                                {showFilters && (
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 space-y-4">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-lg font-semibold">Column Filters</h3>
                                            <div className="flex gap-2">
                                                <input type="text" placeholder="Filter view name..." value={filterName}
                                                    onChange={(e) => setFilterName(e.target.value)}
                                                    className="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                                <button onClick={saveFilterView}
                                                    className="bg-blue-600 hover:bg-blue-700 px-4 py-1 rounded-lg text-sm font-semibold transition-colors">
                                                    Save View
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {savedFilters.length > 0 && (
                                            <div className="mb-4">
                                                <div className="text-sm font-semibold mb-2">Saved Filter Views:</div>
                                                <div className="flex flex-wrap gap-2">
                                                    {savedFilters.map((view, idx) => (
                                                        <div key={idx} className="bg-slate-700 px-3 py-1 rounded-lg flex items-center gap-2">
                                                            <button onClick={() => loadFilterView(view)}
                                                                className="text-blue-400 hover:text-blue-300 text-sm">
                                                                {view.name}
                                                            </button>
                                                            <button onClick={() => deleteFilterView(idx)}
                                                                className="text-red-400 hover:text-red-300 text-xs">
                                                                ×
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            <FilterControl column="equity" label="Equity" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="netInvested" label="Net Invested" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="pl" label="P/L" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="plPercent" label="P/L %" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="recoveryFactor" label="Recovery Factor" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="currentDailyPL3pt" label="Recent Daily PL" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="dailyPLSinceStart" label="Daily PL Since Start" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="estDailyPL" label="Smart Prediction" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="dailyPlPercentSinceStart" label="Daily PL% Since Start" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="currentDrawdown" label="Current DD %" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="maxDrawdown" label="Max DD %" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="avgDrawdown" label="Avg DD %" type="range" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="trader" label="Trader" type="text" filters={filters} updateFilter={updateFilter} />
                                            <FilterControl column="account" label="Account" type="text" filters={filters} updateFilter={updateFilter} />
                                        </div>
                                    </div>
                                )}

                                <div className="bg-slate-800 rounded-xl p-6 shadow-2xl border border-slate-700 overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <SortableHeader column="trader" label="Trader" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />
                                                <SortableHeader column="account" label="Account" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />
                                                <SortableHeader column="latestDate" label="Latest Date" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} />
                                                <SortableHeader column="equity" label="Equity" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="netInvested" label="Net Invested" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="pl" label="P/L" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="plPercent" label="P/L %" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="recoveryFactor" label="Recovery Factor" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <th className="text-right py-3 px-2 font-semibold cursor-pointer hover:bg-slate-700" onClick={() => handleSort('currentDailyPL3pt')}>
                                                    <div className="flex items-center justify-end gap-1">
                                                        Recent Daily PL
                                                        {sortColumn === 'currentDailyPL3pt' && <span>{sortDirection === 'asc' ? '▲' : '▼'}</span>}
                                                    </div>
                                                    <div className="text-xs font-normal text-slate-400 mt-1">(avg last 1-3 days)</div>
                                                </th>
                                                <SortableHeader column="dailyPLSinceStart" label="Daily P/L Since Start" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <th className="text-right py-3 px-2 font-semibold cursor-pointer hover:bg-slate-700" onClick={() => handleSort('estDailyPL')}>
                                                    <div className="flex items-center justify-end gap-1">
                                                        Smart Prediction
                                                        {sortColumn === 'estDailyPL' && <span>{sortDirection === 'asc' ? '▲' : '▼'}</span>}
                                                    </div>
                                                    <div className="text-xs font-normal text-slate-400 mt-1">(14d weighted avg)</div>
                                                </th>
                                                <SortableHeader column="dailyPlPercentSinceStart" label="Daily PL% Since Start" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="currentDrawdown" label="Current DD %" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="maxDrawdown" label="Max DD %" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                                <SortableHeader column="avgDrawdown" label="Avg DD %" sortColumn={sortColumn} sortDirection={sortDirection} handleSort={handleSort} align="right" />
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {dashboardData.map(row => (
                                                <tr key={`${row.trader}-${row.account}`} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-3 px-2 font-semibold">{row.trader}</td>
                                                    <td className="py-3 px-2 text-slate-400">{row.account}</td>
                                                    <td className="py-3 px-2 text-slate-400">{row.latestDate}</td>
                                                    <td className="text-right py-3 px-2">{row.equity.toFixed(0)}Ft</td>
                                                    <td className="text-right py-3 px-2">{row.netInvested.toFixed(0)}Ft</td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmapColor(row.pl, plValues, false)} font-semibold text-white`}>
                                                        {row.pl.toFixed(0)}Ft
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmapColor(row.plPercent, plPercentValues)} font-semibold text-white`}>
                                                        {row.plPercent.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmapColor(row.recoveryFactor, recoveryFactorValues)} font-semibold text-white`}>
                                                        {row.recoveryFactor.toFixed(2)}
                                                    </td>
                                                    <td className={`text-right py-3 px-2 text-white border-l-4 ${row.currentDailyPL3pt !== null ? `${getHeatmapColor(row.currentDailyPL3pt, dailyPLValues, false)} ${getDailyPLBorderColor(row.currentDailyPL3ptDays)}` : 'bg-slate-700'}`}
                                                        title={row.currentDailyPL3pt !== null ? `Average of last ${row.currentDailyPL3ptDays} day${row.currentDailyPL3ptDays > 1 ? 's' : ''}` : ''}>
                                                        {row.currentDailyPL3pt !== null ? (
                                                            <span className="flex items-center justify-end gap-1">
                                                                <span>{row.currentDailyPL3pt.toFixed(0)}Ft</span>
                                                                <span className="text-xs opacity-75">({row.currentDailyPL3ptDays})</span>
                                                            </span>
                                                        ) : ''}
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmapColor(row.dailyPLSinceStart, dailyPLSinceStartValues, false)} text-white`}>
                                                        {row.dailyPLSinceStart.toFixed(0)}Ft
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmapColor(row.estDailyPL, estDailyPLValues, false)} text-white`}
                                                        title="Smart Prediction: Weighted average of last 14 days (newer days = higher weight)">
                                                        {row.estDailyPL.toFixed(0)}Ft
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getHeatmapColor(row.dailyPlPercentSinceStart, dailyPercentValues)} font-semibold text-white`}>
                                                        {row.dailyPlPercentSinceStart.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getDrawdownColor(row.currentDrawdown, currentDDValues)} font-semibold text-white`}>
                                                        {row.currentDrawdown.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getDrawdownColor(row.maxDrawdown, maxDDValues)} font-semibold text-white`}>
                                                        {row.maxDrawdown.toFixed(2)}%
                                                    </td>
                                                    <td className={`text-right py-3 px-2 ${getDrawdownColor(row.avgDrawdown, avgDDValues)} font-semibold text-white`}>
                                                        {row.avgDrawdown.toFixed(2)}%
                                                    </td>
                                                </tr>
                                            ))}
                                            <tr className="bg-slate-700 font-bold">
                                                <td colSpan="5" className="py-3 px-2">Σ totals</td>
                                                <td className={`text-right py-3 px-2 ${totals.pl >= 0 ? 'bg-green-600' : 'bg-red-600'} text-white`}>
                                                    {totals.pl.toFixed(0)}Ft
                                                </td>
                                                <td className="py-3 px-2"></td>
                                                <td className="py-3 px-2"></td>
                                                <td className="py-3 px-2"></td>
                                                <td className={`text-right py-3 px-2 ${totals.dailyPLSinceStart >= 0 ? 'bg-green-600' : 'bg-red-600'} text-white`}>
                                                    {totals.dailyPLSinceStart.toFixed(0)}Ft
                                                </td>
                                                <td className={`text-right py-3 px-2 ${totals.estDailyPL >= 0 ? 'bg-green-600' : 'bg-red-600'} text-white`}>
                                                    {totals.estDailyPL.toFixed(0)}Ft
                                                </td>
                                                <td colSpan="4" className="py-3 px-2"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'timeline' && (
                            <div className="space-y-6">
                                <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                    <div className="flex flex-wrap gap-4 items-center justify-between mb-4">
                                        <div className="flex gap-2 items-center">
                                            <span className="text-slate-300">Account:</span>
                                            <select value={accountFilter} onChange={(e) => setAccountFilter(e.target.value)}
                                                className="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option>All</option>
                                                <option>Virtual</option>
                                                <option>Real</option>
                                            </select>
                                        </div>
                                        <div className="flex gap-2 items-center">
                                            <span className="text-slate-300">Chart Type:</span>
                                            <select value={chartType} onChange={(e) => setChartType(e.target.value)}
                                                className="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="equity">Equity Over Time</option>
                                                <option value="pl">P/L Over Time</option>
                                                <option value="plPercent">P/L % Over Time</option>
                                                <option value="drawdown">Drawdown Over Time</option>
                                            </select>
                                        </div>
                                        <button onClick={() => exportToXLSX('timeline')}
                                            className="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold transition-colors shadow-lg">
                                            Export Timeline
                                        </button>
                                    </div>
                                    <div className="mb-4">
                                        <div className="flex justify-between items-center mb-3">
                                            <span className="text-slate-300 font-semibold">Select Traders:</span>
                                            <div className="flex gap-2">
                                                <button onClick={selectAllTraders} className="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm transition-colors">
                                                    Select All
                                                </button>
                                                <button onClick={clearAllTraders} className="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-sm transition-colors">
                                                    Clear
                                                </button>
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {traderNames.map((trader, idx) => (
                                                <button key={trader} onClick={() => toggleTrader(trader)}
                                                    className={`px-4 py-2 rounded-lg font-semibold transition-all ${selectedTraders.includes(trader) ? 'ring-2 ring-white' : 'opacity-50'}`}
                                                    style={{ backgroundColor: chartColors[idx % chartColors.length] }}>
                                                    {trader}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {selectedTraders.length > 0 && timelineData.length > 0 && hasRecharts && (
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                        <h3 className="text-xl font-semibold mb-4">
                                            {chartType === 'equity' ? 'Equity Over Time' :
                                             chartType === 'pl' ? 'P/L Over Time' :
                                             chartType === 'plPercent' ? 'P/L % Over Time' : 'Drawdown Over Time'}
                                        </h3>
                                        <ResponsiveContainer width="100%" height={400}>
                                            <LineChart data={timelineData}>
                                                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                                                <XAxis dataKey="date" stroke="#9ca3af" />
                                                <YAxis stroke="#9ca3af" />
                                                <Tooltip 
                                                    contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151', borderRadius: '0.5rem' }}
                                                    labelStyle={{ color: '#9ca3af' }}
                                                    formatter={(value) => {
                                                        if (chartType === 'equity' || chartType === 'pl') return `${value.toFixed(0)} Ft`;
                                                        if (chartType === 'plPercent' || chartType === 'drawdown') return `${value.toFixed(2)}%`;
                                                        return value;
                                                    }} 
                                                />
                                                <Legend />
                                                {selectedTraders.map((trader, idx) => (
                                                    <Line 
                                                        key={trader} 
                                                        type="monotone" 
                                                        dataKey={`${trader}_${chartType === 'plPercent' ? 'plPercent' : chartType}`}
                                                        stroke={chartColors[traderNames.indexOf(trader) % chartColors.length]}
                                                        name={trader} 
                                                        strokeWidth={2} 
                                                        dot={false} 
                                                    />
                                                ))}
                                            </LineChart>
                                        </ResponsiveContainer>
                                    </div>
                                )}

                                {selectedTraders.length > 0 && timelineData.length > 0 && !hasRecharts && (
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                        <div className="text-center py-12">
                                            <p className="text-slate-400 text-lg mb-4">Chart library is loading...</p>
                                            <p className="text-slate-500 text-sm">Please refresh the page if charts don't appear.</p>
                                        </div>
                                    </div>
                                )}

                                {selectedTraders.length > 0 && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {selectedTraders.map((trader, idx) => {
                                            const traderData = dashboardData.find(d => d.trader === trader);
                                            if (!traderData) return null;
                                            return (
                                                <div key={trader} className="bg-slate-800 rounded-xl p-4 border-l-4 border border-slate-700" 
                                                    style={{ borderLeftColor: chartColors[traderNames.indexOf(trader) % chartColors.length] }}>
                                                    <h4 className="font-bold text-lg mb-3">{trader}</h4>
                                                    <div className="space-y-2 text-sm">
                                                        <div className="flex justify-between">
                                                            <span className="text-slate-400">P/L:</span>
                                                            <span className={traderData.pl >= 0 ? 'text-green-400 font-semibold' : 'text-red-400 font-semibold'}>
                                                                {traderData.pl.toFixed(0)} Ft
                                                            </span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-slate-400">P/L %:</span>
                                                            <span className={traderData.plPercent >= 0 ? 'text-green-400 font-semibold' : 'text-red-400 font-semibold'}>
                                                                {traderData.plPercent.toFixed(2)}%
                                                            </span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-slate-400">Max DD:</span>
                                                            <span className="text-orange-400 font-semibold">{traderData.maxDrawdown.toFixed(2)}%</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-slate-400">Recovery Factor:</span>
                                                            <span className={traderData.recoveryFactor >= 1 ? 'text-green-400 font-semibold' : 'text-yellow-400 font-semibold'}>
                                                                {traderData.recoveryFactor.toFixed(2)}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {selectedTraders.length === 0 && (
                                    <div className="bg-slate-800 rounded-xl p-12 border border-slate-700 text-center">
                                        <p className="text-slate-400 text-lg">Select traders above to view performance timeline</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'transactions' && (
                            <div className="space-y-6">
                                <div className="flex gap-4">
                                    <button onClick={() => { setNewData({...newData, dataType: 'transaction'}); setShowAddData(true); }}
                                        className="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold transition-colors shadow-lg">
                                        Add Data
                                    </button>
                                    <button onClick={() => exportToXLSX('transactions')}
                                        className="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold transition-colors shadow-lg">
                                        Export XLSX
                                    </button>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 shadow-2xl border border-slate-700 overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <th className="text-left py-3 px-2">Date</th>
                                                <th className="text-left py-3 px-2">Trader</th>
                                                <th className="text-left py-3 px-2">Account</th>
                                                <th className="text-right py-3 px-2">Amount</th>
                                                <th className="text-left py-3 px-2">Type</th>
                                                <th className="text-left py-3 px-2">Note</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {transactions.map(t => (
                                                <tr key={t.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-3 px-2">{t.date}</td>
                                                    <td className="py-3 px-2 font-semibold">{t.trader}</td>
                                                    <td className="py-3 px-2 text-slate-400">{t.account}</td>
                                                    <td className="text-right py-3 px-2">{t.amount}Ft</td>
                                                    <td className="py-3 px-2">
                                                        <span className={`px-2 py-1 rounded text-xs font-semibold ${t.type === 'DEPOSIT' ? 'bg-green-600' : t.type === 'WITHDRAWAL' ? 'bg-red-600' : 'bg-blue-600'}`}>
                                                            {t.type}
                                                        </span>
                                                    </td>
                                                    <td className="py-3 px-2 text-slate-400">{t.note}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'snapshots' && (
                            <div className="space-y-6">
                                <div className="flex gap-4">
                                    <button onClick={() => { setNewData({...newData, dataType: 'snapshot'}); setShowAddData(true); }}
                                        className="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold transition-colors shadow-lg">
                                        Add Data
                                    </button>
                                    <button onClick={() => exportToXLSX('snapshots')}
                                        className="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold transition-colors shadow-lg">
                                        Export XLSX
                                    </button>
                                </div>
                                <div className="bg-slate-800 rounded-xl p-6 shadow-2xl border border-slate-700 overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-700">
                                                <th className="text-left py-3 px-2">Date</th>
                                                <th className="text-left py-3 px-2">Trader</th>
                                                <th className="text-left py-3 px-2">Account</th>
                                                <th className="text-right py-3 px-2">Equity</th>
                                                <th className="text-right py-3 px-2">Running Max</th>
                                                <th className="text-right py-3 px-2">Drawdown %</th>
                                                <th className="text-left py-3 px-2">Prev_Date</th>
                                                <th className="text-right py-3 px-2">Flow_Since_Last</th>
                                                <th className="text-right py-3 px-2">Prev_Equity</th>
                                                <th className="text-right py-3 px-2">PnL_Period</th>
                                                <th className="text-right py-3 px-2">Days_Since_Prev</th>
                                                <th className="text-right py-3 px-2">PL_per_Day</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {snapshotsWithCalcs.map(s => (
                                                <tr key={s.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-3 px-2">{s.date}</td>
                                                    <td className="py-3 px-2 font-semibold">{s.trader}</td>
                                                    <td className="py-3 px-2 text-slate-400">{s.account}</td>
                                                    <td className="text-right py-3 px-2">{s.equity}Ft</td>
                                                    <td className="text-right py-3 px-2 text-blue-400">{s.runningMaxEquity ? s.runningMaxEquity.toFixed(0) + 'Ft' : ''}</td>
                                                    <td className={`text-right py-3 px-2 font-semibold ${s.currentDrawdown > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                        {s.currentDrawdown ? s.currentDrawdown.toFixed(2) + '%' : '0.00%'}
                                                    </td>
                                                    <td className="py-3 px-2 text-slate-400">{s.prevDate || ''}</td>
                                                    <td className="text-right py-3 px-2">{s.flowSinceLast ? s.flowSinceLast.toFixed(0) + 'Ft' : '0Ft'}</td>
                                                    <td className="text-right py-3 px-2">{s.prevEquity}Ft</td>
                                                    <td className={`text-right py-3 px-2 font-semibold ${s.pnlPeriod >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {s.pnlPeriod ? s.pnlPeriod.toFixed(0) + 'Ft' : '0Ft'}
                                                    </td>
                                                    <td className="text-right py-3 px-2">{s.daysSincePrev || ''}</td>
                                                    <td className={`text-right py-3 px-2 font-semibold ${s.plPerDay >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {s.plPerDay ? s.plPerDay.toFixed(2) + 'Ft' : ''}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {showAddData && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-semibold">Add Data</h3>
                                        <button onClick={() => setShowAddData(false)} className="text-slate-400 hover:text-white text-2xl">×</button>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="flex gap-2">
                                            <button onClick={() => setNewData({...newData, dataType: 'snapshot'})}
                                                className={`flex-1 py-2 rounded-lg font-semibold ${newData.dataType === 'snapshot' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                                Snapshot
                                            </button>
                                            <button onClick={() => setNewData({...newData, dataType: 'transaction'})}
                                                className={`flex-1 py-2 rounded-lg font-semibold ${newData.dataType === 'transaction' ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                                Transaction
                                            </button>
                                        </div>
                                        <input type="text" placeholder="Date (YYYY.MM.DD)" value={newData.date}
                                            onChange={(e) => setNewData({ ...newData, date: e.target.value })}
                                            className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        {newData.dataType === 'snapshot' ? (
                                            <select value={newData.trader} onChange={(e) => setNewData({ ...newData, trader: e.target.value })}
                                                className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="">Select Trader</option>
                                                {traderNames.map(name => <option key={name} value={name}>{name}</option>)}
                                            </select>
                                        ) : (
                                            <input type="text" placeholder="Trader Name" value={newData.trader}
                                                onChange={(e) => setNewData({ ...newData, trader: e.target.value })}
                                                className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        )}
                                        <select value={newData.account} onChange={(e) => setNewData({ ...newData, account: e.target.value })}
                                            className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option>Virtual</option>
                                            <option>Real</option>
                                        </select>
                                        {newData.dataType === 'snapshot' ? (
                                            <input type="number" placeholder="Equity" value={newData.equity}
                                                onChange={(e) => setNewData({ ...newData, equity: e.target.value })}
                                                className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        ) : (
                                            <>
                                                <input type="number" placeholder="Amount" value={newData.amount}
                                                    onChange={(e) => setNewData({ ...newData, amount: e.target.value })}
                                                    className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                                <select value={newData.transactionType} onChange={(e) => setNewData({ ...newData, transactionType: e.target.value })}
                                                    className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                    <option>DEPOSIT</option>
                                                    <option>WITHDRAWAL</option>
                                                    <option>REALLOCATION</option>
                                                </select>
                                                <input type="text" placeholder="Note (optional)" value={newData.note}
                                                    onChange={(e) => setNewData({ ...newData, note: e.target.value })}
                                                    className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                            </>
                                        )}
                                        <button onClick={addData}
                                            className="w-full bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                                            Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function SortableHeader({ column, label, sortColumn, sortDirection, handleSort, align = 'left' }) {
            return (
                <th className={`text-${align} py-3 px-2 font-semibold cursor-pointer hover:bg-slate-700 transition-colors`}
                    onClick={() => handleSort(column)}>
                    <div className={`flex items-center gap-1 ${align === 'right' ? 'justify-end' : ''}`}>
                        {label}
                        {sortColumn === column && (
                            <span className="text-blue-400">{sortDirection === 'asc' ? '▲' : '▼'}</span>
                        )}
                    </div>
                </th>
            );
        }

        function FilterControl({ column, label, type, filters, updateFilter }) {
            const filter = filters[column] || { enabled: false, type, min: '', max: '', value: '' };

            return (
                <div className="bg-slate-700 rounded-lg p-3">
                    <div className="flex items-center gap-2 mb-2">
                        <input type="checkbox" checked={filter.enabled}
                            onChange={(e) => updateFilter(column, { ...filter, enabled: e.target.checked })}
                            className="w-4 h-4" />
                        <label className="text-sm font-semibold">{label}</label>
                    </div>
                    {type === 'range' && (
                        <div className="flex gap-2">
                            <input type="number" placeholder="Min" value={filter.min || ''}
                                onChange={(e) => updateFilter(column, { ...filter, min: e.target.value, type: 'range', enabled: true })}
                                className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            <input type="number" placeholder="Max" value={filter.max || ''}
                                onChange={(e) => updateFilter(column, { ...filter, max: e.target.value, type: 'range', enabled: true })}
                                className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                    )}
                    {type === 'text' && (
                        <input type="text" placeholder={`Search ${label.toLowerCase()}...`} value={filter.value || ''}
                            onChange={(e) => updateFilter(column, { ...filter, value: e.target.value, type: 'text', enabled: true })}
                            className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EtoroTracker />);
        }

        // Wait for all libraries to load
        window.addEventListener('load', () => {
            setTimeout(initApp, 500);
        });
    </script>
</body>
</html>
